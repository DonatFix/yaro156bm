$('.js-template').each(function() {
    var $template = $(this);
    var $desktopTemplate = $template.find('.js-template-desktop');
    var $mobileTemplate = $template.find('.js-template-mobile');
    var content = (zilvercms.viewport.isEqualOrSmallerThan('md')) ? $mobileTemplate.html() : $desktopTemplate.html();

    $template.replaceWith(content);
});

$.each(zilvercms.variables.sizes, function(index, size) {
    if(zilvercms.viewport.is() === size) {
        $('.js-template-'+size).each(function() {
            var $template = $(this);
            var content = $template.html();
            $template.replaceWith(content);
        });
    }
});

$(document).ready(function() {
    $('.js-address-autofill-invoice, .js-address-autofill-shipping').each(function() {
        var $input = $(this);

        if($input.hasClass('js-address-autofill-shipping')) {
            var type = 'shipping';
        } else {
            var type = 'invoice';
        }

        if($input.hasClass('js-address-zipcode') || $input.hasClass('js-address-streetnr')) {
            $input.on('change.autofillAddress', function() {
                var $zipcode = $('.js-address-autofill-'+type+'.js-address-zipcode');
                var $streetnr = $('.js-address-autofill-'+type+'.js-address-streetnr');
                var $street = $('.js-address-autofill-'+type+'.js-address-street');
                var $place = $('.js-address-autofill-'+type+'.js-address-place');

                var zipcode = $zipcode.val().split(' ').join('');
                var streetnr = $streetnr.val();

                $zipcode.parent().removeAttr('data-warning');
                $streetnr.parent().removeAttr('data-warning');

                if(zipcode.match(/^[1-9][0-9]{3}[\ ]*[A-z]{2}$/i) && streetnr != '') {
                    $.ajax({
                        dataType: 'json',
                        url: '/bjax/webshop/postcodefill/',
                        data: {
                            postcode: zipcode,
                            huisnr: streetnr
                        },
                        success: function(result) {
                            if(result) {
                                if($street.val() == '') {
                                    $street.val(result.street).valid();
                                }
                                if($place.val() == '') {
                                    $place.val(result.city).valid();
                                }
                                window.validZipcode = true;
                            }
                        },
                        error: function() {
                            $zipcode.parent().attr('data-warning', 'Wij vonden geen geldige combinatie van postcode en huisnummer, controleer of deze goed zijn ingevuld.');
                            $streetnr.parent().attr('data-warning', ' ');
                            window.validZipcode = false;
                        }
                    });
                }
            });
        }
    });
});

$(document).ready(function() {
    $('.js-area').each(function() {
        var $area = $(this);
        var $paginationParent = $area.parents('.js-pagination');
        var contentHeight = $area.outerHeight();

        if(contentHeight > 180) {
            var $more = $('<a/>', {
                class: 'area--readmore'
            }).text('Lees meer').on('click', function() {
                $more.hide();
                $area.removeClass('area--max-height');

                if($paginationParent.length) {
                    $paginationParent.find('.slick-list').css('height', $area.parents('.slick-slide').outerHeight());
                }
            });
            $area.append($more).addClass('area--max-height');
        }
    });
});

$(document).ready(function() {
    $('.js-cart').each(function() {
        var $cart = $(this);
        var _timeout;
        var pageTitle = $('title').text();
        var _pageTitleTimeout;

        setSelect2();

        $cart.on('click.updateAmount', '.js-plus-btn, .js-minus-btn', function() {
            var $btn = $(this);
            var $input = $btn.siblings('input');
            var value = parseInt($input.val());
            var step = parseInt($input.attr('step'));
            var update = true;
            if($btn.hasClass('js-plus-btn')) {
                if($input.attr('max') && value >= parseInt($input.attr('max'))) {
                    var $warning = $input.parent().siblings('.js-stock-warning');
                    $warning.fadeIn();

                    setTimeout(function() {
                        $warning.fadeOut();
                    }, 2500);

                    update = false;
                } else {
                    clearTimeout(_timeout);
                    value = (value + step);
                }
            } else {
                clearTimeout(_timeout);
                if(value > 1) {
                    value = (value - step);
                }
            }
            $input.val(value);

            if(update) {
                _timeout = setTimeout(function() {
                    updateCart($cart);
                    _timeout = null;
                }, 500);
            }
        });

        $cart.on('blur.updateAmount', '.js-cart-amount', function() {
            var $input = $(this);
            var value = parseInt($input.val());
            var step = parseInt($input.attr('step'));
            if(step > 1 && !(Math.round(value/step) === (value/step))) {
                var next = Math.ceil(value/step) * step;
                $input.val(next);
            }
            if($input.attr('max') && value > parseInt($input.attr('max'))) {
                $input.val($input.attr('max'));
            }
            updateCart($cart);
        });

        $cart.on('change.updateShippingMethod', '.js-shippingmethod', function(e) {
            updateCart($cart);
        });

        $cart.on('click.removeAmount', '.js-cart-delete', function() {
            var $remove = $(this);
            var $amount = $remove.parent().find('.js-cart-amount');
            $amount.val(0);
            updateCart($cart);
        });

        $cart.on('change.updateShippingMethodCountry', '.js-shippingmethod-country', function() {
            var $select = $(this);
            var $option = $select.parents('label').prev('input');
            $option.val($select.val()).prop('checked', true);
            updateCart($cart);
        });

        $cart.on('click.openSelect2', '.select2', function(e) {
            e.preventDefault();
        });

        // Discount code
        $cart.on('click.showDiscountField', '.js-discount-trigger', function() {
            var $trigger = $(this);
            var $discount = $cart.find('.js-discount');

            $discount.fadeIn();
            $trigger.hide();
        });

        $cart.on('keyup.updateCode', '.js-discountcode', function(e) {
            var $code = $(this);
            var currentCode = $code.data('code');
            var currentValue = $code.val();

            $cart.find('.js-activate-discountcode').toggleClass('hide', (currentCode == currentValue));
            $cart.find('.js-discount').removeClass('invalid');
        });

        $cart.on('keydown.updateCode', '.js-discountcode', function(e) {
            if(e.which == 13) {
                checkDiscountCode($cart);
                return false;
            }
        });

        $cart.on('click.activateCode', '.js-activate-discountcode', function(e) {
            e.preventDefault();
            checkDiscountCode($cart);
        });

        $cart.on('submit.sendCart', function() {
            $cart.addClass('loading');
            $('html').addClass('loading');
        });

        $(window).on('focus', function() {
            clearTimeout(_pageTitleTimeout);
            $('title').html(pageTitle);
        }).on('blur', function() {
            _pageTitleTimeout = setTimeout(function() {
                $('title').html('&#128276; (1) ' + zilvercms.translationHelper('webshop.checkout.dont_forget_your_order'));
            }, 2000);
        });
    });

    function updateCart($cart) {
        var $form = $cart.find('.js-cart-form');
        var $command = $form.find('.js-cart-command');
        $command.val('updatecart');
        var formData = $form.serialize();

        $cart.addClass('loading');
        $('html').addClass('loading');

        $.ajax({
            url: '/cart',
            method: 'POST',
            data: formData,
            success: function(result) {
                var $html = $(result);
                if($html.filter('.js-cart').length) {
                    var cart = $html.filter('.js-cart').html();
                    $cart.html(cart).removeClass('loading');
                    $('html').removeClass('loading');
                    setSelect2();
                } else {
                    window.location.reload();
                }
            },
            error: function(result) {
                $form.submit();
            }
        });
    }

    function checkDiscountCode($cart) {
        var $discount = $cart.find('.js-discount');
        var $discountInput = $cart.find('.js-discountcode');
        var $discountBtn = $cart.find('.js-activate-discountcode');
        var discountCode = $discountInput.val();
        var discountCodeOld = $discountInput.data('code');
        var discountBtnText = $discountBtn.text();

        if(discountCodeOld && discountCode == '') {
            updateCart($cart);
            return;
        }

        $discount.removeClass('invalid');
        $discountBtn.text($discountBtn.data('loading-text'));

        $.ajax('/bjax/webshop/Adddiscountcode', {
            type: 'POST',
            data: {
                discountcode: discountCode,
                keepExisting: true
            },
            success: function() {
                updateCart($cart);
            },
            error: function() {
                $discount.addClass('invalid');
                $discountBtn.text(discountBtnText);
            }
        });
    }

    function setSelect2() {
        $('.js-shippingmethod-country').each(function() {
            var $select = $(this);

            $select.select2({
                allowHtml: true,
                minimumResultsForSearch: -1,
                sorter: function(data) {
                    return data.sort(function(a, b) {
                        return (a.text.toLowerCase() > b.text.toLowerCase()) ? 0 : -1;
                    });
                },
                theme: 'flat',
                templateResult: function(data) {
                    var price = $(data.element).data('price');
                    var $price;

                    if(price) {
                        $price = $('<div/>', {class: 'select2__price'}).html(price);
                    }

                    return $('<div/>', {
                        class: 'd-flex align-items-center'
                    }).html(data.text).append($price);
                },
                templateSelection: function(data) {
                    return $('<div/>', {
                        class: 'd-flex align-items-center'
                    }).html(data.text);
                }
            });
        });
    }
});

$(document).ready(function() {
    $('.js-address-street').each(function() {
        var $street = $(this);

        $street.on('change.updateStreet', function() {
            validateStreet($street);
        });
    });

    $('.js-address-place').each(function() {
        var $place = $(this);

        $place.on('change.updatePlace', function() {
            validatePlace($place);
        });
    });

    $('.js-checkout').each(function() {
        var $form = $(this);
        var $warning = $form.find('.js-checkout-warning');
        var pageTitle = $('title').text();
        var _pageTitleTimeout;

        $form.on('submit.checkoutWarnings', function(event) {
            var $street1ok = validateStreet($('.js-address-street.js-address-autofill-invoice'));
            var $street2ok = validateStreet($('.js-address-street.js-address-autofill-shipping'));
            var $place1ok = validatePlace($('.js-address-place.js-address-autofill-invoice'));
            var $place2ok = validatePlace($('.js-address-place.js-address-autofill-shipping'));

            if(window.validZipcode == false || !$street1ok || !$street2ok || !$place1ok || !$place2ok) {
                $warning.removeClass('d-none');
                $form.removeClass('loading');
                $('html').removeClass('loading');
                $form.off('submit.checkoutWarnings').on('submit.checkoutWarningsIgnore', function(event) {
                    $warning.addClass('d-none');
                    if($form.valid()) {
                        handleSubmit($form, event);
                        $('html').addClass('loading');
                    }
                });

                return false;
            } else if($form.valid()) {
                handleSubmit($form, event);
                $('html').addClass('loading');
            }
        });

        $(window).on('focus', function() {
            clearTimeout(_pageTitleTimeout);
            $('title').html(pageTitle);
        }).on('blur', function() {
            _pageTitleTimeout = setTimeout(function() {
                $('title').html('&#128276; (1) ' + zilvercms.translationHelper('webshop.checkout.dont_forget_your_order'));
            }, 2000);
        });
    });

    $('.js-checkout-payment-option').each(function() {
        var $option = $(this);
        var safetyMessage = $option.data('safety-message');
        var safetyModal = $option.data('safety-modal');
        var $safetyMessage = $('.js-checkout-safety');
        var $safetyModalMessage = $('.js-checkout-safety-modal-message');

        $option.on('change', function() {
            if(this.checked) {
                if(safetyMessage && safetyModal) {
                    $safetyMessage.text(safetyMessage);
                    $safetyModalMessage.text(safetyModal);
                    $safetyMessage.slideDown();
                } else {
                    $safetyMessage.text('');
                    $safetyModalMessage.text('');
                    $safetyMessage.slideUp();
                }
            }
        });

        if(this.checked) {
            $option.trigger('change');
        }
    });

    function handleSubmit($form, formEvent) {
        // Remove name attr from hidden issuers selectboxes and add to first visible one.
        $form.find('.js-checkout-issuer:hidden').removeAttr('name');
        $form.find('.js-checkout-issuer:visible').first().attr('name', 'data[payment][issuer]');

        // Add safety message to loading screen.
        var $safety = $('.js-checkout-safety');
        var $safetyModal = $('.js-checkout-safety-modal');

        if($safety.is(':visible')) {
            formEvent.preventDefault();
            $safetyModal.show();

            setTimeout(function() {
                $form.off('submit').submit();
            }, 3000);

            return false;
        }
    }

    var validateStreet = function($street) {
        var street = $street.val();
        $street.parent().removeAttr('data-warning');

        if(typeof street != 'undefined' && street != '') {
            if($street.hasClass('js-address-autofill-invoice')) {
                var $houseNr = $('.js-address-streetnr.js-address-autofill-invoice');
                var $houseNrAddition = $('input[name="data[invoice][streetnr_addition]"]');
            } else {
                var $houseNr = $('.js-address-streetnr.js-address-autofill-shipping');
                var $houseNrAddition = $('input[name="data[shipping][streetnr_addition]"]');
            }

            var houseNr = $houseNr.val();
            var houseNrAddition = $houseNrAddition.val();
            var regex1 = new RegExp(houseNr + '$');
            var regex2 = new RegExp(houseNr + houseNrAddition + '$');
            var regex3 = new RegExp(houseNr + ' ' + houseNrAddition + '$');

            if(houseNr != '' && (regex1.test(street) || regex2.test(street) || regex3.test(street))) {
                $street.parent().attr('data-warning', zilvercms.translationHelper('webshop.checkout.warning_street_end_housenr'));
                return false;
            }
        }

        return true;
    }

    var validatePlace = function($place) {
        var place = $place.val();
        $place.parent().removeAttr('data-warning');

        if(typeof place != 'undefined' && place != '') {
            if($place.hasClass('js-address-autofill-invoice')) {
                var $country = $('input[name="data[invoice][country]"]');
            } else {
                var $country = $('input[name="data[shipping][country]"]');
            }

            var country = $country.val();

            if(country == 'nl') {
                var provinces = [
                    'DR', // Drenthe
                    'FL', // Flevoland
                    'FR', // Friesland
                    'GD', // Gelderland
                    'GE', // Gelderland - alt
                    'GLD', // Gelderland - alt
                    'GR', // Groningen
                    'LB', // Limburg
                    'LI', // Limburg - alt
                    'NB', // Noord-Brabant
                    'NH', // Noord-Holland
                    'OV', // Overijssel
                    'UT', // Utrecht
                    'ZH', // Zuid-Holland
                    'ZL' // Zeeland
                ];

                for(var i = 0; i < provinces.length; i++) {
                    var province = provinces[i];
                    var regex1 = new RegExp(' '+province + '$');
                    var regex2 = new RegExp(' '+province.toLowerCase() + '$');

                    if(regex1.test(place) || regex2.test(place)) {
                        $place.parent().attr('data-warning', zilvercms.translationHelper('webshop.checkout.warning_province_in_place', {'%province%': province}));
                        return false;
                    }
                }
            }
        }

        return true;
    }

    $('.js-klarna-terms').each(function() {
        var lang = $('html').attr('lang');
        var language = lang.toLowerCase();
        var language = (language === 'be') ? 'nl' : language;
        var country = lang.toUpperCase();

        if(zilvercms.viewport.isGreaterThan('sm')) {
            type = 'desktop';
        }else{
            type = 'mobile';
        }

        new Klarna.Terms.Invoice({
            el: 'kalarnaTerms',
            eid: 'M-2099-2620',
            locale: language+'_'+country,
            charge: 0,
            type: type,
            linkText: (language === 'de') ? 'Rechnungsbedingungen' : 'Factuurvoorwaarden' //TODO move to translations
        });
    });

    $('.js-checkout-applepay').each(function() {
        var $method = $(this);
        if(!!window.ApplePaySession && window.ApplePaySession.canMakePayments()) {
            $method.prop('checked', true);
            $method.next().removeClass('d-none');
        }
    });
});

$(document).ready(function() {
    $('.js-combinations').each(function() {
        var $combinations = $(this);

        $combinations.on('init', function(event, slick) {

        }).on('afterChange', function(event, slick, currentSlide) {
            $combinations.removeClass('first last');

            if(slick.currentSlide === (slick.slideCount - 2)) {
                $combinations.addClass('last');
            } else if (slick.currentSlide === 0) {
                $combinations.addClass('first');
            }
        });

        $combinations.slick({
            arrows: true,
            dots: false,
            infinite: false,
            nextArrow: $combinations.next('.js-combinations-navigation').find('.js-combinations-next'),
            prevArrow: $combinations.next('.js-combinations-navigation').find('.js-combinations-prev'),
            swipe: zilvercms.viewport.isEqualOrSmallerThan('md'),
            slidesToShow: 2,
        });
    });
});

$(document).ready(function() {
    $('.js-cookie-consent').each(function() {
        var $element = $(this),
            data = $element.data('cc');

        window.cookieconsent.initialise({
            'position': data.position,
            'content': {
                'message': data.message,
                'dismiss': data.buttonText,
                'link': data.moreText,
                'href': data.moreLink
            }
        });

        $element.remove();
    });
});
$(document).ready(function() {
    $('.js-countdown').each(function() {
        var countdown;
        var $countdown = $(this);
        var now = $countdown.data('countdown-now');
        var to = $countdown.data('countdown-to');

        countdown = setInterval(function () {
            var distance = parseInt(to) - parseInt(now);
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            $countdown.text(hours + ':' + minutes + ':' + seconds);

            if (distance < 0) {
                clearInterval(countdown);
                $countdown.text('');
            }
        }, 1000);
    });
});

$(document).ready(function() {
    $('.js-faq').each(function() {
        var $faq = $(this),
            $categories = $faq.find('.js-faq-category');

        $categories.first().addClass('open').next().slideDown();
        //$categories.first().parent().find('.js-faq-question').first().addClass('open').next().slideDown();

        $categories.each(function() {
            var $category = $(this),
                $parent = $category.parent(),
                $questions = $parent.find('.js-faq-question');

            $category.on('click', function() {
                if($category.hasClass('open')) {
                    $category.removeClass('open').next().slideUp();
                    $questions.removeClass('open').next().slideUp();
                } else {
                    $categories.not($category).removeClass('open').next().slideUp();
                    $category.addClass('open').next().slideDown();
                }
            });

            $questions.each(function() {
                var $question = $(this);

                $question.on('click', function() {
                    if($question.hasClass('open')) {
                        $question.removeClass('open').next().slideUp();
                    } else {
                        $questions.not($question).removeClass('open').next().slideUp();
                        $question.addClass('open').next().slideDown();
                    }
                });
            });
        });
    });
});

$(document).ready(function() {
    var countryCode = zilvercms.getCookie('countryCode');

    if(countryCode === '') {
        $.getJSON('https://get.geojs.io/v1/ip/geo.json', function(location) {
            try {
                countryCode = location.country_code;
                zilvercms.setCookie('countryCode', countryCode, 1);
                geoReady(countryCode);
            } catch(error) {}
        });
    } else {
        geoReady(countryCode);
    }

    function geoReady(countryCode) {
        languageSwitch(countryCode, document.documentElement.lang);

        // Add promobar on visitors from Austria
        if(document.documentElement.lang === 'de' && countryCode === 'AT') {
            $('.js-dynamic-promobar').each(function() {
                var $flag = $('<img/>').attr({
                    'class': 'mr-2',
                    'src': '/templates/cookinglife/images/de/flag_au.png',
                    'height': '16px'
                });
                var freeShippingPrice = zilvercms.getMetaValue('freeShippingPrice');
                if(freeShippingPrice !== '') {
                    var $promobar = $('<div/>').addClass('promobar default text-center').html('Ab '+zilvercms.currencyHelper(freeShippingPrice)+' Bestellwert gratis Versand in Ã–sterreich!');
                    $promobar.prepend($flag);
                    $(this).replaceWith($promobar);
                }
            });
        } else if(document.documentElement.lang === 'en' &&
                typeof SUPPORTEDCOUNTRIES === 'object' &&
                typeof SUPPORTEDCOUNTRIES[countryCode] === 'string') {
            $('.js-dynamic-promobar').each(function() {
                var $flag = $('<img/>').attr({
                    'class': 'mr-2',
                    'src': 'https://60cafc33af40b8287ffb-1a032c1af87160c7fc01b9de8fd3221e.ssl.cf3.rackcdn.com/flags/'+countryCode.toLowerCase()+'.png',
                    'height': '16px'
                }).css('vertical-align', '-2px');
                var countryName = SUPPORTEDCOUNTRIES[countryCode];
                var $promobar = $('<div/>').addClass('promobar default text-center').html('Welcome, we are happy to deliver your order to ' + countryName);
                $promobar.prepend($flag);
                $(this).replaceWith($promobar);
            });
        }
    }

    function languageSwitch(countryCode, siteLanguage) {
        var button = 'Doorgaan';
        var content = '';
        var flag = '';
        var link = '';

        if((countryCode === 'DE' || countryCode === 'AT') && siteLanguage !== 'de') {
            button = 'Weiter gehen';
            content =  'Um Ihnen so behilfreich m&ouml;glich zu sein, empfehlen wir ihnen weiter zu shoppen in unseren <a href="https://cookinglife.de" class="link inverted underlined">Deutschen Online shop</a>.';
            flag = 'de';
            link = 'https://cookinglife.de';
        } else if (countryCode === 'BE' && siteLanguage !== 'be') {
            content = 'Om u zo goed mogelijk van dienst te zijn, adviseren wij u om verder te shoppen in onze <a href="https://cookinglife.be" class="link inverted underlined">Belgische winkel</a>.';
            flag = 'be';
            link = 'https://cookinglife.be';
        } else if (countryCode === 'NL' && siteLanguage !== 'nl') {
            content = 'Om u zo goed mogelijk van dienst te zijn, adviseren wij u om verder te shoppen in onze <a href="https://cookinglife.nl" class="link inverted underlined">Nederlandse winkel</a>.';
            flag = 'nl';
            link = 'https://cookinglife.nl';
        } else if (typeof SUPPORTEDCOUNTRIES[countryCode] === 'undefined' && siteLanguage !== 'en') {
            button = 'Continue';
            content = 'In order to provide you with the best possible service, we advise you to continue shopping in our <a href="https://cookinglife.eu" class="link inverted underlined">international store</a>.';
            flag = 'europeanunion';
            link = 'https://cookinglife.eu';
        }

        if(content !== '' && zilvercms.getCookie('languageswitch') === '') {
            $('.js-languageswitch').each(function() {
                var $switch = $(this);
                var $button = $switch.find('.js-languageswitch-button');
                var $close = $switch.find('.js-languageswitch-close');
                var $content = $switch.find('.js-languageswitch-content');
                var $flag = $switch.find('.js-languageswitch-flag');

                $button.attr('href', link).text(button);
                $content.html(content);
                $flag.attr('src', 'https://60cafc33af40b8287ffb-1a032c1af87160c7fc01b9de8fd3221e.ssl.cf3.rackcdn.com/flags/'+flag+'.png');

                $switch.slideDown();

                $close.on('click', function() {
                    $switch.slideUp();
                    return false;
                });

                zilvercms.setCookie('languageswitch', true, 30);
            });
        }
    }
});

$(document).ready(function() {
    $('.js-lazy-img').each(function() {
        var $wrapper = $(this);
        var $image = $wrapper.find('img');
        var image = $image.data('src');
        var height = $wrapper.outerHeight();
        var width = $wrapper.outerWidth();
        var pixelRatio = (window.devicePixelRatio > 1) ? 2 : 1;
        var options = (Math.ceil(width) * pixelRatio + 'x' + Math.ceil(height) * pixelRatio);
        $image.attr('src', zilvercms.imageHelper(image, options));
    });
});

$(document).ready(function() {
    $('.js-mainmenu-toggle').each(function() {
        var $toggle = $(this);
        var $body = $('html');
        var className = 'mainmenu-open';

        $toggle.on('click.mainmenu', function() {
            if($body.hasClass(className)) {
                $body.removeClass(className);
                zilvercms.unlockBody();
            } else {
                $body.addClass(className);
                zilvercms.lockBody();
            }

            return false;
        });
    });
});

$(document).ready(function() {
    $('.js-microcart').each(function() {
        var $cart = $(this),
            $toggle = $('.js-microcart-toggle'),
            $close = $('.js-microcart-close'),
            $loading = $('.js-microcart-loading'),
            $products = $('.js-microcart-products');

        $close.on('click', function(){
            $toggle.trigger('click');
        });

        window.updateMicrocart = function() {

            $loading.addClass('loading-icon');

            // Current product properties, if any
            var $productForm = $('.product-form');
            if($productForm) {
                var currentProductId = parseInt($productForm.find('input[name="productkey"]').val());
                var currentProductMaxCount = $productForm.find('.js-product-count').data('max');
            }

            $.getJSON('/bjax/webshop/Getobjectasjson/cart/', function(data) {
                if(data.itemcount > 0) {
                    $cart.removeClass('microcart--empty');

                    var itemcount = data.itemcount;

                    if(itemcount > 4){
                        itemcount = 4;
                    }
                    $toggle.data('amount', data.itemcount);
                    $('.js-microcart-items-shown').text(itemcount);
                    $('.js-microcart-items-total').text(data.itemcount);
                    $('.js-microcart-subtotal').html(zilvercms.currencyHelper(data.subtotal));
                    if (data.shipping === 0) {
                        $('.js-microcart-shipping').addClass('text-success').text(function() {
                            return $(this).data('translation');
                        });
                    } else {
                        $('.js-microcart-shipping').html(zilvercms.currencyHelper(data.shipping));
                    }
                    $('.js-microcart-total').html(zilvercms.currencyHelper(data.total));

                    $products.empty();

                    for(var i = 0; i < data.items.length; i++) {
                        var itemId = data.items[i].product_id;

                        if(typeof currentProductId !== 'undefined' && currentProductId === itemId) {
                            var itemCount = parseInt(data.items[i].count);
                            if(itemCount >= currentProductMaxCount) {
                                $productForm.find('.js-product-count').val(0).attr({
                                    'data-min': 0,
                                    'data-max': 0
                                });
                                $productForm.find('button[type="submit"]').attr('disabled', 'disabled');
                            } else {
                                $productForm.find('.js-product-count').attr('data-max', (currentProductMaxCount - itemCount));
                            }
                        }

                        if(i < 4) {
                            $products.append('<a href="'+data.items[i].product_url+'"><img src="'+zilvercms.imageHelper(data.items[i].image_url, '100x100,fit')+'" alt="'+data.items[i].name+'"><strong>'+data.items[i].count+'x &nbsp;|&nbsp;'+zilvercms.currencyHelper(data.items[i].current_price)+'</strong></a>');
                        }
                    }
                    $cart.removeClass('microcart--empty');
                } else {
                    $cart.addClass('microcart--empty');
                }

                $('.js-microcart-toggle-count').text(data.itemcount);
                $('.js-microcart-toggle-products').html(zilvercms.currencyHelper(data.total));

                $loading.removeClass('loading-icon');
            });
        };
    });
});

$('.js-modal').each(function() {
    var $trigger = $(this);

    $trigger.on('click', function(e) {
        e.preventDefault();

        var modal = $trigger.data('modal');
        var $modal = $(modal);

        if($modal.is('template')) {
            var identifier = $modal.attr('id');
            var template = $modal.html();
            var $template = $(template);
            $template.attr('id', identifier).appendTo('body').modal('show');
            $modal.remove();

            $template.find('form.js-validation').each(function() {
                $.validator.formValidation(this);
            });
        } else {
            $modal.modal('show');
        }
    });
});

$(document).ready(function() {
    $('.js-order').each(function() {
        var $order = $(this);
        var $select = $order.find('.js-order-select');
        var $selectWrapper = $select.parent();
        var $input = $order.find('.js-order-input');
        var $button = $order.find('.js-order-button');
        var fieldName = $select.attr('name');
        var ajaxSubmit = $order.data('ajax-submit');
        var $addToCart = $('.js-add-to-cart');

        $select.on('change', function() {
            if($select.val() === 'more') {
                $selectWrapper.hide()
                $select.removeAttr('name');
                $input.removeClass('d-none').show().attr('name', fieldName).on('blur', function() {
                    if($input.val() === '') {
                        $selectWrapper.show();
                        $select.attr('name', fieldName);
                        $select.find('option').first().prop('selected', true);
                        $input.hide().removeAttr('name');
                        $order.removeAttr('data-error');
                        $order.parents('.productblock').removeAttr('data-error');
                    }
                });

                if(!/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    $input.focus();
                }
            }
        });

        $order.on('submit', function(event) {
            // Extra check if validation is active
            if(!$order.valid()) {
                return false;
            }

            var $microcart = $('.js-microcart-toggle:visible');
            $button.addClass('loading');

            if(!!ajaxSubmit) {
                event.preventDefault();

                var count = $order.find('*[name="count"]').val();
                var pid = $order.find('*[name="productkey"]').val();


                $.ajax({
                    type: 'POST',
                    url: '/cart?ajax=true&pid=' + pid + '&qtn=' + count,
                    dataType: 'json',
                    data: $order.serialize(),
                    complete: function(response) {
                        $button.removeClass('loading');

                        window.updateMicrocart();
                        $('.js-microcart').removeClass('microcart--empty');

                        if(ajaxSubmit === 'small') {
                            $button.addClass('checkmark');

                            if(!$('body').hasClass('modal-open')) {
                                $microcart.addClass('open');
                            }

                            setTimeout(function() {
                                $button.removeClass('checkmark');
                            }, 5000);
                        } else {
                            if($addToCart.length) {
                                if(count > 1) {
                                    var $addToCartCount = $addToCart.find('.js-add-to-cart-count');
                                    var $addToCartPrice = $addToCart.find('.js-add-to-cart-price');
                                    var plainSinglePrice = $addToCartPrice.data('plain-price');

                                    $addToCartCount.text(count);
                                    $addToCartPrice.html(zilvercms.currencyHelper(plainSinglePrice * count));
                                }

                                if(response.responseText.trim().length > 0) {
                                    $addToCart.find('.js-order-info').html(response.responseText.trim());
                                }

                                $('.js-add-to-cart-trigger').click();
                            } else {
                                $microcart.addClass('open');
                            }
                        }

                        if(typeof window.productDetails === 'object' && typeof window.dataLayer === 'object') {
                            productDetails.quantity = count;
                            dataLayer.push({
                                event: 'addToCart',
                                ecommerce: {
                                    currencyCode: 'EUR',
                                    add: {
                                        products: [productDetails]
                                    }
                                }
                            });
                        }
                    }
                });

                return false;
            }
        });
    });
});

$(document).ready(function() {
    $('.js-pagination').each(function() {
        var $pagination = $(this);
        
        $pagination.on('init', function(event, slick) {

        }).on('beforeChange', function(event, slick, currentSlide, nextSlide) {
            if(slick.$slider.data('pagination-scroll')) {
                $('html, body').animate({
                    scrollTop: (slick.$slider.parent().offset().top - 100) + 'px'
                });
            }
            $pagination.toggleClass('last', ((slick.slideCount - 1) === nextSlide));
        }).on('afterChange', function(event, slick, currentSlide) {
            $pagination.next('.js-pagination-navigation').find('.js-pagination-prev').toggleClass('disabled', (slick.currentSlide === 0));
            $pagination.next('.js-pagination-navigation').find('.js-pagination-next').toggleClass('disabled', ((slick.currentSlide + 1) === slick.slideCount));
        });

        $pagination.slick({
            adaptiveHeight: true,
            appendDots: $pagination.next('.js-pagination-navigation').find('.js-pagination-dots'),
            arrows: true,
            dots: true,
            dotsClass: 'pagination__numbers',
            infinite: false,
            nextArrow: $pagination.next('.js-pagination-navigation').find('.js-pagination-next'),
            prevArrow: $pagination.next('.js-pagination-navigation').find('.js-pagination-prev'),
            swipe: zilvercms.viewport.isEqualOrSmallerThan('md'),
            variableWidth: $pagination.data('pagination-variable-width')
        });
    });
});

$(document).ready(function() {
    var $pickupLocation = $('.js-pickup-location');
    var $timeframe = $('.js-timeframe');

    var recievePickupLocations = function(zipcode) {
        if(/^[1-9][0-9]{3}\s?[a-zA-Z]{2}$/.test(zipcode)) {
            var $select = $('.js-pickup-location-select');
            $select.parent().addClass('loading');
            $('.js-pickup-location-select-label').text('Afhaalpunten ophalen...');
            $pickupLocation.parent().removeAttr('data-error');

            $.ajax({
                dataType: 'json',
                method: 'POST',
                url: '/bjax/postnl/getNearestLocations/',
                data: {
                    zipcode: zipcode,
                    countryCode: 'NL',
                    shippingMethodId: $('.js-checkout').data('shippingmethod-id')
                },
                success: function (json) {
                    $select.off('change.selectPickupPoint');
                    $select.empty();

                    if($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('destroy');
                    }

                    $.each(json.locations, function(i) {
                        var distance = parseInt(this.distance);
                        if(distance < 1000) {
                            var distanceText = '< 1 km';
                        } else {
                            var distanceRounded = Math.round(distance/100)/10;
                            var distanceText = distanceRounded.toString().replace('.', ',') + ' km';
                        }

                        var $option = $('<option/>');
                        $option.val(this.name);
                        $option.text([
                            this.name + ',',
                            this.address.street,
                            this.address.houseNr,
                            this.address.city,
                            '(' + distanceText + ')'
                        ].join(' '));

                        $option.attr('data-location-name', this.name);
                        $option.attr('data-location-street', this.address.street);
                        $option.attr('data-location-streetnr', this.address.houseNr);
                        $option.attr('data-location-zipcode', this.address.zipcode);
                        $option.attr('data-location-city', this.address.city);
                        $option.attr('data-location-country', this.address.countryCode);
                        $option.attr('data-location-distance', distanceText);
                        $option.attr('data-location-label', [
                            this.name + '<br>',
                            this.address.street,
                            this.address.houseNr + ',',
                            this.address.city
                        ].join(' '));

                        $select.append($option).valid();
                    });

                    $select.on('change.selectPickupPoint', function() {
                        var $selected = $select.find('option:selected');

                        $('.js-pickup-location-street').val($selected.attr('data-location-street'));
                        $('.js-pickup-location-streetnr').val($selected.attr('data-location-streetnr'));
                        $('.js-pickup-location-zipcode').val($selected.attr('data-location-zipcode'));
                        $('.js-pickup-location-city').val($selected.attr('data-location-city'));
                        $('.js-pickup-location-country').val($selected.attr('data-location-country'));
                        $('.js-summary-pickup').html($selected.attr('data-location-label')).parent('tr').fadeIn();
                    });

                    $select.trigger('change');
                    $select.parent().removeClass('loading');
                    $('.js-pickup-location-select-label').text('Selecteer afhaalpunt');

                    if(zilvercms.viewport.isGreaterThan('xs')) {
                        $select.select2({
                            allowHtml: true,
                            theme: 'flat',
                            templateResult: function(data) {
                                var $option = $(data.element);
                                var name = data.id;
                                var street = $option.data('location-street');
                                var streetnr = $option.data('location-streetnr');
                                var city = $option.data('location-city');
                                var distance = $option.data('location-distance');

                                var newOption = [
                                    '<div>',
                                        name,
                                        '<div class="float-right">',
                                            distance,
                                        '</div>',
                                        '<div class="text small muted">',
                                            street + ' ' + streetnr + ', ' + city,
                                        '</div>',
                                    '</div>'
                                ];
                                return $(newOption.join(''));
                            },
                            templateSelection: function(data) {
                                var $option = $(data.element);
                                var name = data.id;
                                var street = $option.data('location-street');
                                var streetnr = $option.data('location-streetnr');
                                var city = $option.data('location-city');

                                var newOption = [
                                    '<div>',
                                        name,
                                        '<span class="text muted ml-3">',
                                            street + ' ' + streetnr + ', ' + city,
                                        '</span>',
                                    '</div>'
                                ];
                                return $(newOption.join(''));
                            }
                        });
                    }
                },
                error: function(XMLHttpRequest) {
                    $pickupLocation.parent().attr('data-error', 'Kon geen beschikbare afhaalpunten vinden, gebruik een andere postcode.');
                    $('.js-pickup-location-select-label').text('Selecteer afhaalpunt');
                }
            });
        } else {
            $('.js-pickup-location').parent().
                removeAttr('data-success').
                attr('data-error', 'Vul een geldige postcode in, bijv: 1234AB');
        }
    }

    var resetTimeframes = function() {
        var $selectDate = $('.js-timeframe');
        var $selectOption = $('.js-timeframe-options');
        var $summaryDate = $('.js-summary-timeframe-date');
        var $summaryOption = $('.js-summary-timeframe-option');
        var $emptyOption = $('<option/>').text('Kies eerst een bezorgdatum').val('');

        $selectDate.removeAttr('name');

        $selectOption.html($emptyOption).removeAttr('name');
        $selectOption.parent().addClass('loading');

        $summaryDate.parents('tr').fadeOut();
        $summaryOption.parents('tr').fadeOut();
        $summaryDate.empty();
        $summaryOption.empty();

        updateSummaryPrice('shippingcost', 0);
        updateSummaryPrice('price', 0);
    }

    var recieveTimeframes = function() {
        var zipcode = $('.js-address-zipcode:visible').last().val();
        var streetnr = $('.js-address-streetnr:visible').last().val();

        if(zipcode != '' && /^[1-9][0-9]{3}\s?[a-zA-Z]{2}$/.test(zipcode) && streetnr != '') {
            var $selectDate = $('.js-timeframe');
            var $selectOption = $('.js-timeframe-options');
            var $summaryDate = $('.js-summary-timeframe-date');
            var $summaryOption = $('.js-summary-timeframe-option');

            $.ajax({
                dataType: 'json',
                method: 'POST',
                url: '/bjax/postnl/GetAvailableTimeFrames/',
                data: {
                    zipcode: zipcode,
                    houseNumber: streetnr,
                    countryCode: 'NL',
                    shippingMethodId: 1
                },
                success: function (json) {
                    var timeframes = json.available_times.timeFrames;
                    var dateOptions = {};

                    $selectDate.val('').find('.js-timeframe-day').remove();
                    resetTimeframes();

                    if(timeframes.length) {
                        $.each(timeframes, function(i) {
                            var date = this.date;
                            var options = this.options;

                            if(options.length) {
                                if(!dateOptions[date]) {
                                    dateOptions[date] = [];

                                    var $option = $('<option/>');
                                    $option.val(this.date);
                                    $option.text([
                                        this.dateDay,
                                        this.dateNoYear,
                                    ].join(' ')).addClass('js-timeframe-day');

                                    $selectDate.append($option);
                                }

                                dateOptions[date].push(options[0]);
                            }
                        });

                        $selectDate.parent().removeClass('loading');

                        $selectDate.on('change.selectDate', function() {
                            if($selectDate.val() == '') {
                                resetTimeframes();
                            } else {
                                $selectDate.attr('name', 'data[timeframe][preferred_shipping_date]');
                                $selectOption.attr('name', 'data[timeframe][option]').empty();
                                $summaryDate.text($selectDate.find('option:selected').text()).parents('tr').fadeIn();

                                var date = $selectDate.val();
                                var options = dateOptions[date];

                                $.each(options, function(i) {
                                    var $option = $('<option/>');
                                    var label = this.label;

                                    if(this.shipping > 0) {
                                        var price = zilvercms.currencyHelper(this.shipping);
                                        label += ' (+ ' + price + ')';
                                    }

                                    $option.val(this.option).text(label).attr('data-price', this.shipping).addClass('js-timeframe-option');

                                    $selectOption.append($option);

                                    if(i == 0) {
                                        updateSummaryPrice('shippingcost', this.shipping);
                                        updateSummaryPrice('price', this.shipping);
                                    }
                                });

                                $selectOption.parent().removeClass('loading');
                                $selectOption.trigger('change');
                            }
                        });

                        $selectOption.on('change.selectOption', function() {
                            var $selectedOption = $selectOption.find('option:selected');
                            updateSummaryPrice('shippingcost', $selectedOption.data('price'));
                            updateSummaryPrice('price', $selectedOption.data('price'));

                            $summaryOption.text($selectedOption.text()).parents('tr').fadeIn();
                        });
                    }
                },
                error: function(XMLHttpRequest) {
                    var error = XMLHttpRequest.responseJSON;
                }
            });
        }
    }

    var updateSummaryPrice = function(type, addingAmount) {
        if(!type) {
            type = 'price';
        }
        var $price = $('.js-summary-'+type);
        var plainPrice = $price.data('plain-price');
        var updatedPrice = plainPrice + addingAmount;
        $price.text(zilvercms.currencyHelper(updatedPrice));
    }

    if($pickupLocation.length) {
        if($pickupLocation.val() != '') {
            recievePickupLocations($pickupLocation.val());
        }

        $pickupLocation.on('keyup.pickupLocation', function() {
            if($pickupLocation.val() != '') {
                recievePickupLocations($pickupLocation.val());
            }
        });

        $('.js-address-zipcode').each(function() {
            var $zipcode = $(this);

            $zipcode.on('change.pickupLocationAutofill', function() {
                if($pickupLocation.val() == '') {
                    var $shippingZipcode = $('.js-address-zipcode:visible').last();
                    var shippingZipcode = $shippingZipcode.val();
                    $pickupLocation.val(shippingZipcode);
                    recievePickupLocations(shippingZipcode);
                }
            });
        });

        $('.js-pickup-update').each(function() {
            var $button = $(this);

            $button.on('click.pickupLocationUpdate', function(e) {
                var zipcode = $pickupLocation.val();
                recievePickupLocations(zipcode);
            });
        });
    } else if ($timeframe.length) {
        $('.js-address-zipcode, .js-address-streetnr').each(function() {
            $address = $(this);

            recieveTimeframes();

            $address.on('change.timeframeAutofill', function() {
                recieveTimeframes();
            });
        });
    }
});

$(document).ready(function() {
    $('.js-pdp-fixed').each(function() {
        var $fixed = $(this);

        if(zilvercms.viewport.isEqualOrSmallerThan('md')) {
            var $order = $('.js-pdp-order:visible');
            var scrollTop = $order.offset().top + $order.height();

            $(window).on('scroll', function() {
                if($(this).scrollTop() >= scrollTop) {
                    $fixed.addClass('active');
                    $('.js-whatsapp').addClass('higher');
                    $('#live-chat-widget').addClass('hide');
                } else {
                    $fixed.removeClass('active');
                    $('.js-whatsapp').removeClass('higher');
                    $('#live-chat-widget').removeClass('hide');
                }
            });
        }
    });

    $('.js-pdp-pinterest').each(function() {
        var $pinterest = $(this);
        var scrollTop = $pinterest.offset().top;

        $(window).on('scroll.loadPinterest', function() {
            if($(this).scrollTop() >= scrollTop) {
                var $script = $('<script/>', {
                    async: true,
                    src: '//assets.pinterest.com/js/pinit.js',
                })
                $pinterest.append($script);
                $(window).off('scroll.loadPinterest');
            }
        });
    });
});

$(document).ready(function() {
	$('.js-products-filter').on('change', function() {
        var newUrl = $(this).val();

        if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
            $(this).parents('.modal-dialog').addClass('loading-area');
        }

        if(newUrl) window.location = newUrl;
		return false;
	});

    $('.js-products-active-filter').on('click', function() {
        if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
            $(this).parents('.modal-dialog').addClass('loading-area');
        }
	});

    $('.js-promo-youtube').each(function() {
        var $video = $(this);
        var youtubeDiv = $video.find('div');
        var youtubeId = youtubeDiv.attr('id').replace('VIDEO-' ,'');

        $video.on('click.yt', function() {
            if(typeof(YT) !== 'undefined') {
                $video.addClass('playing').off('click.yt');

                var player = new YT.Player(youtubeDiv.attr('id'), {
                    videoId: youtubeId,
                    playerVars: {
                        autoplay: 1,
                        modestbranding: 1,
                        playsinline: 1,
                        rel: 0
                    }
                });

                setTimeout(function() {
                    player.playVideo();
                }, 1000);
            }
        });
    });

    $('.js-products-loadmore').each(function() {
        var $button = $(this);

        $button.on('click', function(e) {
            e.preventDefault();

            var currentPage = $button.data('current-page');
            var nextPage = currentPage + 1;
            var numberOfPages = $button.data('number-pages');

            if(typeof URLSearchParams === 'function') {
                var urlParameters = new URLSearchParams(window.location.search);
                urlParameters.set('page', nextPage);
            } else {
                var urlParameters = ('page=' + nextPage);
            }

            $button.addClass('loading-icon');

            $.ajax({
                url: window.location.pathname + '?' + urlParameters,
                method: 'GET',
                success: function(result) {
                    var $html = $(result);

                    if($html.find('.js-products').length) {
                        var currentScrollTop = $(window).scrollTop();
                        var products = $html.find('.js-products').children('.productblock__wrapper');

                        $('.js-products').append(products);
                        $(window).scrollTop(currentScrollTop);
                        $button.data('current-page', nextPage).removeClass('loading-icon');
                        window.history.pushState('', '', '?' + urlParameters);

                        if(nextPage >= numberOfPages) {
                            $button.remove();
                        } else {
                            var buttonOffet = $button.offset().top + 100;

                            $(window).off('scroll.loadMore').on('scroll.loadMore', function() {
                                if(($(window).scrollTop() + $(window).outerHeight()) > buttonOffet) {
                                    $(window).off('scroll.loadMore');
                                    $button.trigger('click');
                                }
                            });
                        }
                    }
                }
            });

            return false;
        });
    });

    $('.js-products-backtotop').each(function() {
        var $button = $(this);

        $(window).on('scroll.backToTop', function() {
            $button.toggleClass('visible', ($(this).scrollTop() > $(this).outerHeight()));
        });

        $button.on('click', function() {
            $('html, body').animate({
                scrollTop: 0
            });
        });
    });
});

$(document).ready(function() {
    $('.js-promobar-countdown').each(function() {
        var $countdown = $(this);
        var countDownDate = Date.parse($countdown.attr('data-date'));

        var x = setInterval(function () {
            var now = new Date().getTime();
            var distance = countDownDate - now;

            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            if(document.documentElement.lang === 'de') {
                $countdown.html("Noch " + days + (days === 1 ? " Tag " : " Tage ") + hours + (days === 1 ? " Stunde " : " Stunden ") + minutes + (minutes === 1 ? " Minute " : " Minuten ") + seconds + (seconds === 1 ? " Sekunde " : " Sekunden ") +" bis zum");
            } else {
                $countdown.html("Nog " + days + (days === 1 ? " dag " : " dagen ") + hours + " uur " + minutes + (minutes === 1 ? " minuut " : " minuten ") + seconds + (seconds === 1 ? " seconde " : " seconden ") +" tot de");
            }

            if (distance < 0) {
                clearInterval(x);
                $countdown.html('');
            }
        }, 1000);
    });

    $('.js-promobar').each(function() {
        var $promobar = $(this);
        var $header = $promobar.next('.header__topbar');
        $header.css('top', $promobar.outerHeight());
    });
});

$('body').on('submit', '.js-question', function(e) {
    e.preventDefault();
    var $form = $(this);

    // Extra check if validation is active
    if(!$form.valid()) {
        return false;
    }

    var $alertSuccess = $form.find('.alert-success');
    var $alertDanger = $form.find('.alert-danger');
    var $footerElements = $form.find('.modal-footer').children();
    var $formData = $form.serialize();
    var $formElements = $form.find('input, textarea, select');

    $formElements.prop('disabled', true);

    $.ajax({
        type: 'post',
        url: '/bjax/ProductQuestion/Ask',
        data: $formData,
        success: function(response) {
            $alertSuccess.removeClass('d-none');
            $alertDanger.addClass('d-none');
            $footerElements.toggleClass('d-none');
        },
        error: function(response) {
            $alertDanger.removeClass('d-none');
            $alertSuccess.addClass('d-none');
            $formElements.prop('disabled', false);
        }
    });

    return false;
});

$('.js-reminder').each(function() {
    var $form = $(this);

    $form.on('submit', function() {
        if(!$form.valid()) {
            return false;
        }

        var $alertSuccess = $form.find('.text-success');
        var $formData = $form.serialize();
        var $formButton = $form.find('button');
        var $formInput = $form.find('input, button');

        $formButton.prop('disabled', true).addClass('loading');
        $formInput.prop('disabled', true);

        $.ajax({
            type: $form.attr('method'),
            url: $form.attr('action'),
            data: $formData,
            success: function(response) {
                $formButton.hide();
                $alertSuccess.removeClass('d-none');
            },
            error: function(response) {
                if(response.responseText === 'already_exists') {
                    $formButton.hide();
                    $alertSuccess.removeClass('d-none');
                } else {
                    $alertSuccess.addClass('d-none');
                    $formButton.prop('disabled', false).removeClass('loading');
                    $formInput.prop('disabled', false);
                }
            }
        });

        return false;
    });
});

$('body').on('click.addInput', '.js-review-add-input', function() {
    var $add = $(this);
    var $inputs = $add.prevUntil('h6', 'input');

    if($inputs.length < 5) {
        var $newInput = $inputs.last().clone().val('');
        $newInput.insertBefore($add).focus();

        if($inputs.length === 4) {
            $add.remove();
        }
    }
    return false;
});

$('body').on('submit', '.js-review', function() {
    var $form = $(this);
    var $addInputs = $form.find('.js-review-add-input');

    // Extra check if validation is active
    if(!$form.valid()) {
        return false;
    }

    // Review validation
    var $reviewNumber = $form.find('.js-review-number');
    var $reviewExpval = $form.find('.js-review-expval');
    if($reviewNumber && $reviewExpval) {
        $reviewExpval.val($reviewNumber.val());
    }

    // Positive and negative points
    var $positives = $form.find('.js-review-positive');
    var positives = $positives.map(function() {
        var value = $.trim(this.value);
        return value ? value : undefined;
    }).get().join(' || ');
    var $negatives = $form.find('.js-review-negative');
    var negatives = $negatives.map(function() {
        var value = $.trim(this.value);
        return value ? value : undefined;
    }).get().join(' || ');

    // Set message
    var message = {
        message: $form.find('.js-review-experience').val(),
        positive: positives,
        negative: negatives
    };
    $form.find('.js-review-message').val(JSON.stringify(message));

    var $alertSuccess = $form.find('.alert-success');
    var $alertDanger = $form.find('.alert-danger');
    var $footerElements = $form.find('.modal-footer').children();
    var $formData = $form.serialize();
    var $formElements = $form.find('input, textarea, select');

    $addInputs.off('click.addInput');
    $formElements.prop('disabled', true);

    $.ajax({
		type: 'post',
		url: '/productreview',
		data: $formData,
		success: function(response) {
            $alertSuccess.removeClass('d-none');
            $alertDanger.addClass('d-none');
            $footerElements.toggleClass('d-none');
		},
		error: function(response) {
            $alertDanger.removeClass('d-none');
            $alertSuccess.addClass('d-none');
			$formElements.prop('disabled', false);
		}
	});

    return false;
});

$(document).ready(function() {
    $('.js-scroller').each(function() {
        var $scroller = $(this);
        var $row = $scroller.find('.row');
        var $scrollPrev = $scroller.next('.js-scroller-navigation').find('.js-scroller-prev');
        var $scrollNext = $scroller.next('.js-scroller-navigation').find('.js-scroller-next');

        var scrollDuration = 400;
        var scrollWidth = 0;
        var scrollTrackWidth;
        var scrollTrackScrollWidth;

        var setScrollSettings = function() {
            if(scrollWidth === 0) {
                scrollWidth = $row.children().first().outerWidth();
                scrollTrackWidth = $row.outerWidth();
                scrollTrackScrollWidth = $row[0].scrollWidth;
            }
        }

        var checkScrollPosition = function() {
            var scrollLeft = $row.scrollLeft();

            if(scrollLeft === 0) {
                $scroller.addClass('start');
                $scrollPrev.addClass('disabled');
            } else {
                $scroller.removeClass('start');
                $scrollPrev.removeClass('disabled');
            }
            if(Math.round(scrollLeft + scrollTrackWidth) === scrollTrackScrollWidth) {
                $scroller.addClass('end');
                $scrollNext.addClass('disabled');
            } else {
                $scroller.removeClass('end');
                $scrollNext.removeClass('disabled');
            }
        };

        checkScrollPosition();
        $row.on('scroll', function() {
            checkScrollPosition();
        });

        $scrollPrev.on('click', function() {
            setScrollSettings();
            if(!$scrollPrev.hasClass('disabled')) {
                $row.animate({scrollLeft: '-='+ scrollWidth}, scrollDuration);
            }
        });

        $scrollNext.on('click', function() {
            setScrollSettings();
            if(!$scrollNext.hasClass('disabled')) {
                $row.animate({scrollLeft: '+=' + scrollWidth}, scrollDuration);
            }
        });
    });

    if(!!/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        $('.js-scroller-bar').each(function() {
            var $scroller = $(this);

            var $bar = $('<div/>').addClass('scroller--bar');
            $scroller.after($bar);

            var scrollWidth = 0;
            $scroller.children().each(function(e) {
                scrollWidth += $(this).outerWidth();
            });

            var scrollSum = (scrollWidth / $bar.width());

            var $track = $('<div/>');
            $track.width(Math.floor($bar.width() / scrollSum) + 5).appendTo($bar);

            $scroller.addClass('ios');

            $scroller.on('scroll', function(e) {
                $track.css('transform', 'translateX('+($scroller.scrollLeft() / scrollSum)+'px)')
            });
        });
    }
});

$(document).ready(function() {
    $('.js-scrollto').each(function() {
        var $trigger = $(this);
        var headerOffet = $('.header__topbar').height();

        $trigger.on('click', function() {
            var target = $trigger.attr('href');
            var $target = $(target);
            var offset = $target.offset().top - (headerOffet + 16);
            
            $('html, body').animate({
                scrollTop: offset
            }, 400);
        });
    });
});

$('.js-search-toggle').each(function() {
    $(this).on('click', function() {
        window.cookinglifeSearch();
    });
});

window.cookinglifeSearch = function() {
    if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
        var $search = $('.js-search');
        var $input = $search.find('input');
        var $close = $search.find('.js-search-close');
        var $overlay = $('<div/>').addClass('header__search-overlay');

        if(!$search.hasClass('show')) {
            zilvercms.lockBody();
            $search.addClass('show');
            $overlay.insertAfter($search).fadeIn().on('click.closeSearch', function() {
                $search.removeClass('show');
                $overlay.fadeOut(function() {
                    $overlay.remove();
                });
                $input.val('');
                $('.sqr-closeButton').trigger('click');
                zilvercms.unlockBody();
            });

            $close.on('click.closeSearch', function() {
                $overlay.trigger('click.closeSearch');
            });
        }
    } else {
        zilvercms.lockBody();
    }
}

$(document).ready(function() {
    $('.js-select2').each(function() {
        var $select = $(this);

        $select.select2({
            allowHtml: true,
            minimumResultsForSearch: -1,
            sorter: function(data) {
                return data.sort(function(a, b) {
                    return (a.text.toLowerCase() > b.text.toLowerCase()) ? 0 : -1;
                });
            },
            theme: 'flat',
            templateResult: function(data) {
                return select2Template(data, false);
            },
            templateSelection: function(data) {
                return select2Template(data, true);
            }
        }).on('select2:select', function(e) {
            if($select.data('goto-value')) {
                $('html').addClass('loading');
                zilvercms.lockBody();
                window.location = e.params.data.id;
            }
        });
    });

    function select2Template(data, selection) {
        var $option = $(data.element);
        var id = data.id;
        var text = data.text;
        var image = $option.data('image');
        var price = $option.data('price');
        var priceOld = $option.data('old-price');

        var $image;
        var $price;
        var $priceOld;
        var $selected;

        if(!selection && data.selected) {
            $selected = $('<i/>').attr('data-icon-after', 'ï‰«');
        }

        if(image) {
            $image = $('<div/>', {class: 'img img--contain'}).html($('<img/>', {src: image}));
        }

        if(!selection && price) {
            if(priceOld) {
                $priceOld = $('<s/>').html(zilvercms.currencyHelper(priceOld));
            }

            $price = $('<div/>', {class: 'select2__price'}).html(zilvercms.currencyHelper(price)).prepend($priceOld);
        }

        var $option = $('<div/>', {
            class: 'd-flex align-items-center'
        }).html(text).prepend($image).append($selected).append($price);

        return $option;
    }
});

$(window).on('load', function() {
    function animateShowroom() {
        if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
            var $scroller = $('.js-showroom-scroller');
            var maxScroll = $scroller.children().width() - $scroller.width();

            $scroller.animate({
                scrollLeft: maxScroll
            }, 2000, 'linear', function() {
                $scroller.animate({
                    scrollLeft: maxScroll / 2
                }, 1000);
            });
        }
    }

    $('.js-showroom-tutorial').each(function () {
        var $tutorial = $(this);
        var $closeTutorial = $(this).find('.js-close-tutorial');
        var $range = $('.js-showroom-range');
        var cookieName = 'showroomTutorial';
        var cookie = zilvercms.getCookie(cookieName);

        if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
            $(this).find('.js-showroom-slider').slick({
                dots: true,
                infinite: false,
                nextArrow: $(this).find('.js-showroom-slider-next'),
                prevArrow: '',
                slidesToShow: 1
            });
        }

        if(cookie === '') {
            $tutorial.removeClass('noshow');
            $range.hide();

            $closeTutorial.on('click', function () {
                zilvercms.setCookie(cookieName, true, 30);
                $tutorial.addClass('noshow');
                $range.show();
                animateShowroom();
                return false;
            });
        } else {
            animateShowroom();
        }
    });

    $('.js-hotspot').each(function () {
        var $hotspot = $(this);
        var hotspotId = $hotspot.data('hotspotid');
        var $products = $('.js-showroom-products[data-hotspotid="'+hotspotId+'"]');
        var $otherHotspots = $('.js-hotspot').not($hotspot);
        var $otherProducts = $('.js-showroom-products').not($products);
        var $range = $('.js-showroom-range');

        $hotspot.on('click', function () {
            $otherHotspots.addClass('noshow');
            $otherProducts.addClass('noshow');
            $hotspot.removeClass('noshow');
            $products.removeClass('noshow');
            $range.hide();

            $('.js-showroom-image').on('click', function() {
                $otherHotspots.removeClass('noshow');
                $products.addClass('noshow');
                $range.show();
                $(this).off('click');
            });
        });
    });

    $('.js-showroom-products').each(function () {
        var $popup = $(this);
        var $slider = $popup.find('.js-showroom-slider');
        var $range = $('.js-showroom-range');

        if((zilvercms.viewport.isEqualOrSmallerThan('md') && $popup.data('amount') > 1) || (zilvercms.viewport.isEqualOrGreaterThan('lg') && $popup.data('amount') > 2)) {
            $slider.slick({
                dots: true,
                infinite: false,
                nextArrow: $(this).find('.js-showroom-slider-next'),
                prevArrow: $(this).find('.js-showroom-slider-prev'),
                slidesToShow: zilvercms.viewport.isEqualOrSmallerThan('md') ? 1 : 2
            });
        }

        $(this).find('.js-close-product').on('click', function () {
            $('.js-showroom-products').addClass('noshow');
            $('.js-hotspot').removeClass('noshow');
            $range.show();
            return false;
        });
    });

    if(zilvercms.viewport.isEqualOrSmallerThan('sm')) {
        $('.js-showroom-scroller').each(function () {
            var $scroller = $(this);
            var $range = $scroller.next('.js-showroom-range');

            $scroller.on('scroll', function(e) {
                var position = $scroller.scrollLeft();
                $range.val(position);
            });

            $scroller.find('.showroom__canvas').css('height', (window.innerHeight - 130));
        });

        $('.js-showroom-range').each(function () {
            var $range = $(this);
            var $scroller = $range.prev('.js-showroom-scroller');
            var maxScroll = $scroller.children().width() - $scroller.width();

            $range.attr('max', maxScroll).on('input', function(e) {
                $scroller.scrollLeft($(this).val());
            });
        });
    }
});

$(document).ready(function() {
    $('.js-slick').each(function() {
        var $slick = $(this);
        var $slickImages = $slick.children();

        // Set image size based on screen size and pixel ratio
        $slickImages.each(function() {
            var $img = $(this).find('img');
            var original = $img.data('original');

            if(original) {
                var pixelRatio = (window.devicePixelRatio > 1) ? 2 : 1;
                var height = $(this).parent().height() * pixelRatio;
                var width = $(this).parent().parent().width() * pixelRatio;
                $img.attr('data-lazy', zilvercms.imageHelper(original, width+'x'+height+',fit'));
            }
        });


        $slick.on('init', function(event, slick) {
            var hiddenThumbs = 0;
            var $lastVisibleThumb;

            $slick.lightGallery({
                autoplay: false,
                autoplayFirstVideo: true,
                download: false,
                exThumbImage: 'data-thumb',
                loadYoutubeThumbnail: true,
                selector: slick.$slides,
                youtubeThumbSize: 'mqdefault',
                youtubePlayerParams: {
                    modestbranding: 1,
                    rel: 0,
                    showinfo: 0
                },
                thumbWidth: 80
            });

            if(slick.$dots) {
                var parentWidth = slick.$dots.parent().width();
                var parentOffset = slick.$dots.offset().left;

                slick.$dots.find('li').each(function() {
                    var $thumb = $(this);
                    var width = $thumb.width();
                    var offsetRight = ($thumb.offset().left + width) - parentOffset;

                    if(offsetRight > parentWidth) {
                        $thumb.addClass('d-none');
                        hiddenThumbs++;
                    } else {
                        $lastVisibleThumb = $thumb;
                    }
                });

                if(hiddenThumbs > 0) {
                    $lastVisibleThumb.find('.slick-thumb').attr('data-plus', '+'+(hiddenThumbs + 1));
                }
            }

            $slick.find('.slick-next').addClass('arrow next');
            $slick.find('.slick-prev').addClass('arrow prev');
            $slick.removeClass('d-none');
        });

        $slick.slick({
            adaptiveHeight: false,
            appendDots: $slick.parent(),
            customPaging: function(slider, i) {
                var slide = slider.$slides[i];
                var $slide = $(slide);
                var thumb = $slide.data('thumb');
                var $thumb = $('<img/>').attr({'src': thumb});
                var $dot = $('<div/>').attr({'class': 'slick-thumb'}).html($thumb);
                if($slide.hasClass('slick-video')) {
                    $dot.addClass('slick-thumb-video');
                }
                $dot.on('click', function() {
                    if($dot.attr('data-plus') || $slide.hasClass('slick-video')) {
                        $slide.trigger('click');
                        return false;
                    }
                });
                return $dot;
            },
            dots: ($slickImages.length > 1),
            infinite: true,
            initialSlide: 0,
            swipe: zilvercms.viewport.isEqualOrSmallerThan('md')
        });
    });

    $('.js-trigger-slick-video').each(function() {
        var $trigger = $(this);
        var $slickVideo = $('.slick-thumb-video');

        $trigger.on('click', function() {
            $slickVideo.click();
            return false;
        });
    });
});

var _wssq = _wssq || [];
var language = document.documentElement.lang;
var searchField = 'search-field';
var $searchField = $('#' + searchField);
var sooqrAccount = $searchField.data('sooqr');
var sooqrLocale = document.documentElement.lang.toLowerCase() + '_' + document.documentElement.lang.toUpperCase();

if(sooqrAccount) {
    _wssq.push(['_load', {
        suggest: {
            account: 'SQ-' + sooqrAccount,
            fieldId : searchField,
            locale: sooqrLocale,
            version: 4
        }
    }]);

    _wssq.push(['suggest._bindEvent', 'open', function() {
        window.cookinglifeSearch();

        $searchField.parents('form').on('submit.search', function() {
            document.activeElement.blur();
            $searchField.blur();
        });

        infiniteScroll(sooqrAccount);

        pushDataLayer('sooqrOpen');
    }]);

    _wssq.push(['suggest._bindEvent', 'updateResults', function() {
        if(zilvercms.viewport.isEqualOrSmallerThan('xs')) {
            $('.sqr-resultItem .stock').each(function() {
                var $stock = $(this)
                var $wrapper = $stock.parent();
                $stock.children().unwrap();
                $wrapper.addClass('stock-label');
                $wrapper.unwrap().unwrap();
            });

            $('.sqr-results.sqr-grid').attr('class', 'sqr-results detail sqr-detail');
        }

        $('.sqr-resultItem').each(function() {
            var $item = $(this);
            var $price = $item.find('.sqr-price');
            var _price = zilvercms.currencyHelper($price.text().replace(/[^0-9]/g, ''));
            $price.html(_price);
        });

        infiniteScroll(sooqrAccount);

        pushDataLayer('sooqrUpdate');
    }]);

    _wssq.push(['suggest._bindEvent', 'close', function() {
        $('#search-field').parents('form').off('submit.search');

        if(zilvercms.viewport.isGreaterThan('xs')) {
            zilvercms.unlockBody();
        }

        $jQ('.sooqrSearchContainer-' + sooqrAccount + ' .sooqrSearchResultsContainer').unbind('scroll.infiniteScroll');

        pushDataLayer('sooqrClose');
    }]);

    function infiniteScroll(sooqrAccount) {
        $jQ('.sooqrSearchContainer-' + sooqrAccount + ' .sooqrSearchResultsContainer').unbind('scroll.infiniteScroll').bind('scroll.infiniteScroll', function() {
            var $container = $jQ(this);
            var $results =  $container.find('.sooqrSearchResults');
            var $more = $container.find('.sqr-moreResults');

            if($more.is(':visible') && ($container.scrollTop() + $container.outerHeight()) > ($results.outerHeight() - 60)) {
                $more.trigger('click');
            }
        });
    }

    function pushDataLayer(eventName) {
        window.dataLayer = window.dataLayer || [];
        dataLayer.push({
            event: eventName
        });
    }

    (function() {
        var ws = document.createElement('script'); ws.type = 'text/javascript'; ws.async = true;
        ws.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'static.sooqr.com/sooqr.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ws, s);
    })();
}

if(typeof URLSearchParams !== 'undefined') {
    var urlParams = new URLSearchParams(window.location.search);
    var source = urlParams.get('utm_source');
    var medium = urlParams.get('utm_medium');
    var campaign = urlParams.get('utm_campaign');

    if(source !== null) {
        document.cookie = ['last_utm_source=', source, ';path=/'].join('');
    }
    if(medium !== null) {
        document.cookie = ['last_utm_medium=', medium, ';path=/'].join('');
    }
    if(campaign !== null) {
        document.cookie = ['last_utm_campaign=', campaign, ';path=/'].join('');
    }
}

$(document).ready(function() {
    // Check if browser supports date input
    var datePickerFormatMessage = '';
    var inputField = document.createElement('input');
    inputField.setAttribute('type', 'date');
    if(inputField.type != 'date') {
        datePickerFormatMessage = ' (JJJJ-MM-DD)';
    }

    $.validator.messages = {
        required: zilvercms.translationHelper('validate.required'),
        remote: zilvercms.translationHelper('validate.remote'),
        email: zilvercms.translationHelper('validate.email'),
        url: zilvercms.translationHelper('validate.url'),
        date: zilvercms.translationHelper('validate.date'),
        dateISO: zilvercms.translationHelper('validate.dateISO'),
        number: zilvercms.translationHelper('validate.number'),
        digits: zilvercms.translationHelper('validate.digits'),
        creditcard: zilvercms.translationHelper('validate.creditcard'),
        equalTo: zilvercms.translationHelper('validate.equalTo'),
        extension: zilvercms.translationHelper('validate.extension'),
        maxlength: $.validator.format(zilvercms.translationHelper('validate.maxlength')),
        minlength: $.validator.format(zilvercms.translationHelper('validate.minlength')),
        rangelength: $.validator.format(zilvercms.translationHelper('validate.rangelength')),
        range: $.validator.format(zilvercms.translationHelper('validate.range')),
        max: $.validator.format(zilvercms.translationHelper('validate.max')),
        min: $.validator.format(zilvercms.translationHelper('validate.min')),
        step: $.validator.format(zilvercms.translationHelper('validate.step'))
    };

    $.validator.addMethod('zipcodeNL', function(value, element) {
        if($(element).hasClass('js-address-zipcode')) {
            return /^[1-9][0-9]{3}\s?[a-zA-Z]{2}$/.test(value);
        } else {
            return true;
        }
    }, 'Vul een geldige postcode in, bijv: 1234AB');

    $.validator.addMethod('visiblePaymentMethod', function(value, element) {
        return $('#method'+value).is(':visible');
    }, zilvercms.translationHelper('webshop.checkout.select_paymentmethod'));

    $.validator.addMethod('validDate', function(value, element) {
        var regEx = /^\d{4}-\d{2}-\d{2}$/;
        if(!value.match(regEx)) {
            return false;  // Invalid format
        }

        var today = new Date();
        var date = new Date(value);
        if(Number.isNaN(date.getTime())) {
            return false; // Invalid date
        } else if ((today.getFullYear() - date.getFullYear()) > 110) {
            return false; // Invalid age
        }

        return date.toISOString().slice(0, 10) === value;
    }, (zilvercms.translationHelper('validate.birthdate') + datePickerFormatMessage));

    $.validator.addMethod('minAge18', function(value, element) {
        var birthDate = new Date(value);
        var eighteenYearsAgo = new Date();
        eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);

        return (birthDate < eighteenYearsAgo);
    }, zilvercms.translationHelper('validate.minAge18'));

    $.validator.addMethod('vatNumber', function(value, element) {
        var countryCode = $('.js-checkout-country').val();

        if(countryCode === 'nl') {
            return (value === '' || (value.length === 14 && value.match(/^[A-Z]{2}[0-9]{9}[A-Z]{1}[0-9]{2}/g)));
        } else if(countryCode === 'be') {
            return (value === '' || (value.length === 12 && value.match(/^[A-Z]{2}[0-9]{10}/g)));
        } else {
            return true;
        }
    }, zilvercms.translationHelper('validate.vatmessage'));

    $.validator.addMethod('cocNumber', function(value, element) {
        var selectedPaymentMethodName = $('*[data-payment-method]:checked').data('payment-method');
        if(selectedPaymentMethodName === 'billink') {
            return ($(element).val().length > 0);
        }
        return true;
    }, zilvercms.translationHelper('validate.required'));

    $.validator.addMethod('phone', function(value, element) {
        return value.match(/^\(?\+?[\d\(\-\s\)]+$/);
    }, zilvercms.translationHelper('validate.phone'));

    $.validator.addMethod('step', function(value, element) {
        var step = $(element).attr('step');
        return (Math.round(value/step) === (value/step));
    }, function(params, element) {
        var value = $(element).val();
        var step = $(element).attr('step');
        var prev = Math.floor(value/step) * step;
        var next = Math.ceil(value/step) * step;
        return zilvercms.translationHelper('validate.productStep', {
            '{step}': step,
            '{prev}': prev,
            '{next}': next
        });
    });

    $.validator.formValidation = function(form) {
        $(form).addClass('validating').validate({
			rules: {
				'data[buyer][phone]': {
                    minlength: 8,
                    maxlength: 17,
					phone: true,
                    required: true
				},
                'data[buyer][email]': {
                    email: true,
                    required: true
                },
                'data[invoice][zipcode]': {
                    zipcodeNL: true,
                    required: true
                },
                'data[shipping][zipcode]': {
                    zipcodeNL: true,
                    required: true
                },
                "data[buyer][vat]": {
                    vatNumber: true
                },
                'data[payment][method]': {
                    visiblePaymentMethod: true,
                    required: true
                },
                'data[buyer][birthdate]': {
                    validDate: true,
                    minAge18: true
                },
                'data[buyer][coc]': {
                    cocNumber: true
                },
                count: {
                    step: true
                }
			},
            messages: {
                order_accept: zilvercms.translationHelper('webshop.checkout.order_accept'),
                'data[payment][method]': zilvercms.translationHelper('webshop.checkout.select_paymentmethod'),
                'data[buyer][birthdate]': {
                    date: (zilvercms.translationHelper('validate.birthdate') + datePickerFormatMessage)
                },
                count: {
                    max: zilvercms.translationHelper('validate.maxOrder')
                }
            },
            ignore: ':hidden, .js-pickup-location',
            highlight: function(el) {},
            unhighlight: function(el) {
                var $el = $(el);

                if($el.parents('.productblock').length) {
                    $el.parents('.productblock').removeAttr('data-error');
                } else if($el.hasClass('checkout__payment-option')) {
                    $el.prev('.text.error').remove();
                } else if($el.hasClass('radio') || $el.hasClass('checkbox')) {
                    $el.next('label').removeAttr('data-error');
                } else {
                    $el.parent().removeAttr('data-error').removeAttr('data-success');

                    if($el.val() != '' && !$el.is('[readonly]')) {
                        $el.parent().attr('data-success', true);
                    }
                }
            },
            errorPlacement: function(error, el) {
                var $el = $(el);

                if($el.parents('.productblock').length) {
                    $el.parents('.productblock').removeAttr('data-success').attr('data-error', error[0].textContent);
                } else if($el.hasClass('checkout__payment-option')) {
                    var $div = $('<div/>').addClass('text error mb-3').text(error[0].textContent);
                    $el.prev('.text.error').remove();
                    $el.before($div);
                } else if($el.hasClass('radio') || $el.hasClass('checkbox')) {
                    $el.next('label').removeAttr('data-success').attr('data-error', error[0].textContent);
                } else {
                    $el.parent().removeAttr('data-success').attr('data-error', error[0].textContent);
                }
           }
       });
    };

    $('.js-validate').each(function() {
        $.validator.formValidation(this);
    });
});

$(document).ready(function() {
    $('.js-voysqueue').each(function() {
        var $badge = $(this);

        $.getJSON('/bjax/voys/queue/', function(data) {
            if(data.size === 0) {
                $badge.css('opacity', 1);
            } else {
                $badge.remove();
            }
        });
    });
});

$(document).ready(function() {
    $('.js-whatsapp').each(function() {
        var $badge = $(this);
        var cookie = zilvercms.getCookie('whatsappbadge');
        $badge.width($badge.width());

        if(!cookie) {
            setTimeout(function() {
                $badge.addClass('closed');
                zilvercms.setCookie('whatsappbadge', true, 1);
            }, 6000);
        } else {
            $badge.addClass('closed');
        }
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl90ZW1wbGF0ZS5qcyIsImFkZHJlc3MtYXV0b2ZpbGwuanMiLCJhcmVhLmpzIiwiY2FydC5qcyIsImNoZWNrb3V0LmpzIiwiY29tYmluYXRpb25zLmpzIiwiY29va2llY29uc2VudC5qcyIsImNvdW50ZG93bi5qcyIsImZhcS5qcyIsImdlby5qcyIsImxhenkuanMiLCJtYWlubWVudS5qcyIsIm1pY3JvY2FydC5qcyIsIm1vZGFsLmpzIiwib3JkZXIuanMiLCJwYWdpbmF0aW9uLmpzIiwicGFramVnZW1hay5qcyIsInBkcC5qcyIsInByb2R1Y3RsaXN0LmpzIiwicHJvbW9iYXIuanMiLCJxdWVzdGlvbnMuanMiLCJyZW1pbmRlci5qcyIsInJldmlld3MuanMiLCJzY3JvbGxlci5qcyIsInNjcm9sbHRvLmpzIiwic2VhcmNoLmpzIiwic2VsZWN0Mi5qcyIsInNob3dyb29tcy5qcyIsInNsaWNrLmpzIiwic29vcXIuanMiLCJ1dG0uanMiLCJ2YWxpZGF0ZS5qcyIsInZveXNxdWV1ZS5qcyIsIndoYXRzYXBwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlOQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbk5BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbkNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDYkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJ2NC9zY3JpcHRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJCgnLmpzLXRlbXBsYXRlJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICB2YXIgJHRlbXBsYXRlID0gJCh0aGlzKTtcbiAgICB2YXIgJGRlc2t0b3BUZW1wbGF0ZSA9ICR0ZW1wbGF0ZS5maW5kKCcuanMtdGVtcGxhdGUtZGVza3RvcCcpO1xuICAgIHZhciAkbW9iaWxlVGVtcGxhdGUgPSAkdGVtcGxhdGUuZmluZCgnLmpzLXRlbXBsYXRlLW1vYmlsZScpO1xuICAgIHZhciBjb250ZW50ID0gKHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JTbWFsbGVyVGhhbignbWQnKSkgPyAkbW9iaWxlVGVtcGxhdGUuaHRtbCgpIDogJGRlc2t0b3BUZW1wbGF0ZS5odG1sKCk7XG5cbiAgICAkdGVtcGxhdGUucmVwbGFjZVdpdGgoY29udGVudCk7XG59KTtcblxuJC5lYWNoKHppbHZlcmNtcy52YXJpYWJsZXMuc2l6ZXMsIGZ1bmN0aW9uKGluZGV4LCBzaXplKSB7XG4gICAgaWYoemlsdmVyY21zLnZpZXdwb3J0LmlzKCkgPT09IHNpemUpIHtcbiAgICAgICAgJCgnLmpzLXRlbXBsYXRlLScrc2l6ZSkuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkdGVtcGxhdGUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSAkdGVtcGxhdGUuaHRtbCgpO1xuICAgICAgICAgICAgJHRlbXBsYXRlLnJlcGxhY2VXaXRoKGNvbnRlbnQpO1xuICAgICAgICB9KTtcbiAgICB9XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy1hZGRyZXNzLWF1dG9maWxsLWludm9pY2UsIC5qcy1hZGRyZXNzLWF1dG9maWxsLXNoaXBwaW5nJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyk7XG5cbiAgICAgICAgaWYoJGlucHV0Lmhhc0NsYXNzKCdqcy1hZGRyZXNzLWF1dG9maWxsLXNoaXBwaW5nJykpIHtcbiAgICAgICAgICAgIHZhciB0eXBlID0gJ3NoaXBwaW5nJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciB0eXBlID0gJ2ludm9pY2UnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoJGlucHV0Lmhhc0NsYXNzKCdqcy1hZGRyZXNzLXppcGNvZGUnKSB8fCAkaW5wdXQuaGFzQ2xhc3MoJ2pzLWFkZHJlc3Mtc3RyZWV0bnInKSkge1xuICAgICAgICAgICAgJGlucHV0Lm9uKCdjaGFuZ2UuYXV0b2ZpbGxBZGRyZXNzJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyICR6aXBjb2RlID0gJCgnLmpzLWFkZHJlc3MtYXV0b2ZpbGwtJyt0eXBlKycuanMtYWRkcmVzcy16aXBjb2RlJyk7XG4gICAgICAgICAgICAgICAgdmFyICRzdHJlZXRuciA9ICQoJy5qcy1hZGRyZXNzLWF1dG9maWxsLScrdHlwZSsnLmpzLWFkZHJlc3Mtc3RyZWV0bnInKTtcbiAgICAgICAgICAgICAgICB2YXIgJHN0cmVldCA9ICQoJy5qcy1hZGRyZXNzLWF1dG9maWxsLScrdHlwZSsnLmpzLWFkZHJlc3Mtc3RyZWV0Jyk7XG4gICAgICAgICAgICAgICAgdmFyICRwbGFjZSA9ICQoJy5qcy1hZGRyZXNzLWF1dG9maWxsLScrdHlwZSsnLmpzLWFkZHJlc3MtcGxhY2UnKTtcblxuICAgICAgICAgICAgICAgIHZhciB6aXBjb2RlID0gJHppcGNvZGUudmFsKCkuc3BsaXQoJyAnKS5qb2luKCcnKTtcbiAgICAgICAgICAgICAgICB2YXIgc3RyZWV0bnIgPSAkc3RyZWV0bnIudmFsKCk7XG5cbiAgICAgICAgICAgICAgICAkemlwY29kZS5wYXJlbnQoKS5yZW1vdmVBdHRyKCdkYXRhLXdhcm5pbmcnKTtcbiAgICAgICAgICAgICAgICAkc3RyZWV0bnIucGFyZW50KCkucmVtb3ZlQXR0cignZGF0YS13YXJuaW5nJyk7XG5cbiAgICAgICAgICAgICAgICBpZih6aXBjb2RlLm1hdGNoKC9eWzEtOV1bMC05XXszfVtcXCBdKltBLXpdezJ9JC9pKSAmJiBzdHJlZXRuciAhPSAnJykge1xuICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJy9iamF4L3dlYnNob3AvcG9zdGNvZGVmaWxsLycsXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdGNvZGU6IHppcGNvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHVpc25yOiBzdHJlZXRuclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkc3RyZWV0LnZhbCgpID09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RyZWV0LnZhbChyZXN1bHQuc3RyZWV0KS52YWxpZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRwbGFjZS52YWwoKSA9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHBsYWNlLnZhbChyZXN1bHQuY2l0eSkudmFsaWQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cudmFsaWRaaXBjb2RlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICR6aXBjb2RlLnBhcmVudCgpLmF0dHIoJ2RhdGEtd2FybmluZycsICdXaWogdm9uZGVuIGdlZW4gZ2VsZGlnZSBjb21iaW5hdGllIHZhbiBwb3N0Y29kZSBlbiBodWlzbnVtbWVyLCBjb250cm9sZWVyIG9mIGRlemUgZ29lZCB6aWpuIGluZ2V2dWxkLicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdHJlZXRuci5wYXJlbnQoKS5hdHRyKCdkYXRhLXdhcm5pbmcnLCAnICcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy52YWxpZFppcGNvZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLWFyZWEnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJGFyZWEgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJHBhZ2luYXRpb25QYXJlbnQgPSAkYXJlYS5wYXJlbnRzKCcuanMtcGFnaW5hdGlvbicpO1xuICAgICAgICB2YXIgY29udGVudEhlaWdodCA9ICRhcmVhLm91dGVySGVpZ2h0KCk7XG5cbiAgICAgICAgaWYoY29udGVudEhlaWdodCA+IDE4MCkge1xuICAgICAgICAgICAgdmFyICRtb3JlID0gJCgnPGEvPicsIHtcbiAgICAgICAgICAgICAgICBjbGFzczogJ2FyZWEtLXJlYWRtb3JlJ1xuICAgICAgICAgICAgfSkudGV4dCgnTGVlcyBtZWVyJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgJG1vcmUuaGlkZSgpO1xuICAgICAgICAgICAgICAgICRhcmVhLnJlbW92ZUNsYXNzKCdhcmVhLS1tYXgtaGVpZ2h0Jyk7XG5cbiAgICAgICAgICAgICAgICBpZigkcGFnaW5hdGlvblBhcmVudC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgJHBhZ2luYXRpb25QYXJlbnQuZmluZCgnLnNsaWNrLWxpc3QnKS5jc3MoJ2hlaWdodCcsICRhcmVhLnBhcmVudHMoJy5zbGljay1zbGlkZScpLm91dGVySGVpZ2h0KCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgJGFyZWEuYXBwZW5kKCRtb3JlKS5hZGRDbGFzcygnYXJlYS0tbWF4LWhlaWdodCcpO1xuICAgICAgICB9XG4gICAgfSk7XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy1jYXJ0JykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRjYXJ0ID0gJCh0aGlzKTtcbiAgICAgICAgdmFyIF90aW1lb3V0O1xuICAgICAgICB2YXIgcGFnZVRpdGxlID0gJCgndGl0bGUnKS50ZXh0KCk7XG4gICAgICAgIHZhciBfcGFnZVRpdGxlVGltZW91dDtcblxuICAgICAgICBzZXRTZWxlY3QyKCk7XG5cbiAgICAgICAgJGNhcnQub24oJ2NsaWNrLnVwZGF0ZUFtb3VudCcsICcuanMtcGx1cy1idG4sIC5qcy1taW51cy1idG4nLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkYnRuID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkYnRuLnNpYmxpbmdzKCdpbnB1dCcpO1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VJbnQoJGlucHV0LnZhbCgpKTtcbiAgICAgICAgICAgIHZhciBzdGVwID0gcGFyc2VJbnQoJGlucHV0LmF0dHIoJ3N0ZXAnKSk7XG4gICAgICAgICAgICB2YXIgdXBkYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmKCRidG4uaGFzQ2xhc3MoJ2pzLXBsdXMtYnRuJykpIHtcbiAgICAgICAgICAgICAgICBpZigkaW5wdXQuYXR0cignbWF4JykgJiYgdmFsdWUgPj0gcGFyc2VJbnQoJGlucHV0LmF0dHIoJ21heCcpKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgJHdhcm5pbmcgPSAkaW5wdXQucGFyZW50KCkuc2libGluZ3MoJy5qcy1zdG9jay13YXJuaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICR3YXJuaW5nLmZhZGVJbigpO1xuXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkd2FybmluZy5mYWRlT3V0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDI1MDApO1xuXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChfdGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gKHZhbHVlICsgc3RlcCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoX3RpbWVvdXQpO1xuICAgICAgICAgICAgICAgIGlmKHZhbHVlID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICh2YWx1ZSAtIHN0ZXApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICRpbnB1dC52YWwodmFsdWUpO1xuXG4gICAgICAgICAgICBpZih1cGRhdGUpIHtcbiAgICAgICAgICAgICAgICBfdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUNhcnQoJGNhcnQpO1xuICAgICAgICAgICAgICAgICAgICBfdGltZW91dCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfSwgNTAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgJGNhcnQub24oJ2JsdXIudXBkYXRlQW1vdW50JywgJy5qcy1jYXJ0LWFtb3VudCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyk7XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUludCgkaW5wdXQudmFsKCkpO1xuICAgICAgICAgICAgdmFyIHN0ZXAgPSBwYXJzZUludCgkaW5wdXQuYXR0cignc3RlcCcpKTtcbiAgICAgICAgICAgIGlmKHN0ZXAgPiAxICYmICEoTWF0aC5yb3VuZCh2YWx1ZS9zdGVwKSA9PT0gKHZhbHVlL3N0ZXApKSkge1xuICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gTWF0aC5jZWlsKHZhbHVlL3N0ZXApICogc3RlcDtcbiAgICAgICAgICAgICAgICAkaW5wdXQudmFsKG5leHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoJGlucHV0LmF0dHIoJ21heCcpICYmIHZhbHVlID4gcGFyc2VJbnQoJGlucHV0LmF0dHIoJ21heCcpKSkge1xuICAgICAgICAgICAgICAgICRpbnB1dC52YWwoJGlucHV0LmF0dHIoJ21heCcpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHVwZGF0ZUNhcnQoJGNhcnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAkY2FydC5vbignY2hhbmdlLnVwZGF0ZVNoaXBwaW5nTWV0aG9kJywgJy5qcy1zaGlwcGluZ21ldGhvZCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHVwZGF0ZUNhcnQoJGNhcnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAkY2FydC5vbignY2xpY2sucmVtb3ZlQW1vdW50JywgJy5qcy1jYXJ0LWRlbGV0ZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICRyZW1vdmUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgdmFyICRhbW91bnQgPSAkcmVtb3ZlLnBhcmVudCgpLmZpbmQoJy5qcy1jYXJ0LWFtb3VudCcpO1xuICAgICAgICAgICAgJGFtb3VudC52YWwoMCk7XG4gICAgICAgICAgICB1cGRhdGVDYXJ0KCRjYXJ0KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgJGNhcnQub24oJ2NoYW5nZS51cGRhdGVTaGlwcGluZ01ldGhvZENvdW50cnknLCAnLmpzLXNoaXBwaW5nbWV0aG9kLWNvdW50cnknLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkc2VsZWN0ID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciAkb3B0aW9uID0gJHNlbGVjdC5wYXJlbnRzKCdsYWJlbCcpLnByZXYoJ2lucHV0Jyk7XG4gICAgICAgICAgICAkb3B0aW9uLnZhbCgkc2VsZWN0LnZhbCgpKS5wcm9wKCdjaGVja2VkJywgdHJ1ZSk7XG4gICAgICAgICAgICB1cGRhdGVDYXJ0KCRjYXJ0KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgJGNhcnQub24oJ2NsaWNrLm9wZW5TZWxlY3QyJywgJy5zZWxlY3QyJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBEaXNjb3VudCBjb2RlXG4gICAgICAgICRjYXJ0Lm9uKCdjbGljay5zaG93RGlzY291bnRGaWVsZCcsICcuanMtZGlzY291bnQtdHJpZ2dlcicsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICR0cmlnZ2VyID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciAkZGlzY291bnQgPSAkY2FydC5maW5kKCcuanMtZGlzY291bnQnKTtcblxuICAgICAgICAgICAgJGRpc2NvdW50LmZhZGVJbigpO1xuICAgICAgICAgICAgJHRyaWdnZXIuaGlkZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICAkY2FydC5vbigna2V5dXAudXBkYXRlQ29kZScsICcuanMtZGlzY291bnRjb2RlJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgdmFyICRjb2RlID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciBjdXJyZW50Q29kZSA9ICRjb2RlLmRhdGEoJ2NvZGUnKTtcbiAgICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAkY29kZS52YWwoKTtcblxuICAgICAgICAgICAgJGNhcnQuZmluZCgnLmpzLWFjdGl2YXRlLWRpc2NvdW50Y29kZScpLnRvZ2dsZUNsYXNzKCdoaWRlJywgKGN1cnJlbnRDb2RlID09IGN1cnJlbnRWYWx1ZSkpO1xuICAgICAgICAgICAgJGNhcnQuZmluZCgnLmpzLWRpc2NvdW50JykucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgJGNhcnQub24oJ2tleWRvd24udXBkYXRlQ29kZScsICcuanMtZGlzY291bnRjb2RlJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYoZS53aGljaCA9PSAxMykge1xuICAgICAgICAgICAgICAgIGNoZWNrRGlzY291bnRDb2RlKCRjYXJ0KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRjYXJ0Lm9uKCdjbGljay5hY3RpdmF0ZUNvZGUnLCAnLmpzLWFjdGl2YXRlLWRpc2NvdW50Y29kZScsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGNoZWNrRGlzY291bnRDb2RlKCRjYXJ0KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgJGNhcnQub24oJ3N1Ym1pdC5zZW5kQ2FydCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgJGNhcnQuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICQoJ2h0bWwnKS5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICB9KTtcblxuICAgICAgICAkKHdpbmRvdykub24oJ2ZvY3VzJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoX3BhZ2VUaXRsZVRpbWVvdXQpO1xuICAgICAgICAgICAgJCgndGl0bGUnKS5odG1sKHBhZ2VUaXRsZSk7XG4gICAgICAgIH0pLm9uKCdibHVyJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBfcGFnZVRpdGxlVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgJCgndGl0bGUnKS5odG1sKCcmIzEyODI3NjsgKDEpICcgKyB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3dlYnNob3AuY2hlY2tvdXQuZG9udF9mb3JnZXRfeW91cl9vcmRlcicpKTtcbiAgICAgICAgICAgIH0sIDIwMDApO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGZ1bmN0aW9uIHVwZGF0ZUNhcnQoJGNhcnQpIHtcbiAgICAgICAgdmFyICRmb3JtID0gJGNhcnQuZmluZCgnLmpzLWNhcnQtZm9ybScpO1xuICAgICAgICB2YXIgJGNvbW1hbmQgPSAkZm9ybS5maW5kKCcuanMtY2FydC1jb21tYW5kJyk7XG4gICAgICAgICRjb21tYW5kLnZhbCgndXBkYXRlY2FydCcpO1xuICAgICAgICB2YXIgZm9ybURhdGEgPSAkZm9ybS5zZXJpYWxpemUoKTtcblxuICAgICAgICAkY2FydC5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAkKCdodG1sJykuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcblxuICAgICAgICAkLmFqYXgoe1xuICAgICAgICAgICAgdXJsOiAnL2NhcnQnLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBkYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHZhciAkaHRtbCA9ICQocmVzdWx0KTtcbiAgICAgICAgICAgICAgICBpZigkaHRtbC5maWx0ZXIoJy5qcy1jYXJ0JykubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjYXJ0ID0gJGh0bWwuZmlsdGVyKCcuanMtY2FydCcpLmh0bWwoKTtcbiAgICAgICAgICAgICAgICAgICAgJGNhcnQuaHRtbChjYXJ0KS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAkKCdodG1sJykucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0U2VsZWN0MigpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICRmb3JtLnN1Ym1pdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjaGVja0Rpc2NvdW50Q29kZSgkY2FydCkge1xuICAgICAgICB2YXIgJGRpc2NvdW50ID0gJGNhcnQuZmluZCgnLmpzLWRpc2NvdW50Jyk7XG4gICAgICAgIHZhciAkZGlzY291bnRJbnB1dCA9ICRjYXJ0LmZpbmQoJy5qcy1kaXNjb3VudGNvZGUnKTtcbiAgICAgICAgdmFyICRkaXNjb3VudEJ0biA9ICRjYXJ0LmZpbmQoJy5qcy1hY3RpdmF0ZS1kaXNjb3VudGNvZGUnKTtcbiAgICAgICAgdmFyIGRpc2NvdW50Q29kZSA9ICRkaXNjb3VudElucHV0LnZhbCgpO1xuICAgICAgICB2YXIgZGlzY291bnRDb2RlT2xkID0gJGRpc2NvdW50SW5wdXQuZGF0YSgnY29kZScpO1xuICAgICAgICB2YXIgZGlzY291bnRCdG5UZXh0ID0gJGRpc2NvdW50QnRuLnRleHQoKTtcblxuICAgICAgICBpZihkaXNjb3VudENvZGVPbGQgJiYgZGlzY291bnRDb2RlID09ICcnKSB7XG4gICAgICAgICAgICB1cGRhdGVDYXJ0KCRjYXJ0KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgICRkaXNjb3VudC5yZW1vdmVDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAkZGlzY291bnRCdG4udGV4dCgkZGlzY291bnRCdG4uZGF0YSgnbG9hZGluZy10ZXh0JykpO1xuXG4gICAgICAgICQuYWpheCgnL2JqYXgvd2Vic2hvcC9BZGRkaXNjb3VudGNvZGUnLCB7XG4gICAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgZGlzY291bnRjb2RlOiBkaXNjb3VudENvZGUsXG4gICAgICAgICAgICAgICAga2VlcEV4aXN0aW5nOiB0cnVlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlQ2FydCgkY2FydCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICRkaXNjb3VudC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgICAgICRkaXNjb3VudEJ0bi50ZXh0KGRpc2NvdW50QnRuVGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNldFNlbGVjdDIoKSB7XG4gICAgICAgICQoJy5qcy1zaGlwcGluZ21ldGhvZC1jb3VudHJ5JykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkc2VsZWN0ID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgJHNlbGVjdC5zZWxlY3QyKHtcbiAgICAgICAgICAgICAgICBhbGxvd0h0bWw6IHRydWUsXG4gICAgICAgICAgICAgICAgbWluaW11bVJlc3VsdHNGb3JTZWFyY2g6IC0xLFxuICAgICAgICAgICAgICAgIHNvcnRlcjogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoYS50ZXh0LnRvTG93ZXJDYXNlKCkgPiBiLnRleHQudG9Mb3dlckNhc2UoKSkgPyAwIDogLTE7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdGhlbWU6ICdmbGF0JyxcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVJlc3VsdDogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJpY2UgPSAkKGRhdGEuZWxlbWVudCkuZGF0YSgncHJpY2UnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyICRwcmljZTtcblxuICAgICAgICAgICAgICAgICAgICBpZihwcmljZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHByaWNlID0gJCgnPGRpdi8+Jywge2NsYXNzOiAnc2VsZWN0Ml9fcHJpY2UnfSkuaHRtbChwcmljZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCgnPGRpdi8+Jywge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M6ICdkLWZsZXggYWxpZ24taXRlbXMtY2VudGVyJ1xuICAgICAgICAgICAgICAgICAgICB9KS5odG1sKGRhdGEudGV4dCkuYXBwZW5kKCRwcmljZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNlbGVjdGlvbjogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCgnPGRpdi8+Jywge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M6ICdkLWZsZXggYWxpZ24taXRlbXMtY2VudGVyJ1xuICAgICAgICAgICAgICAgICAgICB9KS5odG1sKGRhdGEudGV4dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLWFkZHJlc3Mtc3RyZWV0JykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRzdHJlZXQgPSAkKHRoaXMpO1xuXG4gICAgICAgICRzdHJlZXQub24oJ2NoYW5nZS51cGRhdGVTdHJlZXQnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlU3RyZWV0KCRzdHJlZXQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgICQoJy5qcy1hZGRyZXNzLXBsYWNlJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRwbGFjZSA9ICQodGhpcyk7XG5cbiAgICAgICAgJHBsYWNlLm9uKCdjaGFuZ2UudXBkYXRlUGxhY2UnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlUGxhY2UoJHBsYWNlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAkKCcuanMtY2hlY2tvdXQnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJGZvcm0gPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJHdhcm5pbmcgPSAkZm9ybS5maW5kKCcuanMtY2hlY2tvdXQtd2FybmluZycpO1xuICAgICAgICB2YXIgcGFnZVRpdGxlID0gJCgndGl0bGUnKS50ZXh0KCk7XG4gICAgICAgIHZhciBfcGFnZVRpdGxlVGltZW91dDtcblxuICAgICAgICAkZm9ybS5vbignc3VibWl0LmNoZWNrb3V0V2FybmluZ3MnLCBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgdmFyICRzdHJlZXQxb2sgPSB2YWxpZGF0ZVN0cmVldCgkKCcuanMtYWRkcmVzcy1zdHJlZXQuanMtYWRkcmVzcy1hdXRvZmlsbC1pbnZvaWNlJykpO1xuICAgICAgICAgICAgdmFyICRzdHJlZXQyb2sgPSB2YWxpZGF0ZVN0cmVldCgkKCcuanMtYWRkcmVzcy1zdHJlZXQuanMtYWRkcmVzcy1hdXRvZmlsbC1zaGlwcGluZycpKTtcbiAgICAgICAgICAgIHZhciAkcGxhY2Uxb2sgPSB2YWxpZGF0ZVBsYWNlKCQoJy5qcy1hZGRyZXNzLXBsYWNlLmpzLWFkZHJlc3MtYXV0b2ZpbGwtaW52b2ljZScpKTtcbiAgICAgICAgICAgIHZhciAkcGxhY2Uyb2sgPSB2YWxpZGF0ZVBsYWNlKCQoJy5qcy1hZGRyZXNzLXBsYWNlLmpzLWFkZHJlc3MtYXV0b2ZpbGwtc2hpcHBpbmcnKSk7XG5cbiAgICAgICAgICAgIGlmKHdpbmRvdy52YWxpZFppcGNvZGUgPT0gZmFsc2UgfHwgISRzdHJlZXQxb2sgfHwgISRzdHJlZXQyb2sgfHwgISRwbGFjZTFvayB8fCAhJHBsYWNlMm9rKSB7XG4gICAgICAgICAgICAgICAgJHdhcm5pbmcucmVtb3ZlQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgICAgICRmb3JtLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgJCgnaHRtbCcpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgJGZvcm0ub2ZmKCdzdWJtaXQuY2hlY2tvdXRXYXJuaW5ncycpLm9uKCdzdWJtaXQuY2hlY2tvdXRXYXJuaW5nc0lnbm9yZScsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICR3YXJuaW5nLmFkZENsYXNzKCdkLW5vbmUnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoJGZvcm0udmFsaWQoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlU3VibWl0KCRmb3JtLCBldmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdodG1sJykuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIGlmKCRmb3JtLnZhbGlkKCkpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVTdWJtaXQoJGZvcm0sIGV2ZW50KTtcbiAgICAgICAgICAgICAgICAkKCdodG1sJykuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgJCh3aW5kb3cpLm9uKCdmb2N1cycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KF9wYWdlVGl0bGVUaW1lb3V0KTtcbiAgICAgICAgICAgICQoJ3RpdGxlJykuaHRtbChwYWdlVGl0bGUpO1xuICAgICAgICB9KS5vbignYmx1cicsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgX3BhZ2VUaXRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICQoJ3RpdGxlJykuaHRtbCgnJiMxMjgyNzY7ICgxKSAnICsgemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd3ZWJzaG9wLmNoZWNrb3V0LmRvbnRfZm9yZ2V0X3lvdXJfb3JkZXInKSk7XG4gICAgICAgICAgICB9LCAyMDAwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAkKCcuanMtY2hlY2tvdXQtcGF5bWVudC1vcHRpb24nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJG9wdGlvbiA9ICQodGhpcyk7XG4gICAgICAgIHZhciBzYWZldHlNZXNzYWdlID0gJG9wdGlvbi5kYXRhKCdzYWZldHktbWVzc2FnZScpO1xuICAgICAgICB2YXIgc2FmZXR5TW9kYWwgPSAkb3B0aW9uLmRhdGEoJ3NhZmV0eS1tb2RhbCcpO1xuICAgICAgICB2YXIgJHNhZmV0eU1lc3NhZ2UgPSAkKCcuanMtY2hlY2tvdXQtc2FmZXR5Jyk7XG4gICAgICAgIHZhciAkc2FmZXR5TW9kYWxNZXNzYWdlID0gJCgnLmpzLWNoZWNrb3V0LXNhZmV0eS1tb2RhbC1tZXNzYWdlJyk7XG5cbiAgICAgICAgJG9wdGlvbi5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZih0aGlzLmNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICBpZihzYWZldHlNZXNzYWdlICYmIHNhZmV0eU1vZGFsKSB7XG4gICAgICAgICAgICAgICAgICAgICRzYWZldHlNZXNzYWdlLnRleHQoc2FmZXR5TWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICRzYWZldHlNb2RhbE1lc3NhZ2UudGV4dChzYWZldHlNb2RhbCk7XG4gICAgICAgICAgICAgICAgICAgICRzYWZldHlNZXNzYWdlLnNsaWRlRG93bigpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICRzYWZldHlNZXNzYWdlLnRleHQoJycpO1xuICAgICAgICAgICAgICAgICAgICAkc2FmZXR5TW9kYWxNZXNzYWdlLnRleHQoJycpO1xuICAgICAgICAgICAgICAgICAgICAkc2FmZXR5TWVzc2FnZS5zbGlkZVVwKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZih0aGlzLmNoZWNrZWQpIHtcbiAgICAgICAgICAgICRvcHRpb24udHJpZ2dlcignY2hhbmdlJyk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGZ1bmN0aW9uIGhhbmRsZVN1Ym1pdCgkZm9ybSwgZm9ybUV2ZW50KSB7XG4gICAgICAgIC8vIFJlbW92ZSBuYW1lIGF0dHIgZnJvbSBoaWRkZW4gaXNzdWVycyBzZWxlY3Rib3hlcyBhbmQgYWRkIHRvIGZpcnN0IHZpc2libGUgb25lLlxuICAgICAgICAkZm9ybS5maW5kKCcuanMtY2hlY2tvdXQtaXNzdWVyOmhpZGRlbicpLnJlbW92ZUF0dHIoJ25hbWUnKTtcbiAgICAgICAgJGZvcm0uZmluZCgnLmpzLWNoZWNrb3V0LWlzc3Vlcjp2aXNpYmxlJykuZmlyc3QoKS5hdHRyKCduYW1lJywgJ2RhdGFbcGF5bWVudF1baXNzdWVyXScpO1xuXG4gICAgICAgIC8vIEFkZCBzYWZldHkgbWVzc2FnZSB0byBsb2FkaW5nIHNjcmVlbi5cbiAgICAgICAgdmFyICRzYWZldHkgPSAkKCcuanMtY2hlY2tvdXQtc2FmZXR5Jyk7XG4gICAgICAgIHZhciAkc2FmZXR5TW9kYWwgPSAkKCcuanMtY2hlY2tvdXQtc2FmZXR5LW1vZGFsJyk7XG5cbiAgICAgICAgaWYoJHNhZmV0eS5pcygnOnZpc2libGUnKSkge1xuICAgICAgICAgICAgZm9ybUV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAkc2FmZXR5TW9kYWwuc2hvdygpO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICRmb3JtLm9mZignc3VibWl0Jykuc3VibWl0KCk7XG4gICAgICAgICAgICB9LCAzMDAwKTtcblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFyIHZhbGlkYXRlU3RyZWV0ID0gZnVuY3Rpb24oJHN0cmVldCkge1xuICAgICAgICB2YXIgc3RyZWV0ID0gJHN0cmVldC52YWwoKTtcbiAgICAgICAgJHN0cmVldC5wYXJlbnQoKS5yZW1vdmVBdHRyKCdkYXRhLXdhcm5pbmcnKTtcblxuICAgICAgICBpZih0eXBlb2Ygc3RyZWV0ICE9ICd1bmRlZmluZWQnICYmIHN0cmVldCAhPSAnJykge1xuICAgICAgICAgICAgaWYoJHN0cmVldC5oYXNDbGFzcygnanMtYWRkcmVzcy1hdXRvZmlsbC1pbnZvaWNlJykpIHtcbiAgICAgICAgICAgICAgICB2YXIgJGhvdXNlTnIgPSAkKCcuanMtYWRkcmVzcy1zdHJlZXRuci5qcy1hZGRyZXNzLWF1dG9maWxsLWludm9pY2UnKTtcbiAgICAgICAgICAgICAgICB2YXIgJGhvdXNlTnJBZGRpdGlvbiA9ICQoJ2lucHV0W25hbWU9XCJkYXRhW2ludm9pY2VdW3N0cmVldG5yX2FkZGl0aW9uXVwiXScpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgJGhvdXNlTnIgPSAkKCcuanMtYWRkcmVzcy1zdHJlZXRuci5qcy1hZGRyZXNzLWF1dG9maWxsLXNoaXBwaW5nJyk7XG4gICAgICAgICAgICAgICAgdmFyICRob3VzZU5yQWRkaXRpb24gPSAkKCdpbnB1dFtuYW1lPVwiZGF0YVtzaGlwcGluZ11bc3RyZWV0bnJfYWRkaXRpb25dXCJdJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBob3VzZU5yID0gJGhvdXNlTnIudmFsKCk7XG4gICAgICAgICAgICB2YXIgaG91c2VOckFkZGl0aW9uID0gJGhvdXNlTnJBZGRpdGlvbi52YWwoKTtcbiAgICAgICAgICAgIHZhciByZWdleDEgPSBuZXcgUmVnRXhwKGhvdXNlTnIgKyAnJCcpO1xuICAgICAgICAgICAgdmFyIHJlZ2V4MiA9IG5ldyBSZWdFeHAoaG91c2VOciArIGhvdXNlTnJBZGRpdGlvbiArICckJyk7XG4gICAgICAgICAgICB2YXIgcmVnZXgzID0gbmV3IFJlZ0V4cChob3VzZU5yICsgJyAnICsgaG91c2VOckFkZGl0aW9uICsgJyQnKTtcblxuICAgICAgICAgICAgaWYoaG91c2VOciAhPSAnJyAmJiAocmVnZXgxLnRlc3Qoc3RyZWV0KSB8fCByZWdleDIudGVzdChzdHJlZXQpIHx8IHJlZ2V4My50ZXN0KHN0cmVldCkpKSB7XG4gICAgICAgICAgICAgICAgJHN0cmVldC5wYXJlbnQoKS5hdHRyKCdkYXRhLXdhcm5pbmcnLCB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3dlYnNob3AuY2hlY2tvdXQud2FybmluZ19zdHJlZXRfZW5kX2hvdXNlbnInKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgdmFyIHZhbGlkYXRlUGxhY2UgPSBmdW5jdGlvbigkcGxhY2UpIHtcbiAgICAgICAgdmFyIHBsYWNlID0gJHBsYWNlLnZhbCgpO1xuICAgICAgICAkcGxhY2UucGFyZW50KCkucmVtb3ZlQXR0cignZGF0YS13YXJuaW5nJyk7XG5cbiAgICAgICAgaWYodHlwZW9mIHBsYWNlICE9ICd1bmRlZmluZWQnICYmIHBsYWNlICE9ICcnKSB7XG4gICAgICAgICAgICBpZigkcGxhY2UuaGFzQ2xhc3MoJ2pzLWFkZHJlc3MtYXV0b2ZpbGwtaW52b2ljZScpKSB7XG4gICAgICAgICAgICAgICAgdmFyICRjb3VudHJ5ID0gJCgnaW5wdXRbbmFtZT1cImRhdGFbaW52b2ljZV1bY291bnRyeV1cIl0nKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyICRjb3VudHJ5ID0gJCgnaW5wdXRbbmFtZT1cImRhdGFbc2hpcHBpbmddW2NvdW50cnldXCJdJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBjb3VudHJ5ID0gJGNvdW50cnkudmFsKCk7XG5cbiAgICAgICAgICAgIGlmKGNvdW50cnkgPT0gJ25sJykge1xuICAgICAgICAgICAgICAgIHZhciBwcm92aW5jZXMgPSBbXG4gICAgICAgICAgICAgICAgICAgICdEUicsIC8vIERyZW50aGVcbiAgICAgICAgICAgICAgICAgICAgJ0ZMJywgLy8gRmxldm9sYW5kXG4gICAgICAgICAgICAgICAgICAgICdGUicsIC8vIEZyaWVzbGFuZFxuICAgICAgICAgICAgICAgICAgICAnR0QnLCAvLyBHZWxkZXJsYW5kXG4gICAgICAgICAgICAgICAgICAgICdHRScsIC8vIEdlbGRlcmxhbmQgLSBhbHRcbiAgICAgICAgICAgICAgICAgICAgJ0dMRCcsIC8vIEdlbGRlcmxhbmQgLSBhbHRcbiAgICAgICAgICAgICAgICAgICAgJ0dSJywgLy8gR3JvbmluZ2VuXG4gICAgICAgICAgICAgICAgICAgICdMQicsIC8vIExpbWJ1cmdcbiAgICAgICAgICAgICAgICAgICAgJ0xJJywgLy8gTGltYnVyZyAtIGFsdFxuICAgICAgICAgICAgICAgICAgICAnTkInLCAvLyBOb29yZC1CcmFiYW50XG4gICAgICAgICAgICAgICAgICAgICdOSCcsIC8vIE5vb3JkLUhvbGxhbmRcbiAgICAgICAgICAgICAgICAgICAgJ09WJywgLy8gT3Zlcmlqc3NlbFxuICAgICAgICAgICAgICAgICAgICAnVVQnLCAvLyBVdHJlY2h0XG4gICAgICAgICAgICAgICAgICAgICdaSCcsIC8vIFp1aWQtSG9sbGFuZFxuICAgICAgICAgICAgICAgICAgICAnWkwnIC8vIFplZWxhbmRcbiAgICAgICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHByb3ZpbmNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmluY2UgPSBwcm92aW5jZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIHZhciByZWdleDEgPSBuZXcgUmVnRXhwKCcgJytwcm92aW5jZSArICckJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZWdleDIgPSBuZXcgUmVnRXhwKCcgJytwcm92aW5jZS50b0xvd2VyQ2FzZSgpICsgJyQnKTtcblxuICAgICAgICAgICAgICAgICAgICBpZihyZWdleDEudGVzdChwbGFjZSkgfHwgcmVnZXgyLnRlc3QocGxhY2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkcGxhY2UucGFyZW50KCkuYXR0cignZGF0YS13YXJuaW5nJywgemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd3ZWJzaG9wLmNoZWNrb3V0Lndhcm5pbmdfcHJvdmluY2VfaW5fcGxhY2UnLCB7JyVwcm92aW5jZSUnOiBwcm92aW5jZX0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgICQoJy5qcy1rbGFybmEtdGVybXMnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbGFuZyA9ICQoJ2h0bWwnKS5hdHRyKCdsYW5nJyk7XG4gICAgICAgIHZhciBsYW5ndWFnZSA9IGxhbmcudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgdmFyIGxhbmd1YWdlID0gKGxhbmd1YWdlID09PSAnYmUnKSA/ICdubCcgOiBsYW5ndWFnZTtcbiAgICAgICAgdmFyIGNvdW50cnkgPSBsYW5nLnRvVXBwZXJDYXNlKCk7XG5cbiAgICAgICAgaWYoemlsdmVyY21zLnZpZXdwb3J0LmlzR3JlYXRlclRoYW4oJ3NtJykpIHtcbiAgICAgICAgICAgIHR5cGUgPSAnZGVza3RvcCc7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdHlwZSA9ICdtb2JpbGUnO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3IEtsYXJuYS5UZXJtcy5JbnZvaWNlKHtcbiAgICAgICAgICAgIGVsOiAna2FsYXJuYVRlcm1zJyxcbiAgICAgICAgICAgIGVpZDogJ00tMjA5OS0yNjIwJyxcbiAgICAgICAgICAgIGxvY2FsZTogbGFuZ3VhZ2UrJ18nK2NvdW50cnksXG4gICAgICAgICAgICBjaGFyZ2U6IDAsXG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgICAgbGlua1RleHQ6IChsYW5ndWFnZSA9PT0gJ2RlJykgPyAnUmVjaG51bmdzYmVkaW5ndW5nZW4nIDogJ0ZhY3R1dXJ2b29yd2FhcmRlbicgLy9UT0RPIG1vdmUgdG8gdHJhbnNsYXRpb25zXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgJCgnLmpzLWNoZWNrb3V0LWFwcGxlcGF5JykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRtZXRob2QgPSAkKHRoaXMpO1xuICAgICAgICBpZighIXdpbmRvdy5BcHBsZVBheVNlc3Npb24gJiYgd2luZG93LkFwcGxlUGF5U2Vzc2lvbi5jYW5NYWtlUGF5bWVudHMoKSkge1xuICAgICAgICAgICAgJG1ldGhvZC5wcm9wKCdjaGVja2VkJywgdHJ1ZSk7XG4gICAgICAgICAgICAkbWV0aG9kLm5leHQoKS5yZW1vdmVDbGFzcygnZC1ub25lJyk7XG4gICAgICAgIH1cbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLWNvbWJpbmF0aW9ucycpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkY29tYmluYXRpb25zID0gJCh0aGlzKTtcblxuICAgICAgICAkY29tYmluYXRpb25zLm9uKCdpbml0JywgZnVuY3Rpb24oZXZlbnQsIHNsaWNrKSB7XG5cbiAgICAgICAgfSkub24oJ2FmdGVyQ2hhbmdlJywgZnVuY3Rpb24oZXZlbnQsIHNsaWNrLCBjdXJyZW50U2xpZGUpIHtcbiAgICAgICAgICAgICRjb21iaW5hdGlvbnMucmVtb3ZlQ2xhc3MoJ2ZpcnN0IGxhc3QnKTtcblxuICAgICAgICAgICAgaWYoc2xpY2suY3VycmVudFNsaWRlID09PSAoc2xpY2suc2xpZGVDb3VudCAtIDIpKSB7XG4gICAgICAgICAgICAgICAgJGNvbWJpbmF0aW9ucy5hZGRDbGFzcygnbGFzdCcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzbGljay5jdXJyZW50U2xpZGUgPT09IDApIHtcbiAgICAgICAgICAgICAgICAkY29tYmluYXRpb25zLmFkZENsYXNzKCdmaXJzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAkY29tYmluYXRpb25zLnNsaWNrKHtcbiAgICAgICAgICAgIGFycm93czogdHJ1ZSxcbiAgICAgICAgICAgIGRvdHM6IGZhbHNlLFxuICAgICAgICAgICAgaW5maW5pdGU6IGZhbHNlLFxuICAgICAgICAgICAgbmV4dEFycm93OiAkY29tYmluYXRpb25zLm5leHQoJy5qcy1jb21iaW5hdGlvbnMtbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1jb21iaW5hdGlvbnMtbmV4dCcpLFxuICAgICAgICAgICAgcHJldkFycm93OiAkY29tYmluYXRpb25zLm5leHQoJy5qcy1jb21iaW5hdGlvbnMtbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1jb21iaW5hdGlvbnMtcHJldicpLFxuICAgICAgICAgICAgc3dpcGU6IHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JTbWFsbGVyVGhhbignbWQnKSxcbiAgICAgICAgICAgIHNsaWRlc1RvU2hvdzogMixcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy1jb29raWUtY29uc2VudCcpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkZWxlbWVudCA9ICQodGhpcyksXG4gICAgICAgICAgICBkYXRhID0gJGVsZW1lbnQuZGF0YSgnY2MnKTtcblxuICAgICAgICB3aW5kb3cuY29va2llY29uc2VudC5pbml0aWFsaXNlKHtcbiAgICAgICAgICAgICdwb3NpdGlvbic6IGRhdGEucG9zaXRpb24sXG4gICAgICAgICAgICAnY29udGVudCc6IHtcbiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGRhdGEubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAnZGlzbWlzcyc6IGRhdGEuYnV0dG9uVGV4dCxcbiAgICAgICAgICAgICAgICAnbGluayc6IGRhdGEubW9yZVRleHQsXG4gICAgICAgICAgICAgICAgJ2hyZWYnOiBkYXRhLm1vcmVMaW5rXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRlbGVtZW50LnJlbW92ZSgpO1xuICAgIH0pO1xufSk7IiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLWNvdW50ZG93bicpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBjb3VudGRvd247XG4gICAgICAgIHZhciAkY291bnRkb3duID0gJCh0aGlzKTtcbiAgICAgICAgdmFyIG5vdyA9ICRjb3VudGRvd24uZGF0YSgnY291bnRkb3duLW5vdycpO1xuICAgICAgICB2YXIgdG8gPSAkY291bnRkb3duLmRhdGEoJ2NvdW50ZG93bi10bycpO1xuXG4gICAgICAgIGNvdW50ZG93biA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IHBhcnNlSW50KHRvKSAtIHBhcnNlSW50KG5vdyk7XG4gICAgICAgICAgICB2YXIgaG91cnMgPSBNYXRoLmZsb29yKChkaXN0YW5jZSAlICgxMDAwICogNjAgKiA2MCAqIDI0KSkgLyAoMTAwMCAqIDYwICogNjApKTtcbiAgICAgICAgICAgIHZhciBtaW51dGVzID0gTWF0aC5mbG9vcigoZGlzdGFuY2UgJSAoMTAwMCAqIDYwICogNjApKSAvICgxMDAwICogNjApKTtcbiAgICAgICAgICAgIHZhciBzZWNvbmRzID0gTWF0aC5mbG9vcigoZGlzdGFuY2UgJSAoMTAwMCAqIDYwKSkgLyAxMDAwKTtcblxuICAgICAgICAgICAgJGNvdW50ZG93bi50ZXh0KGhvdXJzICsgJzonICsgbWludXRlcyArICc6JyArIHNlY29uZHMpO1xuXG4gICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCAwKSB7XG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChjb3VudGRvd24pO1xuICAgICAgICAgICAgICAgICRjb3VudGRvd24udGV4dCgnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDEwMDApO1xuICAgIH0pO1xufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtZmFxJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRmYXEgPSAkKHRoaXMpLFxuICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSAkZmFxLmZpbmQoJy5qcy1mYXEtY2F0ZWdvcnknKTtcblxuICAgICAgICAkY2F0ZWdvcmllcy5maXJzdCgpLmFkZENsYXNzKCdvcGVuJykubmV4dCgpLnNsaWRlRG93bigpO1xuICAgICAgICAvLyRjYXRlZ29yaWVzLmZpcnN0KCkucGFyZW50KCkuZmluZCgnLmpzLWZhcS1xdWVzdGlvbicpLmZpcnN0KCkuYWRkQ2xhc3MoJ29wZW4nKS5uZXh0KCkuc2xpZGVEb3duKCk7XG5cbiAgICAgICAgJGNhdGVnb3JpZXMuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkY2F0ZWdvcnkgPSAkKHRoaXMpLFxuICAgICAgICAgICAgICAgICRwYXJlbnQgPSAkY2F0ZWdvcnkucGFyZW50KCksXG4gICAgICAgICAgICAgICAgJHF1ZXN0aW9ucyA9ICRwYXJlbnQuZmluZCgnLmpzLWZhcS1xdWVzdGlvbicpO1xuXG4gICAgICAgICAgICAkY2F0ZWdvcnkub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgaWYoJGNhdGVnb3J5Lmhhc0NsYXNzKCdvcGVuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgJGNhdGVnb3J5LnJlbW92ZUNsYXNzKCdvcGVuJykubmV4dCgpLnNsaWRlVXAoKTtcbiAgICAgICAgICAgICAgICAgICAgJHF1ZXN0aW9ucy5yZW1vdmVDbGFzcygnb3BlbicpLm5leHQoKS5zbGlkZVVwKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgJGNhdGVnb3JpZXMubm90KCRjYXRlZ29yeSkucmVtb3ZlQ2xhc3MoJ29wZW4nKS5uZXh0KCkuc2xpZGVVcCgpO1xuICAgICAgICAgICAgICAgICAgICAkY2F0ZWdvcnkuYWRkQ2xhc3MoJ29wZW4nKS5uZXh0KCkuc2xpZGVEb3duKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICRxdWVzdGlvbnMuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgJHF1ZXN0aW9uID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgICAgICRxdWVzdGlvbi5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoJHF1ZXN0aW9uLmhhc0NsYXNzKCdvcGVuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVzdGlvbi5yZW1vdmVDbGFzcygnb3BlbicpLm5leHQoKS5zbGlkZVVwKCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkcXVlc3Rpb25zLm5vdCgkcXVlc3Rpb24pLnJlbW92ZUNsYXNzKCdvcGVuJykubmV4dCgpLnNsaWRlVXAoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVzdGlvbi5hZGRDbGFzcygnb3BlbicpLm5leHQoKS5zbGlkZURvd24oKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICB2YXIgY291bnRyeUNvZGUgPSB6aWx2ZXJjbXMuZ2V0Q29va2llKCdjb3VudHJ5Q29kZScpO1xuXG4gICAgaWYoY291bnRyeUNvZGUgPT09ICcnKSB7XG4gICAgICAgICQuZ2V0SlNPTignaHR0cHM6Ly9nZXQuZ2VvanMuaW8vdjEvaXAvZ2VvLmpzb24nLCBmdW5jdGlvbihsb2NhdGlvbikge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb3VudHJ5Q29kZSA9IGxvY2F0aW9uLmNvdW50cnlfY29kZTtcbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMuc2V0Q29va2llKCdjb3VudHJ5Q29kZScsIGNvdW50cnlDb2RlLCAxKTtcbiAgICAgICAgICAgICAgICBnZW9SZWFkeShjb3VudHJ5Q29kZSk7XG4gICAgICAgICAgICB9IGNhdGNoKGVycm9yKSB7fVxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBnZW9SZWFkeShjb3VudHJ5Q29kZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2VvUmVhZHkoY291bnRyeUNvZGUpIHtcbiAgICAgICAgbGFuZ3VhZ2VTd2l0Y2goY291bnRyeUNvZGUsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nKTtcblxuICAgICAgICAvLyBBZGQgcHJvbW9iYXIgb24gdmlzaXRvcnMgZnJvbSBBdXN0cmlhXG4gICAgICAgIGlmKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nID09PSAnZGUnICYmIGNvdW50cnlDb2RlID09PSAnQVQnKSB7XG4gICAgICAgICAgICAkKCcuanMtZHluYW1pYy1wcm9tb2JhcicpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyICRmbGFnID0gJCgnPGltZy8+JykuYXR0cih7XG4gICAgICAgICAgICAgICAgICAgICdjbGFzcyc6ICdtci0yJyxcbiAgICAgICAgICAgICAgICAgICAgJ3NyYyc6ICcvdGVtcGxhdGVzL2Nvb2tpbmdsaWZlL2ltYWdlcy9kZS9mbGFnX2F1LnBuZycsXG4gICAgICAgICAgICAgICAgICAgICdoZWlnaHQnOiAnMTZweCdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgZnJlZVNoaXBwaW5nUHJpY2UgPSB6aWx2ZXJjbXMuZ2V0TWV0YVZhbHVlKCdmcmVlU2hpcHBpbmdQcmljZScpO1xuICAgICAgICAgICAgICAgIGlmKGZyZWVTaGlwcGluZ1ByaWNlICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgJHByb21vYmFyID0gJCgnPGRpdi8+JykuYWRkQ2xhc3MoJ3Byb21vYmFyIGRlZmF1bHQgdGV4dC1jZW50ZXInKS5odG1sKCdBYiAnK3ppbHZlcmNtcy5jdXJyZW5jeUhlbHBlcihmcmVlU2hpcHBpbmdQcmljZSkrJyBCZXN0ZWxsd2VydCBncmF0aXMgVmVyc2FuZCBpbiDDlnN0ZXJyZWljaCEnKTtcbiAgICAgICAgICAgICAgICAgICAgJHByb21vYmFyLnByZXBlbmQoJGZsYWcpO1xuICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlcGxhY2VXaXRoKCRwcm9tb2Jhcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZihkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZyA9PT0gJ2VuJyAmJlxuICAgICAgICAgICAgICAgIHR5cGVvZiBTVVBQT1JURURDT1VOVFJJRVMgPT09ICdvYmplY3QnICYmXG4gICAgICAgICAgICAgICAgdHlwZW9mIFNVUFBPUlRFRENPVU5UUklFU1tjb3VudHJ5Q29kZV0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAkKCcuanMtZHluYW1pYy1wcm9tb2JhcicpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyICRmbGFnID0gJCgnPGltZy8+JykuYXR0cih7XG4gICAgICAgICAgICAgICAgICAgICdjbGFzcyc6ICdtci0yJyxcbiAgICAgICAgICAgICAgICAgICAgJ3NyYyc6ICdodHRwczovLzYwY2FmYzMzYWY0MGI4Mjg3ZmZiLTFhMDMyYzFhZjg3MTYwYzdmYzAxYjlkZThmZDMyMjFlLnNzbC5jZjMucmFja2Nkbi5jb20vZmxhZ3MvJytjb3VudHJ5Q29kZS50b0xvd2VyQ2FzZSgpKycucG5nJyxcbiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCc6ICcxNnB4J1xuICAgICAgICAgICAgICAgIH0pLmNzcygndmVydGljYWwtYWxpZ24nLCAnLTJweCcpO1xuICAgICAgICAgICAgICAgIHZhciBjb3VudHJ5TmFtZSA9IFNVUFBPUlRFRENPVU5UUklFU1tjb3VudHJ5Q29kZV07XG4gICAgICAgICAgICAgICAgdmFyICRwcm9tb2JhciA9ICQoJzxkaXYvPicpLmFkZENsYXNzKCdwcm9tb2JhciBkZWZhdWx0IHRleHQtY2VudGVyJykuaHRtbCgnV2VsY29tZSwgd2UgYXJlIGhhcHB5IHRvIGRlbGl2ZXIgeW91ciBvcmRlciB0byAnICsgY291bnRyeU5hbWUpO1xuICAgICAgICAgICAgICAgICRwcm9tb2Jhci5wcmVwZW5kKCRmbGFnKTtcbiAgICAgICAgICAgICAgICAkKHRoaXMpLnJlcGxhY2VXaXRoKCRwcm9tb2Jhcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGxhbmd1YWdlU3dpdGNoKGNvdW50cnlDb2RlLCBzaXRlTGFuZ3VhZ2UpIHtcbiAgICAgICAgdmFyIGJ1dHRvbiA9ICdEb29yZ2Fhbic7XG4gICAgICAgIHZhciBjb250ZW50ID0gJyc7XG4gICAgICAgIHZhciBmbGFnID0gJyc7XG4gICAgICAgIHZhciBsaW5rID0gJyc7XG5cbiAgICAgICAgaWYoKGNvdW50cnlDb2RlID09PSAnREUnIHx8IGNvdW50cnlDb2RlID09PSAnQVQnKSAmJiBzaXRlTGFuZ3VhZ2UgIT09ICdkZScpIHtcbiAgICAgICAgICAgIGJ1dHRvbiA9ICdXZWl0ZXIgZ2VoZW4nO1xuICAgICAgICAgICAgY29udGVudCA9ICAnVW0gSWhuZW4gc28gYmVoaWxmcmVpY2ggbSZvdW1sO2dsaWNoIHp1IHNlaW4sIGVtcGZlaGxlbiB3aXIgaWhuZW4gd2VpdGVyIHp1IHNob3BwZW4gaW4gdW5zZXJlbiA8YSBocmVmPVwiaHR0cHM6Ly9jb29raW5nbGlmZS5kZVwiIGNsYXNzPVwibGluayBpbnZlcnRlZCB1bmRlcmxpbmVkXCI+RGV1dHNjaGVuIE9ubGluZSBzaG9wPC9hPi4nO1xuICAgICAgICAgICAgZmxhZyA9ICdkZSc7XG4gICAgICAgICAgICBsaW5rID0gJ2h0dHBzOi8vY29va2luZ2xpZmUuZGUnO1xuICAgICAgICB9IGVsc2UgaWYgKGNvdW50cnlDb2RlID09PSAnQkUnICYmIHNpdGVMYW5ndWFnZSAhPT0gJ2JlJykge1xuICAgICAgICAgICAgY29udGVudCA9ICdPbSB1IHpvIGdvZWQgbW9nZWxpamsgdmFuIGRpZW5zdCB0ZSB6aWpuLCBhZHZpc2VyZW4gd2lqIHUgb20gdmVyZGVyIHRlIHNob3BwZW4gaW4gb256ZSA8YSBocmVmPVwiaHR0cHM6Ly9jb29raW5nbGlmZS5iZVwiIGNsYXNzPVwibGluayBpbnZlcnRlZCB1bmRlcmxpbmVkXCI+QmVsZ2lzY2hlIHdpbmtlbDwvYT4uJztcbiAgICAgICAgICAgIGZsYWcgPSAnYmUnO1xuICAgICAgICAgICAgbGluayA9ICdodHRwczovL2Nvb2tpbmdsaWZlLmJlJztcbiAgICAgICAgfSBlbHNlIGlmIChjb3VudHJ5Q29kZSA9PT0gJ05MJyAmJiBzaXRlTGFuZ3VhZ2UgIT09ICdubCcpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSAnT20gdSB6byBnb2VkIG1vZ2VsaWprIHZhbiBkaWVuc3QgdGUgemlqbiwgYWR2aXNlcmVuIHdpaiB1IG9tIHZlcmRlciB0ZSBzaG9wcGVuIGluIG9uemUgPGEgaHJlZj1cImh0dHBzOi8vY29va2luZ2xpZmUubmxcIiBjbGFzcz1cImxpbmsgaW52ZXJ0ZWQgdW5kZXJsaW5lZFwiPk5lZGVybGFuZHNlIHdpbmtlbDwvYT4uJztcbiAgICAgICAgICAgIGZsYWcgPSAnbmwnO1xuICAgICAgICAgICAgbGluayA9ICdodHRwczovL2Nvb2tpbmdsaWZlLm5sJztcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgU1VQUE9SVEVEQ09VTlRSSUVTW2NvdW50cnlDb2RlXSA9PT0gJ3VuZGVmaW5lZCcgJiYgc2l0ZUxhbmd1YWdlICE9PSAnZW4nKSB7XG4gICAgICAgICAgICBidXR0b24gPSAnQ29udGludWUnO1xuICAgICAgICAgICAgY29udGVudCA9ICdJbiBvcmRlciB0byBwcm92aWRlIHlvdSB3aXRoIHRoZSBiZXN0IHBvc3NpYmxlIHNlcnZpY2UsIHdlIGFkdmlzZSB5b3UgdG8gY29udGludWUgc2hvcHBpbmcgaW4gb3VyIDxhIGhyZWY9XCJodHRwczovL2Nvb2tpbmdsaWZlLmV1XCIgY2xhc3M9XCJsaW5rIGludmVydGVkIHVuZGVybGluZWRcIj5pbnRlcm5hdGlvbmFsIHN0b3JlPC9hPi4nO1xuICAgICAgICAgICAgZmxhZyA9ICdldXJvcGVhbnVuaW9uJztcbiAgICAgICAgICAgIGxpbmsgPSAnaHR0cHM6Ly9jb29raW5nbGlmZS5ldSc7XG4gICAgICAgIH1cblxuICAgICAgICBpZihjb250ZW50ICE9PSAnJyAmJiB6aWx2ZXJjbXMuZ2V0Q29va2llKCdsYW5ndWFnZXN3aXRjaCcpID09PSAnJykge1xuICAgICAgICAgICAgJCgnLmpzLWxhbmd1YWdlc3dpdGNoJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgJHN3aXRjaCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyICRidXR0b24gPSAkc3dpdGNoLmZpbmQoJy5qcy1sYW5ndWFnZXN3aXRjaC1idXR0b24nKTtcbiAgICAgICAgICAgICAgICB2YXIgJGNsb3NlID0gJHN3aXRjaC5maW5kKCcuanMtbGFuZ3VhZ2Vzd2l0Y2gtY2xvc2UnKTtcbiAgICAgICAgICAgICAgICB2YXIgJGNvbnRlbnQgPSAkc3dpdGNoLmZpbmQoJy5qcy1sYW5ndWFnZXN3aXRjaC1jb250ZW50Jyk7XG4gICAgICAgICAgICAgICAgdmFyICRmbGFnID0gJHN3aXRjaC5maW5kKCcuanMtbGFuZ3VhZ2Vzd2l0Y2gtZmxhZycpO1xuXG4gICAgICAgICAgICAgICAgJGJ1dHRvbi5hdHRyKCdocmVmJywgbGluaykudGV4dChidXR0b24pO1xuICAgICAgICAgICAgICAgICRjb250ZW50Lmh0bWwoY29udGVudCk7XG4gICAgICAgICAgICAgICAgJGZsYWcuYXR0cignc3JjJywgJ2h0dHBzOi8vNjBjYWZjMzNhZjQwYjgyODdmZmItMWEwMzJjMWFmODcxNjBjN2ZjMDFiOWRlOGZkMzIyMWUuc3NsLmNmMy5yYWNrY2RuLmNvbS9mbGFncy8nK2ZsYWcrJy5wbmcnKTtcblxuICAgICAgICAgICAgICAgICRzd2l0Y2guc2xpZGVEb3duKCk7XG5cbiAgICAgICAgICAgICAgICAkY2xvc2Uub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICRzd2l0Y2guc2xpZGVVcCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMuc2V0Q29va2llKCdsYW5ndWFnZXN3aXRjaCcsIHRydWUsIDMwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtbGF6eS1pbWcnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHdyYXBwZXIgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJGltYWdlID0gJHdyYXBwZXIuZmluZCgnaW1nJyk7XG4gICAgICAgIHZhciBpbWFnZSA9ICRpbWFnZS5kYXRhKCdzcmMnKTtcbiAgICAgICAgdmFyIGhlaWdodCA9ICR3cmFwcGVyLm91dGVySGVpZ2h0KCk7XG4gICAgICAgIHZhciB3aWR0aCA9ICR3cmFwcGVyLm91dGVyV2lkdGgoKTtcbiAgICAgICAgdmFyIHBpeGVsUmF0aW8gPSAod2luZG93LmRldmljZVBpeGVsUmF0aW8gPiAxKSA/IDIgOiAxO1xuICAgICAgICB2YXIgb3B0aW9ucyA9IChNYXRoLmNlaWwod2lkdGgpICogcGl4ZWxSYXRpbyArICd4JyArIE1hdGguY2VpbChoZWlnaHQpICogcGl4ZWxSYXRpbyk7XG4gICAgICAgICRpbWFnZS5hdHRyKCdzcmMnLCB6aWx2ZXJjbXMuaW1hZ2VIZWxwZXIoaW1hZ2UsIG9wdGlvbnMpKTtcbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLW1haW5tZW51LXRvZ2dsZScpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkdG9nZ2xlID0gJCh0aGlzKTtcbiAgICAgICAgdmFyICRib2R5ID0gJCgnaHRtbCcpO1xuICAgICAgICB2YXIgY2xhc3NOYW1lID0gJ21haW5tZW51LW9wZW4nO1xuXG4gICAgICAgICR0b2dnbGUub24oJ2NsaWNrLm1haW5tZW51JywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZigkYm9keS5oYXNDbGFzcyhjbGFzc05hbWUpKSB7XG4gICAgICAgICAgICAgICAgJGJvZHkucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTtcbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMudW5sb2NrQm9keSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAkYm9keS5hZGRDbGFzcyhjbGFzc05hbWUpO1xuICAgICAgICAgICAgICAgIHppbHZlcmNtcy5sb2NrQm9keSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtbWljcm9jYXJ0JykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRjYXJ0ID0gJCh0aGlzKSxcbiAgICAgICAgICAgICR0b2dnbGUgPSAkKCcuanMtbWljcm9jYXJ0LXRvZ2dsZScpLFxuICAgICAgICAgICAgJGNsb3NlID0gJCgnLmpzLW1pY3JvY2FydC1jbG9zZScpLFxuICAgICAgICAgICAgJGxvYWRpbmcgPSAkKCcuanMtbWljcm9jYXJ0LWxvYWRpbmcnKSxcbiAgICAgICAgICAgICRwcm9kdWN0cyA9ICQoJy5qcy1taWNyb2NhcnQtcHJvZHVjdHMnKTtcblxuICAgICAgICAkY2xvc2Uub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICR0b2dnbGUudHJpZ2dlcignY2xpY2snKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgd2luZG93LnVwZGF0ZU1pY3JvY2FydCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAkbG9hZGluZy5hZGRDbGFzcygnbG9hZGluZy1pY29uJyk7XG5cbiAgICAgICAgICAgIC8vIEN1cnJlbnQgcHJvZHVjdCBwcm9wZXJ0aWVzLCBpZiBhbnlcbiAgICAgICAgICAgIHZhciAkcHJvZHVjdEZvcm0gPSAkKCcucHJvZHVjdC1mb3JtJyk7XG4gICAgICAgICAgICBpZigkcHJvZHVjdEZvcm0pIHtcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFByb2R1Y3RJZCA9IHBhcnNlSW50KCRwcm9kdWN0Rm9ybS5maW5kKCdpbnB1dFtuYW1lPVwicHJvZHVjdGtleVwiXScpLnZhbCgpKTtcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFByb2R1Y3RNYXhDb3VudCA9ICRwcm9kdWN0Rm9ybS5maW5kKCcuanMtcHJvZHVjdC1jb3VudCcpLmRhdGEoJ21heCcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAkLmdldEpTT04oJy9iamF4L3dlYnNob3AvR2V0b2JqZWN0YXNqc29uL2NhcnQvJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIGlmKGRhdGEuaXRlbWNvdW50ID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAkY2FydC5yZW1vdmVDbGFzcygnbWljcm9jYXJ0LS1lbXB0eScpO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBpdGVtY291bnQgPSBkYXRhLml0ZW1jb3VudDtcblxuICAgICAgICAgICAgICAgICAgICBpZihpdGVtY291bnQgPiA0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1jb3VudCA9IDQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgJHRvZ2dsZS5kYXRhKCdhbW91bnQnLCBkYXRhLml0ZW1jb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQtaXRlbXMtc2hvd24nKS50ZXh0KGl0ZW1jb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQtaXRlbXMtdG90YWwnKS50ZXh0KGRhdGEuaXRlbWNvdW50KTtcbiAgICAgICAgICAgICAgICAgICAgJCgnLmpzLW1pY3JvY2FydC1zdWJ0b3RhbCcpLmh0bWwoemlsdmVyY21zLmN1cnJlbmN5SGVscGVyKGRhdGEuc3VidG90YWwpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuc2hpcHBpbmcgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQtc2hpcHBpbmcnKS5hZGRDbGFzcygndGV4dC1zdWNjZXNzJykudGV4dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCh0aGlzKS5kYXRhKCd0cmFuc2xhdGlvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcuanMtbWljcm9jYXJ0LXNoaXBwaW5nJykuaHRtbCh6aWx2ZXJjbXMuY3VycmVuY3lIZWxwZXIoZGF0YS5zaGlwcGluZykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQtdG90YWwnKS5odG1sKHppbHZlcmNtcy5jdXJyZW5jeUhlbHBlcihkYXRhLnRvdGFsKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzLmVtcHR5KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGRhdGEuaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtSWQgPSBkYXRhLml0ZW1zW2ldLnByb2R1Y3RfaWQ7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBjdXJyZW50UHJvZHVjdElkICE9PSAndW5kZWZpbmVkJyAmJiBjdXJyZW50UHJvZHVjdElkID09PSBpdGVtSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbUNvdW50ID0gcGFyc2VJbnQoZGF0YS5pdGVtc1tpXS5jb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXRlbUNvdW50ID49IGN1cnJlbnRQcm9kdWN0TWF4Q291bnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RGb3JtLmZpbmQoJy5qcy1wcm9kdWN0LWNvdW50JykudmFsKDApLmF0dHIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEtbWluJzogMCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhLW1heCc6IDBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0Rm9ybS5maW5kKCdidXR0b25bdHlwZT1cInN1Ym1pdFwiXScpLmF0dHIoJ2Rpc2FibGVkJywgJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RGb3JtLmZpbmQoJy5qcy1wcm9kdWN0LWNvdW50JykuYXR0cignZGF0YS1tYXgnLCAoY3VycmVudFByb2R1Y3RNYXhDb3VudCAtIGl0ZW1Db3VudCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoaSA8IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMuYXBwZW5kKCc8YSBocmVmPVwiJytkYXRhLml0ZW1zW2ldLnByb2R1Y3RfdXJsKydcIj48aW1nIHNyYz1cIicremlsdmVyY21zLmltYWdlSGVscGVyKGRhdGEuaXRlbXNbaV0uaW1hZ2VfdXJsLCAnMTAweDEwMCxmaXQnKSsnXCIgYWx0PVwiJytkYXRhLml0ZW1zW2ldLm5hbWUrJ1wiPjxzdHJvbmc+JytkYXRhLml0ZW1zW2ldLmNvdW50Kyd4ICZuYnNwO3wmbmJzcDsnK3ppbHZlcmNtcy5jdXJyZW5jeUhlbHBlcihkYXRhLml0ZW1zW2ldLmN1cnJlbnRfcHJpY2UpKyc8L3N0cm9uZz48L2E+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgJGNhcnQucmVtb3ZlQ2xhc3MoJ21pY3JvY2FydC0tZW1wdHknKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkY2FydC5hZGRDbGFzcygnbWljcm9jYXJ0LS1lbXB0eScpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQtdG9nZ2xlLWNvdW50JykudGV4dChkYXRhLml0ZW1jb3VudCk7XG4gICAgICAgICAgICAgICAgJCgnLmpzLW1pY3JvY2FydC10b2dnbGUtcHJvZHVjdHMnKS5odG1sKHppbHZlcmNtcy5jdXJyZW5jeUhlbHBlcihkYXRhLnRvdGFsKSk7XG5cbiAgICAgICAgICAgICAgICAkbG9hZGluZy5yZW1vdmVDbGFzcygnbG9hZGluZy1pY29uJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICB9KTtcbn0pO1xuIiwiJCgnLmpzLW1vZGFsJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICB2YXIgJHRyaWdnZXIgPSAkKHRoaXMpO1xuXG4gICAgJHRyaWdnZXIub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgdmFyIG1vZGFsID0gJHRyaWdnZXIuZGF0YSgnbW9kYWwnKTtcbiAgICAgICAgdmFyICRtb2RhbCA9ICQobW9kYWwpO1xuXG4gICAgICAgIGlmKCRtb2RhbC5pcygndGVtcGxhdGUnKSkge1xuICAgICAgICAgICAgdmFyIGlkZW50aWZpZXIgPSAkbW9kYWwuYXR0cignaWQnKTtcbiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9ICRtb2RhbC5odG1sKCk7XG4gICAgICAgICAgICB2YXIgJHRlbXBsYXRlID0gJCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgICAkdGVtcGxhdGUuYXR0cignaWQnLCBpZGVudGlmaWVyKS5hcHBlbmRUbygnYm9keScpLm1vZGFsKCdzaG93Jyk7XG4gICAgICAgICAgICAkbW9kYWwucmVtb3ZlKCk7XG5cbiAgICAgICAgICAgICR0ZW1wbGF0ZS5maW5kKCdmb3JtLmpzLXZhbGlkYXRpb24nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICQudmFsaWRhdG9yLmZvcm1WYWxpZGF0aW9uKHRoaXMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAkbW9kYWwubW9kYWwoJ3Nob3cnKTtcbiAgICAgICAgfVxuICAgIH0pO1xufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtb3JkZXInKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJG9yZGVyID0gJCh0aGlzKTtcbiAgICAgICAgdmFyICRzZWxlY3QgPSAkb3JkZXIuZmluZCgnLmpzLW9yZGVyLXNlbGVjdCcpO1xuICAgICAgICB2YXIgJHNlbGVjdFdyYXBwZXIgPSAkc2VsZWN0LnBhcmVudCgpO1xuICAgICAgICB2YXIgJGlucHV0ID0gJG9yZGVyLmZpbmQoJy5qcy1vcmRlci1pbnB1dCcpO1xuICAgICAgICB2YXIgJGJ1dHRvbiA9ICRvcmRlci5maW5kKCcuanMtb3JkZXItYnV0dG9uJyk7XG4gICAgICAgIHZhciBmaWVsZE5hbWUgPSAkc2VsZWN0LmF0dHIoJ25hbWUnKTtcbiAgICAgICAgdmFyIGFqYXhTdWJtaXQgPSAkb3JkZXIuZGF0YSgnYWpheC1zdWJtaXQnKTtcbiAgICAgICAgdmFyICRhZGRUb0NhcnQgPSAkKCcuanMtYWRkLXRvLWNhcnQnKTtcblxuICAgICAgICAkc2VsZWN0Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmKCRzZWxlY3QudmFsKCkgPT09ICdtb3JlJykge1xuICAgICAgICAgICAgICAgICRzZWxlY3RXcmFwcGVyLmhpZGUoKVxuICAgICAgICAgICAgICAgICRzZWxlY3QucmVtb3ZlQXR0cignbmFtZScpO1xuICAgICAgICAgICAgICAgICRpbnB1dC5yZW1vdmVDbGFzcygnZC1ub25lJykuc2hvdygpLmF0dHIoJ25hbWUnLCBmaWVsZE5hbWUpLm9uKCdibHVyJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKCRpbnB1dC52YWwoKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzZWxlY3RXcmFwcGVyLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzZWxlY3QuYXR0cignbmFtZScsIGZpZWxkTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0LmZpbmQoJ29wdGlvbicpLmZpcnN0KCkucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5oaWRlKCkucmVtb3ZlQXR0cignbmFtZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG9yZGVyLnJlbW92ZUF0dHIoJ2RhdGEtZXJyb3InKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlci5wYXJlbnRzKCcucHJvZHVjdGJsb2NrJykucmVtb3ZlQXR0cignZGF0YS1lcnJvcicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpZighL2lQaG9uZXxpUGFkfGlQb2QvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICRpbnB1dC5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgJG9yZGVyLm9uKCdzdWJtaXQnLCBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgLy8gRXh0cmEgY2hlY2sgaWYgdmFsaWRhdGlvbiBpcyBhY3RpdmVcbiAgICAgICAgICAgIGlmKCEkb3JkZXIudmFsaWQoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyICRtaWNyb2NhcnQgPSAkKCcuanMtbWljcm9jYXJ0LXRvZ2dsZTp2aXNpYmxlJyk7XG4gICAgICAgICAgICAkYnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cbiAgICAgICAgICAgIGlmKCEhYWpheFN1Ym1pdCkge1xuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgICAgICB2YXIgY291bnQgPSAkb3JkZXIuZmluZCgnKltuYW1lPVwiY291bnRcIl0nKS52YWwoKTtcbiAgICAgICAgICAgICAgICB2YXIgcGlkID0gJG9yZGVyLmZpbmQoJypbbmFtZT1cInByb2R1Y3RrZXlcIl0nKS52YWwoKTtcblxuXG4gICAgICAgICAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLFxuICAgICAgICAgICAgICAgICAgICB1cmw6ICcvY2FydD9hamF4PXRydWUmcGlkPScgKyBwaWQgKyAnJnF0bj0nICsgY291bnQsXG4gICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6ICRvcmRlci5zZXJpYWxpemUoKSxcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy51cGRhdGVNaWNyb2NhcnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5qcy1taWNyb2NhcnQnKS5yZW1vdmVDbGFzcygnbWljcm9jYXJ0LS1lbXB0eScpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihhamF4U3VibWl0ID09PSAnc21hbGwnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJ1dHRvbi5hZGRDbGFzcygnY2hlY2ttYXJrJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighJCgnYm9keScpLmhhc0NsYXNzKCdtb2RhbC1vcGVuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJG1pY3JvY2FydC5hZGRDbGFzcygnb3BlbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24ucmVtb3ZlQ2xhc3MoJ2NoZWNrbWFyaycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDUwMDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkYWRkVG9DYXJ0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjb3VudCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkYWRkVG9DYXJ0Q291bnQgPSAkYWRkVG9DYXJ0LmZpbmQoJy5qcy1hZGQtdG8tY2FydC1jb3VudCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRhZGRUb0NhcnRQcmljZSA9ICRhZGRUb0NhcnQuZmluZCgnLmpzLWFkZC10by1jYXJ0LXByaWNlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGxhaW5TaW5nbGVQcmljZSA9ICRhZGRUb0NhcnRQcmljZS5kYXRhKCdwbGFpbi1wcmljZScpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWRkVG9DYXJ0Q291bnQudGV4dChjb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWRkVG9DYXJ0UHJpY2UuaHRtbCh6aWx2ZXJjbXMuY3VycmVuY3lIZWxwZXIocGxhaW5TaW5nbGVQcmljZSAqIGNvdW50KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5yZXNwb25zZVRleHQudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhZGRUb0NhcnQuZmluZCgnLmpzLW9yZGVyLWluZm8nKS5odG1sKHJlc3BvbnNlLnJlc3BvbnNlVGV4dC50cmltKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmpzLWFkZC10by1jYXJ0LXRyaWdnZXInKS5jbGljaygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRtaWNyb2NhcnQuYWRkQ2xhc3MoJ29wZW4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB3aW5kb3cucHJvZHVjdERldGFpbHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiB3aW5kb3cuZGF0YUxheWVyID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3REZXRhaWxzLnF1YW50aXR5ID0gY291bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUxheWVyLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogJ2FkZFRvQ2FydCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVjb21tZXJjZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVuY3lDb2RlOiAnRVVSJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3RzOiBbcHJvZHVjdERldGFpbHNdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLXBhZ2luYXRpb24nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHBhZ2luYXRpb24gPSAkKHRoaXMpO1xuICAgICAgICBcbiAgICAgICAgJHBhZ2luYXRpb24ub24oJ2luaXQnLCBmdW5jdGlvbihldmVudCwgc2xpY2spIHtcblxuICAgICAgICB9KS5vbignYmVmb3JlQ2hhbmdlJywgZnVuY3Rpb24oZXZlbnQsIHNsaWNrLCBjdXJyZW50U2xpZGUsIG5leHRTbGlkZSkge1xuICAgICAgICAgICAgaWYoc2xpY2suJHNsaWRlci5kYXRhKCdwYWdpbmF0aW9uLXNjcm9sbCcpKSB7XG4gICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmFuaW1hdGUoe1xuICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb3A6IChzbGljay4kc2xpZGVyLnBhcmVudCgpLm9mZnNldCgpLnRvcCAtIDEwMCkgKyAncHgnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkcGFnaW5hdGlvbi50b2dnbGVDbGFzcygnbGFzdCcsICgoc2xpY2suc2xpZGVDb3VudCAtIDEpID09PSBuZXh0U2xpZGUpKTtcbiAgICAgICAgfSkub24oJ2FmdGVyQ2hhbmdlJywgZnVuY3Rpb24oZXZlbnQsIHNsaWNrLCBjdXJyZW50U2xpZGUpIHtcbiAgICAgICAgICAgICRwYWdpbmF0aW9uLm5leHQoJy5qcy1wYWdpbmF0aW9uLW5hdmlnYXRpb24nKS5maW5kKCcuanMtcGFnaW5hdGlvbi1wcmV2JykudG9nZ2xlQ2xhc3MoJ2Rpc2FibGVkJywgKHNsaWNrLmN1cnJlbnRTbGlkZSA9PT0gMCkpO1xuICAgICAgICAgICAgJHBhZ2luYXRpb24ubmV4dCgnLmpzLXBhZ2luYXRpb24tbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1wYWdpbmF0aW9uLW5leHQnKS50b2dnbGVDbGFzcygnZGlzYWJsZWQnLCAoKHNsaWNrLmN1cnJlbnRTbGlkZSArIDEpID09PSBzbGljay5zbGlkZUNvdW50KSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRwYWdpbmF0aW9uLnNsaWNrKHtcbiAgICAgICAgICAgIGFkYXB0aXZlSGVpZ2h0OiB0cnVlLFxuICAgICAgICAgICAgYXBwZW5kRG90czogJHBhZ2luYXRpb24ubmV4dCgnLmpzLXBhZ2luYXRpb24tbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1wYWdpbmF0aW9uLWRvdHMnKSxcbiAgICAgICAgICAgIGFycm93czogdHJ1ZSxcbiAgICAgICAgICAgIGRvdHM6IHRydWUsXG4gICAgICAgICAgICBkb3RzQ2xhc3M6ICdwYWdpbmF0aW9uX19udW1iZXJzJyxcbiAgICAgICAgICAgIGluZmluaXRlOiBmYWxzZSxcbiAgICAgICAgICAgIG5leHRBcnJvdzogJHBhZ2luYXRpb24ubmV4dCgnLmpzLXBhZ2luYXRpb24tbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1wYWdpbmF0aW9uLW5leHQnKSxcbiAgICAgICAgICAgIHByZXZBcnJvdzogJHBhZ2luYXRpb24ubmV4dCgnLmpzLXBhZ2luYXRpb24tbmF2aWdhdGlvbicpLmZpbmQoJy5qcy1wYWdpbmF0aW9uLXByZXYnKSxcbiAgICAgICAgICAgIHN3aXBlOiB6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ21kJyksXG4gICAgICAgICAgICB2YXJpYWJsZVdpZHRoOiAkcGFnaW5hdGlvbi5kYXRhKCdwYWdpbmF0aW9uLXZhcmlhYmxlLXdpZHRoJylcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgIHZhciAkcGlja3VwTG9jYXRpb24gPSAkKCcuanMtcGlja3VwLWxvY2F0aW9uJyk7XG4gICAgdmFyICR0aW1lZnJhbWUgPSAkKCcuanMtdGltZWZyYW1lJyk7XG5cbiAgICB2YXIgcmVjaWV2ZVBpY2t1cExvY2F0aW9ucyA9IGZ1bmN0aW9uKHppcGNvZGUpIHtcbiAgICAgICAgaWYoL15bMS05XVswLTldezN9XFxzP1thLXpBLVpdezJ9JC8udGVzdCh6aXBjb2RlKSkge1xuICAgICAgICAgICAgdmFyICRzZWxlY3QgPSAkKCcuanMtcGlja3VwLWxvY2F0aW9uLXNlbGVjdCcpO1xuICAgICAgICAgICAgJHNlbGVjdC5wYXJlbnQoKS5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgJCgnLmpzLXBpY2t1cC1sb2NhdGlvbi1zZWxlY3QtbGFiZWwnKS50ZXh0KCdBZmhhYWxwdW50ZW4gb3BoYWxlbi4uLicpO1xuICAgICAgICAgICAgJHBpY2t1cExvY2F0aW9uLnBhcmVudCgpLnJlbW92ZUF0dHIoJ2RhdGEtZXJyb3InKTtcblxuICAgICAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgICAgIHVybDogJy9iamF4L3Bvc3RubC9nZXROZWFyZXN0TG9jYXRpb25zLycsXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICB6aXBjb2RlOiB6aXBjb2RlLFxuICAgICAgICAgICAgICAgICAgICBjb3VudHJ5Q29kZTogJ05MJyxcbiAgICAgICAgICAgICAgICAgICAgc2hpcHBpbmdNZXRob2RJZDogJCgnLmpzLWNoZWNrb3V0JykuZGF0YSgnc2hpcHBpbmdtZXRob2QtaWQnKVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGpzb24pIHtcbiAgICAgICAgICAgICAgICAgICAgJHNlbGVjdC5vZmYoJ2NoYW5nZS5zZWxlY3RQaWNrdXBQb2ludCcpO1xuICAgICAgICAgICAgICAgICAgICAkc2VsZWN0LmVtcHR5KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoJHNlbGVjdC5oYXNDbGFzcygnc2VsZWN0Mi1oaWRkZW4tYWNjZXNzaWJsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0LnNlbGVjdDIoJ2Rlc3Ryb3knKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICQuZWFjaChqc29uLmxvY2F0aW9ucywgZnVuY3Rpb24oaSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3RhbmNlID0gcGFyc2VJbnQodGhpcy5kaXN0YW5jZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihkaXN0YW5jZSA8IDEwMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzdGFuY2VUZXh0ID0gJzwgMSBrbSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZVJvdW5kZWQgPSBNYXRoLnJvdW5kKGRpc3RhbmNlLzEwMCkvMTA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3RhbmNlVGV4dCA9IGRpc3RhbmNlUm91bmRlZC50b1N0cmluZygpLnJlcGxhY2UoJy4nLCAnLCcpICsgJyBrbSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkb3B0aW9uID0gJCgnPG9wdGlvbi8+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9uLnZhbCh0aGlzLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi50ZXh0KFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUgKyAnLCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRyZXNzLnN0cmVldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZHJlc3MuaG91c2VOcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZHJlc3MuY2l0eSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnKCcgKyBkaXN0YW5jZVRleHQgKyAnKSdcbiAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbignICcpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5hdHRyKCdkYXRhLWxvY2F0aW9uLW5hbWUnLCB0aGlzLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5hdHRyKCdkYXRhLWxvY2F0aW9uLXN0cmVldCcsIHRoaXMuYWRkcmVzcy5zdHJlZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5hdHRyKCdkYXRhLWxvY2F0aW9uLXN0cmVldG5yJywgdGhpcy5hZGRyZXNzLmhvdXNlTnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5hdHRyKCdkYXRhLWxvY2F0aW9uLXppcGNvZGUnLCB0aGlzLmFkZHJlc3MuemlwY29kZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9uLmF0dHIoJ2RhdGEtbG9jYXRpb24tY2l0eScsIHRoaXMuYWRkcmVzcy5jaXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb24uYXR0cignZGF0YS1sb2NhdGlvbi1jb3VudHJ5JywgdGhpcy5hZGRyZXNzLmNvdW50cnlDb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb24uYXR0cignZGF0YS1sb2NhdGlvbi1kaXN0YW5jZScsIGRpc3RhbmNlVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9uLmF0dHIoJ2RhdGEtbG9jYXRpb24tbGFiZWwnLCBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lICsgJzxicj4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkcmVzcy5zdHJlZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRyZXNzLmhvdXNlTnIgKyAnLCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRyZXNzLmNpdHlcbiAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbignICcpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGVjdC5hcHBlbmQoJG9wdGlvbikudmFsaWQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgJHNlbGVjdC5vbignY2hhbmdlLnNlbGVjdFBpY2t1cFBvaW50JywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdGVkID0gJHNlbGVjdC5maW5kKCdvcHRpb246c2VsZWN0ZWQnKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmpzLXBpY2t1cC1sb2NhdGlvbi1zdHJlZXQnKS52YWwoJHNlbGVjdGVkLmF0dHIoJ2RhdGEtbG9jYXRpb24tc3RyZWV0JykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmpzLXBpY2t1cC1sb2NhdGlvbi1zdHJlZXRucicpLnZhbCgkc2VsZWN0ZWQuYXR0cignZGF0YS1sb2NhdGlvbi1zdHJlZXRucicpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5qcy1waWNrdXAtbG9jYXRpb24temlwY29kZScpLnZhbCgkc2VsZWN0ZWQuYXR0cignZGF0YS1sb2NhdGlvbi16aXBjb2RlJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmpzLXBpY2t1cC1sb2NhdGlvbi1jaXR5JykudmFsKCRzZWxlY3RlZC5hdHRyKCdkYXRhLWxvY2F0aW9uLWNpdHknKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcuanMtcGlja3VwLWxvY2F0aW9uLWNvdW50cnknKS52YWwoJHNlbGVjdGVkLmF0dHIoJ2RhdGEtbG9jYXRpb24tY291bnRyeScpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5qcy1zdW1tYXJ5LXBpY2t1cCcpLmh0bWwoJHNlbGVjdGVkLmF0dHIoJ2RhdGEtbG9jYXRpb24tbGFiZWwnKSkucGFyZW50KCd0cicpLmZhZGVJbigpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAkc2VsZWN0LnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgICAgICAgICAgICAgICAgICAkc2VsZWN0LnBhcmVudCgpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJy5qcy1waWNrdXAtbG9jYXRpb24tc2VsZWN0LWxhYmVsJykudGV4dCgnU2VsZWN0ZWVyIGFmaGFhbHB1bnQnKTtcblxuICAgICAgICAgICAgICAgICAgICBpZih6aWx2ZXJjbXMudmlld3BvcnQuaXNHcmVhdGVyVGhhbigneHMnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGVjdC5zZWxlY3QyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd0h0bWw6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWU6ICdmbGF0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVJlc3VsdDogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJG9wdGlvbiA9ICQoZGF0YS5lbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBkYXRhLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyZWV0ID0gJG9wdGlvbi5kYXRhKCdsb2NhdGlvbi1zdHJlZXQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0cmVldG5yID0gJG9wdGlvbi5kYXRhKCdsb2NhdGlvbi1zdHJlZXRucicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2l0eSA9ICRvcHRpb24uZGF0YSgnbG9jYXRpb24tY2l0eScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzdGFuY2UgPSAkb3B0aW9uLmRhdGEoJ2xvY2F0aW9uLWRpc3RhbmNlJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld09wdGlvbiA9IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImZsb2F0LXJpZ2h0XCI+JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0ZXh0IHNtYWxsIG11dGVkXCI+JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWV0ICsgJyAnICsgc3RyZWV0bnIgKyAnLCAnICsgY2l0eSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkKG5ld09wdGlvbi5qb2luKCcnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNlbGVjdGlvbjogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJG9wdGlvbiA9ICQoZGF0YS5lbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBkYXRhLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyZWV0ID0gJG9wdGlvbi5kYXRhKCdsb2NhdGlvbi1zdHJlZXQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0cmVldG5yID0gJG9wdGlvbi5kYXRhKCdsb2NhdGlvbi1zdHJlZXRucicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2l0eSA9ICRvcHRpb24uZGF0YSgnbG9jYXRpb24tY2l0eScpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdPcHRpb24gPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdj4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwidGV4dCBtdXRlZCBtbC0zXCI+JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWV0ICsgJyAnICsgc3RyZWV0bnIgKyAnLCAnICsgY2l0eSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9zcGFuPicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJChuZXdPcHRpb24uam9pbignJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oWE1MSHR0cFJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgJHBpY2t1cExvY2F0aW9uLnBhcmVudCgpLmF0dHIoJ2RhdGEtZXJyb3InLCAnS29uIGdlZW4gYmVzY2hpa2JhcmUgYWZoYWFscHVudGVuIHZpbmRlbiwgZ2VicnVpayBlZW4gYW5kZXJlIHBvc3Rjb2RlLicpO1xuICAgICAgICAgICAgICAgICAgICAkKCcuanMtcGlja3VwLWxvY2F0aW9uLXNlbGVjdC1sYWJlbCcpLnRleHQoJ1NlbGVjdGVlciBhZmhhYWxwdW50Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAkKCcuanMtcGlja3VwLWxvY2F0aW9uJykucGFyZW50KCkuXG4gICAgICAgICAgICAgICAgcmVtb3ZlQXR0cignZGF0YS1zdWNjZXNzJykuXG4gICAgICAgICAgICAgICAgYXR0cignZGF0YS1lcnJvcicsICdWdWwgZWVuIGdlbGRpZ2UgcG9zdGNvZGUgaW4sIGJpanY6IDEyMzRBQicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFyIHJlc2V0VGltZWZyYW1lcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHNlbGVjdERhdGUgPSAkKCcuanMtdGltZWZyYW1lJyk7XG4gICAgICAgIHZhciAkc2VsZWN0T3B0aW9uID0gJCgnLmpzLXRpbWVmcmFtZS1vcHRpb25zJyk7XG4gICAgICAgIHZhciAkc3VtbWFyeURhdGUgPSAkKCcuanMtc3VtbWFyeS10aW1lZnJhbWUtZGF0ZScpO1xuICAgICAgICB2YXIgJHN1bW1hcnlPcHRpb24gPSAkKCcuanMtc3VtbWFyeS10aW1lZnJhbWUtb3B0aW9uJyk7XG4gICAgICAgIHZhciAkZW1wdHlPcHRpb24gPSAkKCc8b3B0aW9uLz4nKS50ZXh0KCdLaWVzIGVlcnN0IGVlbiBiZXpvcmdkYXR1bScpLnZhbCgnJyk7XG5cbiAgICAgICAgJHNlbGVjdERhdGUucmVtb3ZlQXR0cignbmFtZScpO1xuXG4gICAgICAgICRzZWxlY3RPcHRpb24uaHRtbCgkZW1wdHlPcHRpb24pLnJlbW92ZUF0dHIoJ25hbWUnKTtcbiAgICAgICAgJHNlbGVjdE9wdGlvbi5wYXJlbnQoKS5hZGRDbGFzcygnbG9hZGluZycpO1xuXG4gICAgICAgICRzdW1tYXJ5RGF0ZS5wYXJlbnRzKCd0cicpLmZhZGVPdXQoKTtcbiAgICAgICAgJHN1bW1hcnlPcHRpb24ucGFyZW50cygndHInKS5mYWRlT3V0KCk7XG4gICAgICAgICRzdW1tYXJ5RGF0ZS5lbXB0eSgpO1xuICAgICAgICAkc3VtbWFyeU9wdGlvbi5lbXB0eSgpO1xuXG4gICAgICAgIHVwZGF0ZVN1bW1hcnlQcmljZSgnc2hpcHBpbmdjb3N0JywgMCk7XG4gICAgICAgIHVwZGF0ZVN1bW1hcnlQcmljZSgncHJpY2UnLCAwKTtcbiAgICB9XG5cbiAgICB2YXIgcmVjaWV2ZVRpbWVmcmFtZXMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHppcGNvZGUgPSAkKCcuanMtYWRkcmVzcy16aXBjb2RlOnZpc2libGUnKS5sYXN0KCkudmFsKCk7XG4gICAgICAgIHZhciBzdHJlZXRuciA9ICQoJy5qcy1hZGRyZXNzLXN0cmVldG5yOnZpc2libGUnKS5sYXN0KCkudmFsKCk7XG5cbiAgICAgICAgaWYoemlwY29kZSAhPSAnJyAmJiAvXlsxLTldWzAtOV17M31cXHM/W2EtekEtWl17Mn0kLy50ZXN0KHppcGNvZGUpICYmIHN0cmVldG5yICE9ICcnKSB7XG4gICAgICAgICAgICB2YXIgJHNlbGVjdERhdGUgPSAkKCcuanMtdGltZWZyYW1lJyk7XG4gICAgICAgICAgICB2YXIgJHNlbGVjdE9wdGlvbiA9ICQoJy5qcy10aW1lZnJhbWUtb3B0aW9ucycpO1xuICAgICAgICAgICAgdmFyICRzdW1tYXJ5RGF0ZSA9ICQoJy5qcy1zdW1tYXJ5LXRpbWVmcmFtZS1kYXRlJyk7XG4gICAgICAgICAgICB2YXIgJHN1bW1hcnlPcHRpb24gPSAkKCcuanMtc3VtbWFyeS10aW1lZnJhbWUtb3B0aW9uJyk7XG5cbiAgICAgICAgICAgICQuYWpheCh7XG4gICAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICB1cmw6ICcvYmpheC9wb3N0bmwvR2V0QXZhaWxhYmxlVGltZUZyYW1lcy8nLFxuICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgemlwY29kZTogemlwY29kZSxcbiAgICAgICAgICAgICAgICAgICAgaG91c2VOdW1iZXI6IHN0cmVldG5yLFxuICAgICAgICAgICAgICAgICAgICBjb3VudHJ5Q29kZTogJ05MJyxcbiAgICAgICAgICAgICAgICAgICAgc2hpcHBpbmdNZXRob2RJZDogMVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGpzb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWVmcmFtZXMgPSBqc29uLmF2YWlsYWJsZV90aW1lcy50aW1lRnJhbWVzO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGF0ZU9wdGlvbnMgPSB7fTtcblxuICAgICAgICAgICAgICAgICAgICAkc2VsZWN0RGF0ZS52YWwoJycpLmZpbmQoJy5qcy10aW1lZnJhbWUtZGF5JykucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc2V0VGltZWZyYW1lcygpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKHRpbWVmcmFtZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2godGltZWZyYW1lcywgZnVuY3Rpb24oaSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRlID0gdGhpcy5kYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYob3B0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWRhdGVPcHRpb25zW2RhdGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlT3B0aW9uc1tkYXRlXSA9IFtdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJG9wdGlvbiA9ICQoJzxvcHRpb24vPicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi52YWwodGhpcy5kYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb24udGV4dChbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRlRGF5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0ZU5vWWVhcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbignICcpKS5hZGRDbGFzcygnanMtdGltZWZyYW1lLWRheScpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0RGF0ZS5hcHBlbmQoJG9wdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlT3B0aW9uc1tkYXRlXS5wdXNoKG9wdGlvbnNbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0RGF0ZS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0RGF0ZS5vbignY2hhbmdlLnNlbGVjdERhdGUnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkc2VsZWN0RGF0ZS52YWwoKSA9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNldFRpbWVmcmFtZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0RGF0ZS5hdHRyKCduYW1lJywgJ2RhdGFbdGltZWZyYW1lXVtwcmVmZXJyZWRfc2hpcHBpbmdfZGF0ZV0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGVjdE9wdGlvbi5hdHRyKCduYW1lJywgJ2RhdGFbdGltZWZyYW1lXVtvcHRpb25dJykuZW1wdHkoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN1bW1hcnlEYXRlLnRleHQoJHNlbGVjdERhdGUuZmluZCgnb3B0aW9uOnNlbGVjdGVkJykudGV4dCgpKS5wYXJlbnRzKCd0cicpLmZhZGVJbigpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRlID0gJHNlbGVjdERhdGUudmFsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gZGF0ZU9wdGlvbnNbZGF0ZV07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5lYWNoKG9wdGlvbnMsIGZ1bmN0aW9uKGkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkb3B0aW9uID0gJCgnPG9wdGlvbi8+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSB0aGlzLmxhYmVsO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNoaXBwaW5nID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmljZSA9IHppbHZlcmNtcy5jdXJyZW5jeUhlbHBlcih0aGlzLnNoaXBwaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCArPSAnICgrICcgKyBwcmljZSArICcpJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi52YWwodGhpcy5vcHRpb24pLnRleHQobGFiZWwpLmF0dHIoJ2RhdGEtcHJpY2UnLCB0aGlzLnNoaXBwaW5nKS5hZGRDbGFzcygnanMtdGltZWZyYW1lLW9wdGlvbicpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2VsZWN0T3B0aW9uLmFwcGVuZCgkb3B0aW9uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlU3VtbWFyeVByaWNlKCdzaGlwcGluZ2Nvc3QnLCB0aGlzLnNoaXBwaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVTdW1tYXJ5UHJpY2UoJ3ByaWNlJywgdGhpcy5zaGlwcGluZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzZWxlY3RPcHRpb24ucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGVjdE9wdGlvbi50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGVjdE9wdGlvbi5vbignY2hhbmdlLnNlbGVjdE9wdGlvbicsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZWN0ZWRPcHRpb24gPSAkc2VsZWN0T3B0aW9uLmZpbmQoJ29wdGlvbjpzZWxlY3RlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVN1bW1hcnlQcmljZSgnc2hpcHBpbmdjb3N0JywgJHNlbGVjdGVkT3B0aW9uLmRhdGEoJ3ByaWNlJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVN1bW1hcnlQcmljZSgncHJpY2UnLCAkc2VsZWN0ZWRPcHRpb24uZGF0YSgncHJpY2UnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3VtbWFyeU9wdGlvbi50ZXh0KCRzZWxlY3RlZE9wdGlvbi50ZXh0KCkpLnBhcmVudHMoJ3RyJykuZmFkZUluKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKFhNTEh0dHBSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IFhNTEh0dHBSZXF1ZXN0LnJlc3BvbnNlSlNPTjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHZhciB1cGRhdGVTdW1tYXJ5UHJpY2UgPSBmdW5jdGlvbih0eXBlLCBhZGRpbmdBbW91bnQpIHtcbiAgICAgICAgaWYoIXR5cGUpIHtcbiAgICAgICAgICAgIHR5cGUgPSAncHJpY2UnO1xuICAgICAgICB9XG4gICAgICAgIHZhciAkcHJpY2UgPSAkKCcuanMtc3VtbWFyeS0nK3R5cGUpO1xuICAgICAgICB2YXIgcGxhaW5QcmljZSA9ICRwcmljZS5kYXRhKCdwbGFpbi1wcmljZScpO1xuICAgICAgICB2YXIgdXBkYXRlZFByaWNlID0gcGxhaW5QcmljZSArIGFkZGluZ0Ftb3VudDtcbiAgICAgICAgJHByaWNlLnRleHQoemlsdmVyY21zLmN1cnJlbmN5SGVscGVyKHVwZGF0ZWRQcmljZSkpO1xuICAgIH1cblxuICAgIGlmKCRwaWNrdXBMb2NhdGlvbi5sZW5ndGgpIHtcbiAgICAgICAgaWYoJHBpY2t1cExvY2F0aW9uLnZhbCgpICE9ICcnKSB7XG4gICAgICAgICAgICByZWNpZXZlUGlja3VwTG9jYXRpb25zKCRwaWNrdXBMb2NhdGlvbi52YWwoKSk7XG4gICAgICAgIH1cblxuICAgICAgICAkcGlja3VwTG9jYXRpb24ub24oJ2tleXVwLnBpY2t1cExvY2F0aW9uJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZigkcGlja3VwTG9jYXRpb24udmFsKCkgIT0gJycpIHtcbiAgICAgICAgICAgICAgICByZWNpZXZlUGlja3VwTG9jYXRpb25zKCRwaWNrdXBMb2NhdGlvbi52YWwoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICQoJy5qcy1hZGRyZXNzLXppcGNvZGUnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICR6aXBjb2RlID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgJHppcGNvZGUub24oJ2NoYW5nZS5waWNrdXBMb2NhdGlvbkF1dG9maWxsJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgaWYoJHBpY2t1cExvY2F0aW9uLnZhbCgpID09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciAkc2hpcHBpbmdaaXBjb2RlID0gJCgnLmpzLWFkZHJlc3MtemlwY29kZTp2aXNpYmxlJykubGFzdCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2hpcHBpbmdaaXBjb2RlID0gJHNoaXBwaW5nWmlwY29kZS52YWwoKTtcbiAgICAgICAgICAgICAgICAgICAgJHBpY2t1cExvY2F0aW9uLnZhbChzaGlwcGluZ1ppcGNvZGUpO1xuICAgICAgICAgICAgICAgICAgICByZWNpZXZlUGlja3VwTG9jYXRpb25zKHNoaXBwaW5nWmlwY29kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgICQoJy5qcy1waWNrdXAtdXBkYXRlJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkYnV0dG9uID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgJGJ1dHRvbi5vbignY2xpY2sucGlja3VwTG9jYXRpb25VcGRhdGUnLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHppcGNvZGUgPSAkcGlja3VwTG9jYXRpb24udmFsKCk7XG4gICAgICAgICAgICAgICAgcmVjaWV2ZVBpY2t1cExvY2F0aW9ucyh6aXBjb2RlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKCR0aW1lZnJhbWUubGVuZ3RoKSB7XG4gICAgICAgICQoJy5qcy1hZGRyZXNzLXppcGNvZGUsIC5qcy1hZGRyZXNzLXN0cmVldG5yJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICRhZGRyZXNzID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgcmVjaWV2ZVRpbWVmcmFtZXMoKTtcblxuICAgICAgICAgICAgJGFkZHJlc3Mub24oJ2NoYW5nZS50aW1lZnJhbWVBdXRvZmlsbCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHJlY2lldmVUaW1lZnJhbWVzKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtcGRwLWZpeGVkJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRmaXhlZCA9ICQodGhpcyk7XG5cbiAgICAgICAgaWYoemlsdmVyY21zLnZpZXdwb3J0LmlzRXF1YWxPclNtYWxsZXJUaGFuKCdtZCcpKSB7XG4gICAgICAgICAgICB2YXIgJG9yZGVyID0gJCgnLmpzLXBkcC1vcmRlcjp2aXNpYmxlJyk7XG4gICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gJG9yZGVyLm9mZnNldCgpLnRvcCArICRvcmRlci5oZWlnaHQoKTtcblxuICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdzY3JvbGwnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBpZigkKHRoaXMpLnNjcm9sbFRvcCgpID49IHNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgICAgICAkZml4ZWQuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICAkKCcuanMtd2hhdHNhcHAnKS5hZGRDbGFzcygnaGlnaGVyJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJyNsaXZlLWNoYXQtd2lkZ2V0JykuYWRkQ2xhc3MoJ2hpZGUnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkZml4ZWQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICAkKCcuanMtd2hhdHNhcHAnKS5yZW1vdmVDbGFzcygnaGlnaGVyJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJyNsaXZlLWNoYXQtd2lkZ2V0JykucmVtb3ZlQ2xhc3MoJ2hpZGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgJCgnLmpzLXBkcC1waW50ZXJlc3QnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHBpbnRlcmVzdCA9ICQodGhpcyk7XG4gICAgICAgIHZhciBzY3JvbGxUb3AgPSAkcGludGVyZXN0Lm9mZnNldCgpLnRvcDtcblxuICAgICAgICAkKHdpbmRvdykub24oJ3Njcm9sbC5sb2FkUGludGVyZXN0JywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZigkKHRoaXMpLnNjcm9sbFRvcCgpID49IHNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgIHZhciAkc2NyaXB0ID0gJCgnPHNjcmlwdC8+Jywge1xuICAgICAgICAgICAgICAgICAgICBhc3luYzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgc3JjOiAnLy9hc3NldHMucGludGVyZXN0LmNvbS9qcy9waW5pdC5qcycsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAkcGludGVyZXN0LmFwcGVuZCgkc2NyaXB0KTtcbiAgICAgICAgICAgICAgICAkKHdpbmRvdykub2ZmKCdzY3JvbGwubG9hZFBpbnRlcmVzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG5cdCQoJy5qcy1wcm9kdWN0cy1maWx0ZXInKS5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBuZXdVcmwgPSAkKHRoaXMpLnZhbCgpO1xuXG4gICAgICAgIGlmKHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JTbWFsbGVyVGhhbignc20nKSkge1xuICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ2xvYWRpbmctYXJlYScpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYobmV3VXJsKSB3aW5kb3cubG9jYXRpb24gPSBuZXdVcmw7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9KTtcblxuICAgICQoJy5qcy1wcm9kdWN0cy1hY3RpdmUtZmlsdGVyJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmKHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JTbWFsbGVyVGhhbignc20nKSkge1xuICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ2xvYWRpbmctYXJlYScpO1xuICAgICAgICB9XG5cdH0pO1xuXG4gICAgJCgnLmpzLXByb21vLXlvdXR1YmUnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHZpZGVvID0gJCh0aGlzKTtcbiAgICAgICAgdmFyIHlvdXR1YmVEaXYgPSAkdmlkZW8uZmluZCgnZGl2Jyk7XG4gICAgICAgIHZhciB5b3V0dWJlSWQgPSB5b3V0dWJlRGl2LmF0dHIoJ2lkJykucmVwbGFjZSgnVklERU8tJyAsJycpO1xuXG4gICAgICAgICR2aWRlby5vbignY2xpY2sueXQnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmKHR5cGVvZihZVCkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgJHZpZGVvLmFkZENsYXNzKCdwbGF5aW5nJykub2ZmKCdjbGljay55dCcpO1xuXG4gICAgICAgICAgICAgICAgdmFyIHBsYXllciA9IG5ldyBZVC5QbGF5ZXIoeW91dHViZURpdi5hdHRyKCdpZCcpLCB7XG4gICAgICAgICAgICAgICAgICAgIHZpZGVvSWQ6IHlvdXR1YmVJZCxcbiAgICAgICAgICAgICAgICAgICAgcGxheWVyVmFyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3BsYXk6IDEsXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2Rlc3RicmFuZGluZzogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXlzaW5saW5lOiAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsOiAwXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHBsYXllci5wbGF5VmlkZW8oKTtcbiAgICAgICAgICAgICAgICB9LCAxMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAkKCcuanMtcHJvZHVjdHMtbG9hZG1vcmUnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJGJ1dHRvbiA9ICQodGhpcyk7XG5cbiAgICAgICAgJGJ1dHRvbi5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgIHZhciBjdXJyZW50UGFnZSA9ICRidXR0b24uZGF0YSgnY3VycmVudC1wYWdlJyk7XG4gICAgICAgICAgICB2YXIgbmV4dFBhZ2UgPSBjdXJyZW50UGFnZSArIDE7XG4gICAgICAgICAgICB2YXIgbnVtYmVyT2ZQYWdlcyA9ICRidXR0b24uZGF0YSgnbnVtYmVyLXBhZ2VzJyk7XG5cbiAgICAgICAgICAgIGlmKHR5cGVvZiBVUkxTZWFyY2hQYXJhbXMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICB2YXIgdXJsUGFyYW1ldGVycyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7XG4gICAgICAgICAgICAgICAgdXJsUGFyYW1ldGVycy5zZXQoJ3BhZ2UnLCBuZXh0UGFnZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciB1cmxQYXJhbWV0ZXJzID0gKCdwYWdlPScgKyBuZXh0UGFnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICRidXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmctaWNvbicpO1xuXG4gICAgICAgICAgICAkLmFqYXgoe1xuICAgICAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgJz8nICsgdXJsUGFyYW1ldGVycyxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgJGh0bWwgPSAkKHJlc3VsdCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoJGh0bWwuZmluZCgnLmpzLXByb2R1Y3RzJykubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNjcm9sbFRvcCA9ICQod2luZG93KS5zY3JvbGxUb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9kdWN0cyA9ICRodG1sLmZpbmQoJy5qcy1wcm9kdWN0cycpLmNoaWxkcmVuKCcucHJvZHVjdGJsb2NrX193cmFwcGVyJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5qcy1wcm9kdWN0cycpLmFwcGVuZChwcm9kdWN0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKGN1cnJlbnRTY3JvbGxUb3ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgJGJ1dHRvbi5kYXRhKCdjdXJyZW50LXBhZ2UnLCBuZXh0UGFnZSkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmctaWNvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKCcnLCAnJywgJz8nICsgdXJsUGFyYW1ldGVycyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5leHRQYWdlID49IG51bWJlck9mUGFnZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uT2ZmZXQgPSAkYnV0dG9uLm9mZnNldCgpLnRvcCArIDEwMDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQod2luZG93KS5vZmYoJ3Njcm9sbC5sb2FkTW9yZScpLm9uKCdzY3JvbGwubG9hZE1vcmUnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoKCQod2luZG93KS5zY3JvbGxUb3AoKSArICQod2luZG93KS5vdXRlckhlaWdodCgpKSA+IGJ1dHRvbk9mZmV0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHdpbmRvdykub2ZmKCdzY3JvbGwubG9hZE1vcmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24udHJpZ2dlcignY2xpY2snKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAkKCcuanMtcHJvZHVjdHMtYmFja3RvdG9wJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRidXR0b24gPSAkKHRoaXMpO1xuXG4gICAgICAgICQod2luZG93KS5vbignc2Nyb2xsLmJhY2tUb1RvcCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgJGJ1dHRvbi50b2dnbGVDbGFzcygndmlzaWJsZScsICgkKHRoaXMpLnNjcm9sbFRvcCgpID4gJCh0aGlzKS5vdXRlckhlaWdodCgpKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRidXR0b24ub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkKCdodG1sLCBib2R5JykuYW5pbWF0ZSh7XG4gICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAwXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy1wcm9tb2Jhci1jb3VudGRvd24nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJGNvdW50ZG93biA9ICQodGhpcyk7XG4gICAgICAgIHZhciBjb3VudERvd25EYXRlID0gRGF0ZS5wYXJzZSgkY291bnRkb3duLmF0dHIoJ2RhdGEtZGF0ZScpKTtcblxuICAgICAgICB2YXIgeCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IGNvdW50RG93bkRhdGUgLSBub3c7XG5cbiAgICAgICAgICAgIHZhciBkYXlzID0gTWF0aC5mbG9vcihkaXN0YW5jZSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7XG4gICAgICAgICAgICB2YXIgaG91cnMgPSBNYXRoLmZsb29yKChkaXN0YW5jZSAlICgxMDAwICogNjAgKiA2MCAqIDI0KSkgLyAoMTAwMCAqIDYwICogNjApKTtcbiAgICAgICAgICAgIHZhciBtaW51dGVzID0gTWF0aC5mbG9vcigoZGlzdGFuY2UgJSAoMTAwMCAqIDYwICogNjApKSAvICgxMDAwICogNjApKTtcbiAgICAgICAgICAgIHZhciBzZWNvbmRzID0gTWF0aC5mbG9vcigoZGlzdGFuY2UgJSAoMTAwMCAqIDYwKSkgLyAxMDAwKTtcblxuICAgICAgICAgICAgaWYoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmxhbmcgPT09ICdkZScpIHtcbiAgICAgICAgICAgICAgICAkY291bnRkb3duLmh0bWwoXCJOb2NoIFwiICsgZGF5cyArIChkYXlzID09PSAxID8gXCIgVGFnIFwiIDogXCIgVGFnZSBcIikgKyBob3VycyArIChkYXlzID09PSAxID8gXCIgU3R1bmRlIFwiIDogXCIgU3R1bmRlbiBcIikgKyBtaW51dGVzICsgKG1pbnV0ZXMgPT09IDEgPyBcIiBNaW51dGUgXCIgOiBcIiBNaW51dGVuIFwiKSArIHNlY29uZHMgKyAoc2Vjb25kcyA9PT0gMSA/IFwiIFNla3VuZGUgXCIgOiBcIiBTZWt1bmRlbiBcIikgK1wiIGJpcyB6dW1cIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICRjb3VudGRvd24uaHRtbChcIk5vZyBcIiArIGRheXMgKyAoZGF5cyA9PT0gMSA/IFwiIGRhZyBcIiA6IFwiIGRhZ2VuIFwiKSArIGhvdXJzICsgXCIgdXVyIFwiICsgbWludXRlcyArIChtaW51dGVzID09PSAxID8gXCIgbWludXV0IFwiIDogXCIgbWludXRlbiBcIikgKyBzZWNvbmRzICsgKHNlY29uZHMgPT09IDEgPyBcIiBzZWNvbmRlIFwiIDogXCIgc2Vjb25kZW4gXCIpICtcIiB0b3QgZGVcIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IDApIHtcbiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHgpO1xuICAgICAgICAgICAgICAgICRjb3VudGRvd24uaHRtbCgnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDEwMDApO1xuICAgIH0pO1xuXG4gICAgJCgnLmpzLXByb21vYmFyJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICRwcm9tb2JhciA9ICQodGhpcyk7XG4gICAgICAgIHZhciAkaGVhZGVyID0gJHByb21vYmFyLm5leHQoJy5oZWFkZXJfX3RvcGJhcicpO1xuICAgICAgICAkaGVhZGVyLmNzcygndG9wJywgJHByb21vYmFyLm91dGVySGVpZ2h0KCkpO1xuICAgIH0pO1xufSk7XG4iLCIkKCdib2R5Jykub24oJ3N1Ym1pdCcsICcuanMtcXVlc3Rpb24nLCBmdW5jdGlvbihlKSB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHZhciAkZm9ybSA9ICQodGhpcyk7XG5cbiAgICAvLyBFeHRyYSBjaGVjayBpZiB2YWxpZGF0aW9uIGlzIGFjdGl2ZVxuICAgIGlmKCEkZm9ybS52YWxpZCgpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB2YXIgJGFsZXJ0U3VjY2VzcyA9ICRmb3JtLmZpbmQoJy5hbGVydC1zdWNjZXNzJyk7XG4gICAgdmFyICRhbGVydERhbmdlciA9ICRmb3JtLmZpbmQoJy5hbGVydC1kYW5nZXInKTtcbiAgICB2YXIgJGZvb3RlckVsZW1lbnRzID0gJGZvcm0uZmluZCgnLm1vZGFsLWZvb3RlcicpLmNoaWxkcmVuKCk7XG4gICAgdmFyICRmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZSgpO1xuICAgIHZhciAkZm9ybUVsZW1lbnRzID0gJGZvcm0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKTtcblxuICAgICRmb3JtRWxlbWVudHMucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcblxuICAgICQuYWpheCh7XG4gICAgICAgIHR5cGU6ICdwb3N0JyxcbiAgICAgICAgdXJsOiAnL2JqYXgvUHJvZHVjdFF1ZXN0aW9uL0FzaycsXG4gICAgICAgIGRhdGE6ICRmb3JtRGF0YSxcbiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MucmVtb3ZlQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgJGFsZXJ0RGFuZ2VyLmFkZENsYXNzKCdkLW5vbmUnKTtcbiAgICAgICAgICAgICRmb290ZXJFbGVtZW50cy50b2dnbGVDbGFzcygnZC1ub25lJyk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgJGFsZXJ0RGFuZ2VyLnJlbW92ZUNsYXNzKCdkLW5vbmUnKTtcbiAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MuYWRkQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgJGZvcm1FbGVtZW50cy5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZhbHNlO1xufSk7XG4iLCIkKCcuanMtcmVtaW5kZXInKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgIHZhciAkZm9ybSA9ICQodGhpcyk7XG5cbiAgICAkZm9ybS5vbignc3VibWl0JywgZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmKCEkZm9ybS52YWxpZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgJGFsZXJ0U3VjY2VzcyA9ICRmb3JtLmZpbmQoJy50ZXh0LXN1Y2Nlc3MnKTtcbiAgICAgICAgdmFyICRmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZSgpO1xuICAgICAgICB2YXIgJGZvcm1CdXR0b24gPSAkZm9ybS5maW5kKCdidXR0b24nKTtcbiAgICAgICAgdmFyICRmb3JtSW5wdXQgPSAkZm9ybS5maW5kKCdpbnB1dCwgYnV0dG9uJyk7XG5cbiAgICAgICAgJGZvcm1CdXR0b24ucHJvcCgnZGlzYWJsZWQnLCB0cnVlKS5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAkZm9ybUlucHV0LnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XG5cbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgIHR5cGU6ICRmb3JtLmF0dHIoJ21ldGhvZCcpLFxuICAgICAgICAgICAgdXJsOiAkZm9ybS5hdHRyKCdhY3Rpb24nKSxcbiAgICAgICAgICAgIGRhdGE6ICRmb3JtRGF0YSxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgJGZvcm1CdXR0b24uaGlkZSgpO1xuICAgICAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MucmVtb3ZlQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLnJlc3BvbnNlVGV4dCA9PT0gJ2FscmVhZHlfZXhpc3RzJykge1xuICAgICAgICAgICAgICAgICAgICAkZm9ybUJ1dHRvbi5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MucmVtb3ZlQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MuYWRkQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgICAgICAgICAkZm9ybUJ1dHRvbi5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAkZm9ybUlucHV0LnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xufSk7XG4iLCIkKCdib2R5Jykub24oJ2NsaWNrLmFkZElucHV0JywgJy5qcy1yZXZpZXctYWRkLWlucHV0JywgZnVuY3Rpb24oKSB7XG4gICAgdmFyICRhZGQgPSAkKHRoaXMpO1xuICAgIHZhciAkaW5wdXRzID0gJGFkZC5wcmV2VW50aWwoJ2g2JywgJ2lucHV0Jyk7XG5cbiAgICBpZigkaW5wdXRzLmxlbmd0aCA8IDUpIHtcbiAgICAgICAgdmFyICRuZXdJbnB1dCA9ICRpbnB1dHMubGFzdCgpLmNsb25lKCkudmFsKCcnKTtcbiAgICAgICAgJG5ld0lucHV0Lmluc2VydEJlZm9yZSgkYWRkKS5mb2N1cygpO1xuXG4gICAgICAgIGlmKCRpbnB1dHMubGVuZ3RoID09PSA0KSB7XG4gICAgICAgICAgICAkYWRkLnJlbW92ZSgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn0pO1xuXG4kKCdib2R5Jykub24oJ3N1Ym1pdCcsICcuanMtcmV2aWV3JywgZnVuY3Rpb24oKSB7XG4gICAgdmFyICRmb3JtID0gJCh0aGlzKTtcbiAgICB2YXIgJGFkZElucHV0cyA9ICRmb3JtLmZpbmQoJy5qcy1yZXZpZXctYWRkLWlucHV0Jyk7XG5cbiAgICAvLyBFeHRyYSBjaGVjayBpZiB2YWxpZGF0aW9uIGlzIGFjdGl2ZVxuICAgIGlmKCEkZm9ybS52YWxpZCgpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBSZXZpZXcgdmFsaWRhdGlvblxuICAgIHZhciAkcmV2aWV3TnVtYmVyID0gJGZvcm0uZmluZCgnLmpzLXJldmlldy1udW1iZXInKTtcbiAgICB2YXIgJHJldmlld0V4cHZhbCA9ICRmb3JtLmZpbmQoJy5qcy1yZXZpZXctZXhwdmFsJyk7XG4gICAgaWYoJHJldmlld051bWJlciAmJiAkcmV2aWV3RXhwdmFsKSB7XG4gICAgICAgICRyZXZpZXdFeHB2YWwudmFsKCRyZXZpZXdOdW1iZXIudmFsKCkpO1xuICAgIH1cblxuICAgIC8vIFBvc2l0aXZlIGFuZCBuZWdhdGl2ZSBwb2ludHNcbiAgICB2YXIgJHBvc2l0aXZlcyA9ICRmb3JtLmZpbmQoJy5qcy1yZXZpZXctcG9zaXRpdmUnKTtcbiAgICB2YXIgcG9zaXRpdmVzID0gJHBvc2l0aXZlcy5tYXAoZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciB2YWx1ZSA9ICQudHJpbSh0aGlzLnZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlID8gdmFsdWUgOiB1bmRlZmluZWQ7XG4gICAgfSkuZ2V0KCkuam9pbignIHx8ICcpO1xuICAgIHZhciAkbmVnYXRpdmVzID0gJGZvcm0uZmluZCgnLmpzLXJldmlldy1uZWdhdGl2ZScpO1xuICAgIHZhciBuZWdhdGl2ZXMgPSAkbmVnYXRpdmVzLm1hcChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gJC50cmltKHRoaXMudmFsdWUpO1xuICAgICAgICByZXR1cm4gdmFsdWUgPyB2YWx1ZSA6IHVuZGVmaW5lZDtcbiAgICB9KS5nZXQoKS5qb2luKCcgfHwgJyk7XG5cbiAgICAvLyBTZXQgbWVzc2FnZVxuICAgIHZhciBtZXNzYWdlID0ge1xuICAgICAgICBtZXNzYWdlOiAkZm9ybS5maW5kKCcuanMtcmV2aWV3LWV4cGVyaWVuY2UnKS52YWwoKSxcbiAgICAgICAgcG9zaXRpdmU6IHBvc2l0aXZlcyxcbiAgICAgICAgbmVnYXRpdmU6IG5lZ2F0aXZlc1xuICAgIH07XG4gICAgJGZvcm0uZmluZCgnLmpzLXJldmlldy1tZXNzYWdlJykudmFsKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTtcblxuICAgIHZhciAkYWxlcnRTdWNjZXNzID0gJGZvcm0uZmluZCgnLmFsZXJ0LXN1Y2Nlc3MnKTtcbiAgICB2YXIgJGFsZXJ0RGFuZ2VyID0gJGZvcm0uZmluZCgnLmFsZXJ0LWRhbmdlcicpO1xuICAgIHZhciAkZm9vdGVyRWxlbWVudHMgPSAkZm9ybS5maW5kKCcubW9kYWwtZm9vdGVyJykuY2hpbGRyZW4oKTtcbiAgICB2YXIgJGZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplKCk7XG4gICAgdmFyICRmb3JtRWxlbWVudHMgPSAkZm9ybS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpO1xuXG4gICAgJGFkZElucHV0cy5vZmYoJ2NsaWNrLmFkZElucHV0Jyk7XG4gICAgJGZvcm1FbGVtZW50cy5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xuXG4gICAgJC5hamF4KHtcblx0XHR0eXBlOiAncG9zdCcsXG5cdFx0dXJsOiAnL3Byb2R1Y3RyZXZpZXcnLFxuXHRcdGRhdGE6ICRmb3JtRGF0YSxcblx0XHRzdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgJGFsZXJ0U3VjY2Vzcy5yZW1vdmVDbGFzcygnZC1ub25lJyk7XG4gICAgICAgICAgICAkYWxlcnREYW5nZXIuYWRkQ2xhc3MoJ2Qtbm9uZScpO1xuICAgICAgICAgICAgJGZvb3RlckVsZW1lbnRzLnRvZ2dsZUNsYXNzKCdkLW5vbmUnKTtcblx0XHR9LFxuXHRcdGVycm9yOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgJGFsZXJ0RGFuZ2VyLnJlbW92ZUNsYXNzKCdkLW5vbmUnKTtcbiAgICAgICAgICAgICRhbGVydFN1Y2Nlc3MuYWRkQ2xhc3MoJ2Qtbm9uZScpO1xuXHRcdFx0JGZvcm1FbGVtZW50cy5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcblx0XHR9XG5cdH0pO1xuXG4gICAgcmV0dXJuIGZhbHNlO1xufSk7XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtc2Nyb2xsZXInKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHNjcm9sbGVyID0gJCh0aGlzKTtcbiAgICAgICAgdmFyICRyb3cgPSAkc2Nyb2xsZXIuZmluZCgnLnJvdycpO1xuICAgICAgICB2YXIgJHNjcm9sbFByZXYgPSAkc2Nyb2xsZXIubmV4dCgnLmpzLXNjcm9sbGVyLW5hdmlnYXRpb24nKS5maW5kKCcuanMtc2Nyb2xsZXItcHJldicpO1xuICAgICAgICB2YXIgJHNjcm9sbE5leHQgPSAkc2Nyb2xsZXIubmV4dCgnLmpzLXNjcm9sbGVyLW5hdmlnYXRpb24nKS5maW5kKCcuanMtc2Nyb2xsZXItbmV4dCcpO1xuXG4gICAgICAgIHZhciBzY3JvbGxEdXJhdGlvbiA9IDQwMDtcbiAgICAgICAgdmFyIHNjcm9sbFdpZHRoID0gMDtcbiAgICAgICAgdmFyIHNjcm9sbFRyYWNrV2lkdGg7XG4gICAgICAgIHZhciBzY3JvbGxUcmFja1Njcm9sbFdpZHRoO1xuXG4gICAgICAgIHZhciBzZXRTY3JvbGxTZXR0aW5ncyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYoc2Nyb2xsV2lkdGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBzY3JvbGxXaWR0aCA9ICRyb3cuY2hpbGRyZW4oKS5maXJzdCgpLm91dGVyV2lkdGgoKTtcbiAgICAgICAgICAgICAgICBzY3JvbGxUcmFja1dpZHRoID0gJHJvdy5vdXRlcldpZHRoKCk7XG4gICAgICAgICAgICAgICAgc2Nyb2xsVHJhY2tTY3JvbGxXaWR0aCA9ICRyb3dbMF0uc2Nyb2xsV2lkdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgY2hlY2tTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyIHNjcm9sbExlZnQgPSAkcm93LnNjcm9sbExlZnQoKTtcblxuICAgICAgICAgICAgaWYoc2Nyb2xsTGVmdCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICRzY3JvbGxlci5hZGRDbGFzcygnc3RhcnQnKTtcbiAgICAgICAgICAgICAgICAkc2Nyb2xsUHJldi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgJHNjcm9sbGVyLnJlbW92ZUNsYXNzKCdzdGFydCcpO1xuICAgICAgICAgICAgICAgICRzY3JvbGxQcmV2LnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoTWF0aC5yb3VuZChzY3JvbGxMZWZ0ICsgc2Nyb2xsVHJhY2tXaWR0aCkgPT09IHNjcm9sbFRyYWNrU2Nyb2xsV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAkc2Nyb2xsZXIuYWRkQ2xhc3MoJ2VuZCcpO1xuICAgICAgICAgICAgICAgICRzY3JvbGxOZXh0LmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAkc2Nyb2xsZXIucmVtb3ZlQ2xhc3MoJ2VuZCcpO1xuICAgICAgICAgICAgICAgICRzY3JvbGxOZXh0LnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNoZWNrU2Nyb2xsUG9zaXRpb24oKTtcbiAgICAgICAgJHJvdy5vbignc2Nyb2xsJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjaGVja1Njcm9sbFBvc2l0aW9uKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRzY3JvbGxQcmV2Lm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgc2V0U2Nyb2xsU2V0dGluZ3MoKTtcbiAgICAgICAgICAgIGlmKCEkc2Nyb2xsUHJldi5oYXNDbGFzcygnZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgICAgICRyb3cuYW5pbWF0ZSh7c2Nyb2xsTGVmdDogJy09Jysgc2Nyb2xsV2lkdGh9LCBzY3JvbGxEdXJhdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRzY3JvbGxOZXh0Lm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgc2V0U2Nyb2xsU2V0dGluZ3MoKTtcbiAgICAgICAgICAgIGlmKCEkc2Nyb2xsTmV4dC5oYXNDbGFzcygnZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgICAgICRyb3cuYW5pbWF0ZSh7c2Nyb2xsTGVmdDogJys9JyArIHNjcm9sbFdpZHRofSwgc2Nyb2xsRHVyYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGlmKCEhL2lQaG9uZXxpUGFkfGlQb2QvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpKSB7XG4gICAgICAgICQoJy5qcy1zY3JvbGxlci1iYXInKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICRzY3JvbGxlciA9ICQodGhpcyk7XG5cbiAgICAgICAgICAgIHZhciAkYmFyID0gJCgnPGRpdi8+JykuYWRkQ2xhc3MoJ3Njcm9sbGVyLS1iYXInKTtcbiAgICAgICAgICAgICRzY3JvbGxlci5hZnRlcigkYmFyKTtcblxuICAgICAgICAgICAgdmFyIHNjcm9sbFdpZHRoID0gMDtcbiAgICAgICAgICAgICRzY3JvbGxlci5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIHNjcm9sbFdpZHRoICs9ICQodGhpcykub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHZhciBzY3JvbGxTdW0gPSAoc2Nyb2xsV2lkdGggLyAkYmFyLndpZHRoKCkpO1xuXG4gICAgICAgICAgICB2YXIgJHRyYWNrID0gJCgnPGRpdi8+Jyk7XG4gICAgICAgICAgICAkdHJhY2sud2lkdGgoTWF0aC5mbG9vcigkYmFyLndpZHRoKCkgLyBzY3JvbGxTdW0pICsgNSkuYXBwZW5kVG8oJGJhcik7XG5cbiAgICAgICAgICAgICRzY3JvbGxlci5hZGRDbGFzcygnaW9zJyk7XG5cbiAgICAgICAgICAgICRzY3JvbGxlci5vbignc2Nyb2xsJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgICR0cmFjay5jc3MoJ3RyYW5zZm9ybScsICd0cmFuc2xhdGVYKCcrKCRzY3JvbGxlci5zY3JvbGxMZWZ0KCkgLyBzY3JvbGxTdW0pKydweCknKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLXNjcm9sbHRvJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyICR0cmlnZ2VyID0gJCh0aGlzKTtcbiAgICAgICAgdmFyIGhlYWRlck9mZmV0ID0gJCgnLmhlYWRlcl9fdG9wYmFyJykuaGVpZ2h0KCk7XG5cbiAgICAgICAgJHRyaWdnZXIub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJHRyaWdnZXIuYXR0cignaHJlZicpO1xuICAgICAgICAgICAgdmFyICR0YXJnZXQgPSAkKHRhcmdldCk7XG4gICAgICAgICAgICB2YXIgb2Zmc2V0ID0gJHRhcmdldC5vZmZzZXQoKS50b3AgLSAoaGVhZGVyT2ZmZXQgKyAxNik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5hbmltYXRlKHtcbiAgICAgICAgICAgICAgICBzY3JvbGxUb3A6IG9mZnNldFxuICAgICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiIsIiQoJy5qcy1zZWFyY2gtdG9nZ2xlJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAkKHRoaXMpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICB3aW5kb3cuY29va2luZ2xpZmVTZWFyY2goKTtcbiAgICB9KTtcbn0pO1xuXG53aW5kb3cuY29va2luZ2xpZmVTZWFyY2ggPSBmdW5jdGlvbigpIHtcbiAgICBpZih6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ3NtJykpIHtcbiAgICAgICAgdmFyICRzZWFyY2ggPSAkKCcuanMtc2VhcmNoJyk7XG4gICAgICAgIHZhciAkaW5wdXQgPSAkc2VhcmNoLmZpbmQoJ2lucHV0Jyk7XG4gICAgICAgIHZhciAkY2xvc2UgPSAkc2VhcmNoLmZpbmQoJy5qcy1zZWFyY2gtY2xvc2UnKTtcbiAgICAgICAgdmFyICRvdmVybGF5ID0gJCgnPGRpdi8+JykuYWRkQ2xhc3MoJ2hlYWRlcl9fc2VhcmNoLW92ZXJsYXknKTtcblxuICAgICAgICBpZighJHNlYXJjaC5oYXNDbGFzcygnc2hvdycpKSB7XG4gICAgICAgICAgICB6aWx2ZXJjbXMubG9ja0JvZHkoKTtcbiAgICAgICAgICAgICRzZWFyY2guYWRkQ2xhc3MoJ3Nob3cnKTtcbiAgICAgICAgICAgICRvdmVybGF5Lmluc2VydEFmdGVyKCRzZWFyY2gpLmZhZGVJbigpLm9uKCdjbGljay5jbG9zZVNlYXJjaCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICRzZWFyY2gucmVtb3ZlQ2xhc3MoJ3Nob3cnKTtcbiAgICAgICAgICAgICAgICAkb3ZlcmxheS5mYWRlT3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAkb3ZlcmxheS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAkaW5wdXQudmFsKCcnKTtcbiAgICAgICAgICAgICAgICAkKCcuc3FyLWNsb3NlQnV0dG9uJykudHJpZ2dlcignY2xpY2snKTtcbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMudW5sb2NrQm9keSgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICRjbG9zZS5vbignY2xpY2suY2xvc2VTZWFyY2gnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAkb3ZlcmxheS50cmlnZ2VyKCdjbGljay5jbG9zZVNlYXJjaCcpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB6aWx2ZXJjbXMubG9ja0JvZHkoKTtcbiAgICB9XG59XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAkKCcuanMtc2VsZWN0MicpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkc2VsZWN0ID0gJCh0aGlzKTtcblxuICAgICAgICAkc2VsZWN0LnNlbGVjdDIoe1xuICAgICAgICAgICAgYWxsb3dIdG1sOiB0cnVlLFxuICAgICAgICAgICAgbWluaW11bVJlc3VsdHNGb3JTZWFyY2g6IC0xLFxuICAgICAgICAgICAgc29ydGVyOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEuc29ydChmdW5jdGlvbihhLCBiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoYS50ZXh0LnRvTG93ZXJDYXNlKCkgPiBiLnRleHQudG9Mb3dlckNhc2UoKSkgPyAwIDogLTE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhlbWU6ICdmbGF0JyxcbiAgICAgICAgICAgIHRlbXBsYXRlUmVzdWx0OiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdDJUZW1wbGF0ZShkYXRhLCBmYWxzZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGVtcGxhdGVTZWxlY3Rpb246IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZWN0MlRlbXBsYXRlKGRhdGEsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KS5vbignc2VsZWN0MjpzZWxlY3QnLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZigkc2VsZWN0LmRhdGEoJ2dvdG8tdmFsdWUnKSkge1xuICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIHppbHZlcmNtcy5sb2NrQm9keSgpO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGUucGFyYW1zLmRhdGEuaWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZnVuY3Rpb24gc2VsZWN0MlRlbXBsYXRlKGRhdGEsIHNlbGVjdGlvbikge1xuICAgICAgICB2YXIgJG9wdGlvbiA9ICQoZGF0YS5lbGVtZW50KTtcbiAgICAgICAgdmFyIGlkID0gZGF0YS5pZDtcbiAgICAgICAgdmFyIHRleHQgPSBkYXRhLnRleHQ7XG4gICAgICAgIHZhciBpbWFnZSA9ICRvcHRpb24uZGF0YSgnaW1hZ2UnKTtcbiAgICAgICAgdmFyIHByaWNlID0gJG9wdGlvbi5kYXRhKCdwcmljZScpO1xuICAgICAgICB2YXIgcHJpY2VPbGQgPSAkb3B0aW9uLmRhdGEoJ29sZC1wcmljZScpO1xuXG4gICAgICAgIHZhciAkaW1hZ2U7XG4gICAgICAgIHZhciAkcHJpY2U7XG4gICAgICAgIHZhciAkcHJpY2VPbGQ7XG4gICAgICAgIHZhciAkc2VsZWN0ZWQ7XG5cbiAgICAgICAgaWYoIXNlbGVjdGlvbiAmJiBkYXRhLnNlbGVjdGVkKSB7XG4gICAgICAgICAgICAkc2VsZWN0ZWQgPSAkKCc8aS8+JykuYXR0cignZGF0YS1pY29uLWFmdGVyJywgJ++JqycpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoaW1hZ2UpIHtcbiAgICAgICAgICAgICRpbWFnZSA9ICQoJzxkaXYvPicsIHtjbGFzczogJ2ltZyBpbWctLWNvbnRhaW4nfSkuaHRtbCgkKCc8aW1nLz4nLCB7c3JjOiBpbWFnZX0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmKCFzZWxlY3Rpb24gJiYgcHJpY2UpIHtcbiAgICAgICAgICAgIGlmKHByaWNlT2xkKSB7XG4gICAgICAgICAgICAgICAgJHByaWNlT2xkID0gJCgnPHMvPicpLmh0bWwoemlsdmVyY21zLmN1cnJlbmN5SGVscGVyKHByaWNlT2xkKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICRwcmljZSA9ICQoJzxkaXYvPicsIHtjbGFzczogJ3NlbGVjdDJfX3ByaWNlJ30pLmh0bWwoemlsdmVyY21zLmN1cnJlbmN5SGVscGVyKHByaWNlKSkucHJlcGVuZCgkcHJpY2VPbGQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyICRvcHRpb24gPSAkKCc8ZGl2Lz4nLCB7XG4gICAgICAgICAgICBjbGFzczogJ2QtZmxleCBhbGlnbi1pdGVtcy1jZW50ZXInXG4gICAgICAgIH0pLmh0bWwodGV4dCkucHJlcGVuZCgkaW1hZ2UpLmFwcGVuZCgkc2VsZWN0ZWQpLmFwcGVuZCgkcHJpY2UpO1xuXG4gICAgICAgIHJldHVybiAkb3B0aW9uO1xuICAgIH1cbn0pO1xuIiwiJCh3aW5kb3cpLm9uKCdsb2FkJywgZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gYW5pbWF0ZVNob3dyb29tKCkge1xuICAgICAgICBpZih6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ3NtJykpIHtcbiAgICAgICAgICAgIHZhciAkc2Nyb2xsZXIgPSAkKCcuanMtc2hvd3Jvb20tc2Nyb2xsZXInKTtcbiAgICAgICAgICAgIHZhciBtYXhTY3JvbGwgPSAkc2Nyb2xsZXIuY2hpbGRyZW4oKS53aWR0aCgpIC0gJHNjcm9sbGVyLndpZHRoKCk7XG5cbiAgICAgICAgICAgICRzY3JvbGxlci5hbmltYXRlKHtcbiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0OiBtYXhTY3JvbGxcbiAgICAgICAgICAgIH0sIDIwMDAsICdsaW5lYXInLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAkc2Nyb2xsZXIuYW5pbWF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbExlZnQ6IG1heFNjcm9sbCAvIDJcbiAgICAgICAgICAgICAgICB9LCAxMDAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgJCgnLmpzLXNob3dyb29tLXR1dG9yaWFsJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciAkdHV0b3JpYWwgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJGNsb3NlVHV0b3JpYWwgPSAkKHRoaXMpLmZpbmQoJy5qcy1jbG9zZS10dXRvcmlhbCcpO1xuICAgICAgICB2YXIgJHJhbmdlID0gJCgnLmpzLXNob3dyb29tLXJhbmdlJyk7XG4gICAgICAgIHZhciBjb29raWVOYW1lID0gJ3Nob3dyb29tVHV0b3JpYWwnO1xuICAgICAgICB2YXIgY29va2llID0gemlsdmVyY21zLmdldENvb2tpZShjb29raWVOYW1lKTtcblxuICAgICAgICBpZih6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ3NtJykpIHtcbiAgICAgICAgICAgICQodGhpcykuZmluZCgnLmpzLXNob3dyb29tLXNsaWRlcicpLnNsaWNrKHtcbiAgICAgICAgICAgICAgICBkb3RzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGluZmluaXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuZXh0QXJyb3c6ICQodGhpcykuZmluZCgnLmpzLXNob3dyb29tLXNsaWRlci1uZXh0JyksXG4gICAgICAgICAgICAgICAgcHJldkFycm93OiAnJyxcbiAgICAgICAgICAgICAgICBzbGlkZXNUb1Nob3c6IDFcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoY29va2llID09PSAnJykge1xuICAgICAgICAgICAgJHR1dG9yaWFsLnJlbW92ZUNsYXNzKCdub3Nob3cnKTtcbiAgICAgICAgICAgICRyYW5nZS5oaWRlKCk7XG5cbiAgICAgICAgICAgICRjbG9zZVR1dG9yaWFsLm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMuc2V0Q29va2llKGNvb2tpZU5hbWUsIHRydWUsIDMwKTtcbiAgICAgICAgICAgICAgICAkdHV0b3JpYWwuYWRkQ2xhc3MoJ25vc2hvdycpO1xuICAgICAgICAgICAgICAgICRyYW5nZS5zaG93KCk7XG4gICAgICAgICAgICAgICAgYW5pbWF0ZVNob3dyb29tKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhbmltYXRlU2hvd3Jvb20oKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgJCgnLmpzLWhvdHNwb3QnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyICRob3RzcG90ID0gJCh0aGlzKTtcbiAgICAgICAgdmFyIGhvdHNwb3RJZCA9ICRob3RzcG90LmRhdGEoJ2hvdHNwb3RpZCcpO1xuICAgICAgICB2YXIgJHByb2R1Y3RzID0gJCgnLmpzLXNob3dyb29tLXByb2R1Y3RzW2RhdGEtaG90c3BvdGlkPVwiJytob3RzcG90SWQrJ1wiXScpO1xuICAgICAgICB2YXIgJG90aGVySG90c3BvdHMgPSAkKCcuanMtaG90c3BvdCcpLm5vdCgkaG90c3BvdCk7XG4gICAgICAgIHZhciAkb3RoZXJQcm9kdWN0cyA9ICQoJy5qcy1zaG93cm9vbS1wcm9kdWN0cycpLm5vdCgkcHJvZHVjdHMpO1xuICAgICAgICB2YXIgJHJhbmdlID0gJCgnLmpzLXNob3dyb29tLXJhbmdlJyk7XG5cbiAgICAgICAgJGhvdHNwb3Qub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJG90aGVySG90c3BvdHMuYWRkQ2xhc3MoJ25vc2hvdycpO1xuICAgICAgICAgICAgJG90aGVyUHJvZHVjdHMuYWRkQ2xhc3MoJ25vc2hvdycpO1xuICAgICAgICAgICAgJGhvdHNwb3QucmVtb3ZlQ2xhc3MoJ25vc2hvdycpO1xuICAgICAgICAgICAgJHByb2R1Y3RzLnJlbW92ZUNsYXNzKCdub3Nob3cnKTtcbiAgICAgICAgICAgICRyYW5nZS5oaWRlKCk7XG5cbiAgICAgICAgICAgICQoJy5qcy1zaG93cm9vbS1pbWFnZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICRvdGhlckhvdHNwb3RzLnJlbW92ZUNsYXNzKCdub3Nob3cnKTtcbiAgICAgICAgICAgICAgICAkcHJvZHVjdHMuYWRkQ2xhc3MoJ25vc2hvdycpO1xuICAgICAgICAgICAgICAgICRyYW5nZS5zaG93KCk7XG4gICAgICAgICAgICAgICAgJCh0aGlzKS5vZmYoJ2NsaWNrJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAkKCcuanMtc2hvd3Jvb20tcHJvZHVjdHMnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyICRwb3B1cCA9ICQodGhpcyk7XG4gICAgICAgIHZhciAkc2xpZGVyID0gJHBvcHVwLmZpbmQoJy5qcy1zaG93cm9vbS1zbGlkZXInKTtcbiAgICAgICAgdmFyICRyYW5nZSA9ICQoJy5qcy1zaG93cm9vbS1yYW5nZScpO1xuXG4gICAgICAgIGlmKCh6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ21kJykgJiYgJHBvcHVwLmRhdGEoJ2Ftb3VudCcpID4gMSkgfHwgKHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JHcmVhdGVyVGhhbignbGcnKSAmJiAkcG9wdXAuZGF0YSgnYW1vdW50JykgPiAyKSkge1xuICAgICAgICAgICAgJHNsaWRlci5zbGljayh7XG4gICAgICAgICAgICAgICAgZG90czogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbmZpbml0ZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgbmV4dEFycm93OiAkKHRoaXMpLmZpbmQoJy5qcy1zaG93cm9vbS1zbGlkZXItbmV4dCcpLFxuICAgICAgICAgICAgICAgIHByZXZBcnJvdzogJCh0aGlzKS5maW5kKCcuanMtc2hvd3Jvb20tc2xpZGVyLXByZXYnKSxcbiAgICAgICAgICAgICAgICBzbGlkZXNUb1Nob3c6IHppbHZlcmNtcy52aWV3cG9ydC5pc0VxdWFsT3JTbWFsbGVyVGhhbignbWQnKSA/IDEgOiAyXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgICQodGhpcykuZmluZCgnLmpzLWNsb3NlLXByb2R1Y3QnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkKCcuanMtc2hvd3Jvb20tcHJvZHVjdHMnKS5hZGRDbGFzcygnbm9zaG93Jyk7XG4gICAgICAgICAgICAkKCcuanMtaG90c3BvdCcpLnJlbW92ZUNsYXNzKCdub3Nob3cnKTtcbiAgICAgICAgICAgICRyYW5nZS5zaG93KCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaWYoemlsdmVyY21zLnZpZXdwb3J0LmlzRXF1YWxPclNtYWxsZXJUaGFuKCdzbScpKSB7XG4gICAgICAgICQoJy5qcy1zaG93cm9vbS1zY3JvbGxlcicpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyICRzY3JvbGxlciA9ICQodGhpcyk7XG4gICAgICAgICAgICB2YXIgJHJhbmdlID0gJHNjcm9sbGVyLm5leHQoJy5qcy1zaG93cm9vbS1yYW5nZScpO1xuXG4gICAgICAgICAgICAkc2Nyb2xsZXIub24oJ3Njcm9sbCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb24gPSAkc2Nyb2xsZXIuc2Nyb2xsTGVmdCgpO1xuICAgICAgICAgICAgICAgICRyYW5nZS52YWwocG9zaXRpb24pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICRzY3JvbGxlci5maW5kKCcuc2hvd3Jvb21fX2NhbnZhcycpLmNzcygnaGVpZ2h0JywgKHdpbmRvdy5pbm5lckhlaWdodCAtIDEzMCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICAkKCcuanMtc2hvd3Jvb20tcmFuZ2UnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciAkcmFuZ2UgPSAkKHRoaXMpO1xuICAgICAgICAgICAgdmFyICRzY3JvbGxlciA9ICRyYW5nZS5wcmV2KCcuanMtc2hvd3Jvb20tc2Nyb2xsZXInKTtcbiAgICAgICAgICAgIHZhciBtYXhTY3JvbGwgPSAkc2Nyb2xsZXIuY2hpbGRyZW4oKS53aWR0aCgpIC0gJHNjcm9sbGVyLndpZHRoKCk7XG5cbiAgICAgICAgICAgICRyYW5nZS5hdHRyKCdtYXgnLCBtYXhTY3JvbGwpLm9uKCdpbnB1dCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAkc2Nyb2xsZXIuc2Nyb2xsTGVmdCgkKHRoaXMpLnZhbCgpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy1zbGljaycpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkc2xpY2sgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJHNsaWNrSW1hZ2VzID0gJHNsaWNrLmNoaWxkcmVuKCk7XG5cbiAgICAgICAgLy8gU2V0IGltYWdlIHNpemUgYmFzZWQgb24gc2NyZWVuIHNpemUgYW5kIHBpeGVsIHJhdGlvXG4gICAgICAgICRzbGlja0ltYWdlcy5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICRpbWcgPSAkKHRoaXMpLmZpbmQoJ2ltZycpO1xuICAgICAgICAgICAgdmFyIG9yaWdpbmFsID0gJGltZy5kYXRhKCdvcmlnaW5hbCcpO1xuXG4gICAgICAgICAgICBpZihvcmlnaW5hbCkge1xuICAgICAgICAgICAgICAgIHZhciBwaXhlbFJhdGlvID0gKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvID4gMSkgPyAyIDogMTtcbiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gJCh0aGlzKS5wYXJlbnQoKS5oZWlnaHQoKSAqIHBpeGVsUmF0aW87XG4gICAgICAgICAgICAgICAgdmFyIHdpZHRoID0gJCh0aGlzKS5wYXJlbnQoKS5wYXJlbnQoKS53aWR0aCgpICogcGl4ZWxSYXRpbztcbiAgICAgICAgICAgICAgICAkaW1nLmF0dHIoJ2RhdGEtbGF6eScsIHppbHZlcmNtcy5pbWFnZUhlbHBlcihvcmlnaW5hbCwgd2lkdGgrJ3gnK2hlaWdodCsnLGZpdCcpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cblxuICAgICAgICAkc2xpY2sub24oJ2luaXQnLCBmdW5jdGlvbihldmVudCwgc2xpY2spIHtcbiAgICAgICAgICAgIHZhciBoaWRkZW5UaHVtYnMgPSAwO1xuICAgICAgICAgICAgdmFyICRsYXN0VmlzaWJsZVRodW1iO1xuXG4gICAgICAgICAgICAkc2xpY2subGlnaHRHYWxsZXJ5KHtcbiAgICAgICAgICAgICAgICBhdXRvcGxheTogZmFsc2UsXG4gICAgICAgICAgICAgICAgYXV0b3BsYXlGaXJzdFZpZGVvOiB0cnVlLFxuICAgICAgICAgICAgICAgIGRvd25sb2FkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBleFRodW1iSW1hZ2U6ICdkYXRhLXRodW1iJyxcbiAgICAgICAgICAgICAgICBsb2FkWW91dHViZVRodW1ibmFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZWxlY3Rvcjogc2xpY2suJHNsaWRlcyxcbiAgICAgICAgICAgICAgICB5b3V0dWJlVGh1bWJTaXplOiAnbXFkZWZhdWx0JyxcbiAgICAgICAgICAgICAgICB5b3V0dWJlUGxheWVyUGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGVzdGJyYW5kaW5nOiAxLFxuICAgICAgICAgICAgICAgICAgICByZWw6IDAsXG4gICAgICAgICAgICAgICAgICAgIHNob3dpbmZvOiAwXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB0aHVtYldpZHRoOiA4MFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmKHNsaWNrLiRkb3RzKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhcmVudFdpZHRoID0gc2xpY2suJGRvdHMucGFyZW50KCkud2lkdGgoKTtcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50T2Zmc2V0ID0gc2xpY2suJGRvdHMub2Zmc2V0KCkubGVmdDtcblxuICAgICAgICAgICAgICAgIHNsaWNrLiRkb3RzLmZpbmQoJ2xpJykuZWFjaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyICR0aHVtYiA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9ICR0aHVtYi53aWR0aCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0UmlnaHQgPSAoJHRodW1iLm9mZnNldCgpLmxlZnQgKyB3aWR0aCkgLSBwYXJlbnRPZmZzZXQ7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYob2Zmc2V0UmlnaHQgPiBwYXJlbnRXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHRodW1iLmFkZENsYXNzKCdkLW5vbmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlblRodW1icysrO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJGxhc3RWaXNpYmxlVGh1bWIgPSAkdGh1bWI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmKGhpZGRlblRodW1icyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgJGxhc3RWaXNpYmxlVGh1bWIuZmluZCgnLnNsaWNrLXRodW1iJykuYXR0cignZGF0YS1wbHVzJywgJysnKyhoaWRkZW5UaHVtYnMgKyAxKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAkc2xpY2suZmluZCgnLnNsaWNrLW5leHQnKS5hZGRDbGFzcygnYXJyb3cgbmV4dCcpO1xuICAgICAgICAgICAgJHNsaWNrLmZpbmQoJy5zbGljay1wcmV2JykuYWRkQ2xhc3MoJ2Fycm93IHByZXYnKTtcbiAgICAgICAgICAgICRzbGljay5yZW1vdmVDbGFzcygnZC1ub25lJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgICRzbGljay5zbGljayh7XG4gICAgICAgICAgICBhZGFwdGl2ZUhlaWdodDogZmFsc2UsXG4gICAgICAgICAgICBhcHBlbmREb3RzOiAkc2xpY2sucGFyZW50KCksXG4gICAgICAgICAgICBjdXN0b21QYWdpbmc6IGZ1bmN0aW9uKHNsaWRlciwgaSkge1xuICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHNsaWRlci4kc2xpZGVzW2ldO1xuICAgICAgICAgICAgICAgIHZhciAkc2xpZGUgPSAkKHNsaWRlKTtcbiAgICAgICAgICAgICAgICB2YXIgdGh1bWIgPSAkc2xpZGUuZGF0YSgndGh1bWInKTtcbiAgICAgICAgICAgICAgICB2YXIgJHRodW1iID0gJCgnPGltZy8+JykuYXR0cih7J3NyYyc6IHRodW1ifSk7XG4gICAgICAgICAgICAgICAgdmFyICRkb3QgPSAkKCc8ZGl2Lz4nKS5hdHRyKHsnY2xhc3MnOiAnc2xpY2stdGh1bWInfSkuaHRtbCgkdGh1bWIpO1xuICAgICAgICAgICAgICAgIGlmKCRzbGlkZS5oYXNDbGFzcygnc2xpY2stdmlkZW8nKSkge1xuICAgICAgICAgICAgICAgICAgICAkZG90LmFkZENsYXNzKCdzbGljay10aHVtYi12aWRlbycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkZG90Lm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZigkZG90LmF0dHIoJ2RhdGEtcGx1cycpIHx8ICRzbGlkZS5oYXNDbGFzcygnc2xpY2stdmlkZW8nKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJHNsaWRlLnRyaWdnZXIoJ2NsaWNrJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGRvdDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkb3RzOiAoJHNsaWNrSW1hZ2VzLmxlbmd0aCA+IDEpLFxuICAgICAgICAgICAgaW5maW5pdGU6IHRydWUsXG4gICAgICAgICAgICBpbml0aWFsU2xpZGU6IDAsXG4gICAgICAgICAgICBzd2lwZTogemlsdmVyY21zLnZpZXdwb3J0LmlzRXF1YWxPclNtYWxsZXJUaGFuKCdtZCcpXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgJCgnLmpzLXRyaWdnZXItc2xpY2stdmlkZW8nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHRyaWdnZXIgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgJHNsaWNrVmlkZW8gPSAkKCcuc2xpY2stdGh1bWItdmlkZW8nKTtcblxuICAgICAgICAkdHJpZ2dlci5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICRzbGlja1ZpZGVvLmNsaWNrKCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iLCJ2YXIgX3dzc3EgPSBfd3NzcSB8fCBbXTtcbnZhciBsYW5ndWFnZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xudmFyIHNlYXJjaEZpZWxkID0gJ3NlYXJjaC1maWVsZCc7XG52YXIgJHNlYXJjaEZpZWxkID0gJCgnIycgKyBzZWFyY2hGaWVsZCk7XG52YXIgc29vcXJBY2NvdW50ID0gJHNlYXJjaEZpZWxkLmRhdGEoJ3Nvb3FyJyk7XG52YXIgc29vcXJMb2NhbGUgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZy50b0xvd2VyQ2FzZSgpICsgJ18nICsgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmxhbmcudG9VcHBlckNhc2UoKTtcblxuaWYoc29vcXJBY2NvdW50KSB7XG4gICAgX3dzc3EucHVzaChbJ19sb2FkJywge1xuICAgICAgICBzdWdnZXN0OiB7XG4gICAgICAgICAgICBhY2NvdW50OiAnU1EtJyArIHNvb3FyQWNjb3VudCxcbiAgICAgICAgICAgIGZpZWxkSWQgOiBzZWFyY2hGaWVsZCxcbiAgICAgICAgICAgIGxvY2FsZTogc29vcXJMb2NhbGUsXG4gICAgICAgICAgICB2ZXJzaW9uOiA0XG4gICAgICAgIH1cbiAgICB9XSk7XG5cbiAgICBfd3NzcS5wdXNoKFsnc3VnZ2VzdC5fYmluZEV2ZW50JywgJ29wZW4nLCBmdW5jdGlvbigpIHtcbiAgICAgICAgd2luZG93LmNvb2tpbmdsaWZlU2VhcmNoKCk7XG5cbiAgICAgICAgJHNlYXJjaEZpZWxkLnBhcmVudHMoJ2Zvcm0nKS5vbignc3VibWl0LnNlYXJjaCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICAgICAgICAkc2VhcmNoRmllbGQuYmx1cigpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpbmZpbml0ZVNjcm9sbChzb29xckFjY291bnQpO1xuXG4gICAgICAgIHB1c2hEYXRhTGF5ZXIoJ3Nvb3FyT3BlbicpO1xuICAgIH1dKTtcblxuICAgIF93c3NxLnB1c2goWydzdWdnZXN0Ll9iaW5kRXZlbnQnLCAndXBkYXRlUmVzdWx0cycsIGZ1bmN0aW9uKCkge1xuICAgICAgICBpZih6aWx2ZXJjbXMudmlld3BvcnQuaXNFcXVhbE9yU21hbGxlclRoYW4oJ3hzJykpIHtcbiAgICAgICAgICAgICQoJy5zcXItcmVzdWx0SXRlbSAuc3RvY2snKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHZhciAkc3RvY2sgPSAkKHRoaXMpXG4gICAgICAgICAgICAgICAgdmFyICR3cmFwcGVyID0gJHN0b2NrLnBhcmVudCgpO1xuICAgICAgICAgICAgICAgICRzdG9jay5jaGlsZHJlbigpLnVud3JhcCgpO1xuICAgICAgICAgICAgICAgICR3cmFwcGVyLmFkZENsYXNzKCdzdG9jay1sYWJlbCcpO1xuICAgICAgICAgICAgICAgICR3cmFwcGVyLnVud3JhcCgpLnVud3JhcCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICQoJy5zcXItcmVzdWx0cy5zcXItZ3JpZCcpLmF0dHIoJ2NsYXNzJywgJ3Nxci1yZXN1bHRzIGRldGFpbCBzcXItZGV0YWlsJyk7XG4gICAgICAgIH1cblxuICAgICAgICAkKCcuc3FyLXJlc3VsdEl0ZW0nKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyICRpdGVtID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciAkcHJpY2UgPSAkaXRlbS5maW5kKCcuc3FyLXByaWNlJyk7XG4gICAgICAgICAgICB2YXIgX3ByaWNlID0gemlsdmVyY21zLmN1cnJlbmN5SGVscGVyKCRwcmljZS50ZXh0KCkucmVwbGFjZSgvW14wLTldL2csICcnKSk7XG4gICAgICAgICAgICAkcHJpY2UuaHRtbChfcHJpY2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpbmZpbml0ZVNjcm9sbChzb29xckFjY291bnQpO1xuXG4gICAgICAgIHB1c2hEYXRhTGF5ZXIoJ3Nvb3FyVXBkYXRlJyk7XG4gICAgfV0pO1xuXG4gICAgX3dzc3EucHVzaChbJ3N1Z2dlc3QuX2JpbmRFdmVudCcsICdjbG9zZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAkKCcjc2VhcmNoLWZpZWxkJykucGFyZW50cygnZm9ybScpLm9mZignc3VibWl0LnNlYXJjaCcpO1xuXG4gICAgICAgIGlmKHppbHZlcmNtcy52aWV3cG9ydC5pc0dyZWF0ZXJUaGFuKCd4cycpKSB7XG4gICAgICAgICAgICB6aWx2ZXJjbXMudW5sb2NrQm9keSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgJGpRKCcuc29vcXJTZWFyY2hDb250YWluZXItJyArIHNvb3FyQWNjb3VudCArICcgLnNvb3FyU2VhcmNoUmVzdWx0c0NvbnRhaW5lcicpLnVuYmluZCgnc2Nyb2xsLmluZmluaXRlU2Nyb2xsJyk7XG5cbiAgICAgICAgcHVzaERhdGFMYXllcignc29vcXJDbG9zZScpO1xuICAgIH1dKTtcblxuICAgIGZ1bmN0aW9uIGluZmluaXRlU2Nyb2xsKHNvb3FyQWNjb3VudCkge1xuICAgICAgICAkalEoJy5zb29xclNlYXJjaENvbnRhaW5lci0nICsgc29vcXJBY2NvdW50ICsgJyAuc29vcXJTZWFyY2hSZXN1bHRzQ29udGFpbmVyJykudW5iaW5kKCdzY3JvbGwuaW5maW5pdGVTY3JvbGwnKS5iaW5kKCdzY3JvbGwuaW5maW5pdGVTY3JvbGwnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciAkY29udGFpbmVyID0gJGpRKHRoaXMpO1xuICAgICAgICAgICAgdmFyICRyZXN1bHRzID0gICRjb250YWluZXIuZmluZCgnLnNvb3FyU2VhcmNoUmVzdWx0cycpO1xuICAgICAgICAgICAgdmFyICRtb3JlID0gJGNvbnRhaW5lci5maW5kKCcuc3FyLW1vcmVSZXN1bHRzJyk7XG5cbiAgICAgICAgICAgIGlmKCRtb3JlLmlzKCc6dmlzaWJsZScpICYmICgkY29udGFpbmVyLnNjcm9sbFRvcCgpICsgJGNvbnRhaW5lci5vdXRlckhlaWdodCgpKSA+ICgkcmVzdWx0cy5vdXRlckhlaWdodCgpIC0gNjApKSB7XG4gICAgICAgICAgICAgICAgJG1vcmUudHJpZ2dlcignY2xpY2snKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcHVzaERhdGFMYXllcihldmVudE5hbWUpIHtcbiAgICAgICAgd2luZG93LmRhdGFMYXllciA9IHdpbmRvdy5kYXRhTGF5ZXIgfHwgW107XG4gICAgICAgIGRhdGFMYXllci5wdXNoKHtcbiAgICAgICAgICAgIGV2ZW50OiBldmVudE5hbWVcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgd3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsgd3MudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOyB3cy5hc3luYyA9IHRydWU7XG4gICAgICAgIHdzLnNyYyA9ICgnaHR0cHM6JyA9PSBkb2N1bWVudC5sb2NhdGlvbi5wcm90b2NvbCA/ICdodHRwczovLycgOiAnaHR0cDovLycpICsgJ3N0YXRpYy5zb29xci5jb20vc29vcXIuanMnO1xuICAgICAgICB2YXIgcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTsgcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh3cywgcyk7XG4gICAgfSkoKTtcbn1cbiIsImlmKHR5cGVvZiBVUkxTZWFyY2hQYXJhbXMgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgdmFyIHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7XG4gICAgdmFyIHNvdXJjZSA9IHVybFBhcmFtcy5nZXQoJ3V0bV9zb3VyY2UnKTtcbiAgICB2YXIgbWVkaXVtID0gdXJsUGFyYW1zLmdldCgndXRtX21lZGl1bScpO1xuICAgIHZhciBjYW1wYWlnbiA9IHVybFBhcmFtcy5nZXQoJ3V0bV9jYW1wYWlnbicpO1xuXG4gICAgaWYoc291cmNlICE9PSBudWxsKSB7XG4gICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IFsnbGFzdF91dG1fc291cmNlPScsIHNvdXJjZSwgJztwYXRoPS8nXS5qb2luKCcnKTtcbiAgICB9XG4gICAgaWYobWVkaXVtICE9PSBudWxsKSB7XG4gICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IFsnbGFzdF91dG1fbWVkaXVtPScsIG1lZGl1bSwgJztwYXRoPS8nXS5qb2luKCcnKTtcbiAgICB9XG4gICAgaWYoY2FtcGFpZ24gIT09IG51bGwpIHtcbiAgICAgICAgZG9jdW1lbnQuY29va2llID0gWydsYXN0X3V0bV9jYW1wYWlnbj0nLCBjYW1wYWlnbiwgJztwYXRoPS8nXS5qb2luKCcnKTtcbiAgICB9XG59XG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgICAvLyBDaGVjayBpZiBicm93c2VyIHN1cHBvcnRzIGRhdGUgaW5wdXRcbiAgICB2YXIgZGF0ZVBpY2tlckZvcm1hdE1lc3NhZ2UgPSAnJztcbiAgICB2YXIgaW5wdXRGaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgaW5wdXRGaWVsZC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnZGF0ZScpO1xuICAgIGlmKGlucHV0RmllbGQudHlwZSAhPSAnZGF0ZScpIHtcbiAgICAgICAgZGF0ZVBpY2tlckZvcm1hdE1lc3NhZ2UgPSAnIChKSkpKLU1NLUREKSc7XG4gICAgfVxuXG4gICAgJC52YWxpZGF0b3IubWVzc2FnZXMgPSB7XG4gICAgICAgIHJlcXVpcmVkOiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLnJlcXVpcmVkJyksXG4gICAgICAgIHJlbW90ZTogemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5yZW1vdGUnKSxcbiAgICAgICAgZW1haWw6IHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcigndmFsaWRhdGUuZW1haWwnKSxcbiAgICAgICAgdXJsOiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLnVybCcpLFxuICAgICAgICBkYXRlOiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLmRhdGUnKSxcbiAgICAgICAgZGF0ZUlTTzogemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5kYXRlSVNPJyksXG4gICAgICAgIG51bWJlcjogemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5udW1iZXInKSxcbiAgICAgICAgZGlnaXRzOiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLmRpZ2l0cycpLFxuICAgICAgICBjcmVkaXRjYXJkOiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLmNyZWRpdGNhcmQnKSxcbiAgICAgICAgZXF1YWxUbzogemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5lcXVhbFRvJyksXG4gICAgICAgIGV4dGVuc2lvbjogemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5leHRlbnNpb24nKSxcbiAgICAgICAgbWF4bGVuZ3RoOiAkLnZhbGlkYXRvci5mb3JtYXQoemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5tYXhsZW5ndGgnKSksXG4gICAgICAgIG1pbmxlbmd0aDogJC52YWxpZGF0b3IuZm9ybWF0KHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcigndmFsaWRhdGUubWlubGVuZ3RoJykpLFxuICAgICAgICByYW5nZWxlbmd0aDogJC52YWxpZGF0b3IuZm9ybWF0KHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcigndmFsaWRhdGUucmFuZ2VsZW5ndGgnKSksXG4gICAgICAgIHJhbmdlOiAkLnZhbGlkYXRvci5mb3JtYXQoemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5yYW5nZScpKSxcbiAgICAgICAgbWF4OiAkLnZhbGlkYXRvci5mb3JtYXQoemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5tYXgnKSksXG4gICAgICAgIG1pbjogJC52YWxpZGF0b3IuZm9ybWF0KHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcigndmFsaWRhdGUubWluJykpLFxuICAgICAgICBzdGVwOiAkLnZhbGlkYXRvci5mb3JtYXQoemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5zdGVwJykpXG4gICAgfTtcblxuICAgICQudmFsaWRhdG9yLmFkZE1ldGhvZCgnemlwY29kZU5MJywgZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHtcbiAgICAgICAgaWYoJChlbGVtZW50KS5oYXNDbGFzcygnanMtYWRkcmVzcy16aXBjb2RlJykpIHtcbiAgICAgICAgICAgIHJldHVybiAvXlsxLTldWzAtOV17M31cXHM/W2EtekEtWl17Mn0kLy50ZXN0KHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfSwgJ1Z1bCBlZW4gZ2VsZGlnZSBwb3N0Y29kZSBpbiwgYmlqdjogMTIzNEFCJyk7XG5cbiAgICAkLnZhbGlkYXRvci5hZGRNZXRob2QoJ3Zpc2libGVQYXltZW50TWV0aG9kJywgZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuICQoJyNtZXRob2QnK3ZhbHVlKS5pcygnOnZpc2libGUnKTtcbiAgICB9LCB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3dlYnNob3AuY2hlY2tvdXQuc2VsZWN0X3BheW1lbnRtZXRob2QnKSk7XG5cbiAgICAkLnZhbGlkYXRvci5hZGRNZXRob2QoJ3ZhbGlkRGF0ZScsIGZ1bmN0aW9uKHZhbHVlLCBlbGVtZW50KSB7XG4gICAgICAgIHZhciByZWdFeCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLztcbiAgICAgICAgaWYoIXZhbHVlLm1hdGNoKHJlZ0V4KSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAgLy8gSW52YWxpZCBmb3JtYXRcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUodmFsdWUpO1xuICAgICAgICBpZihOdW1iZXIuaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIEludmFsaWQgZGF0ZVxuICAgICAgICB9IGVsc2UgaWYgKCh0b2RheS5nZXRGdWxsWWVhcigpIC0gZGF0ZS5nZXRGdWxsWWVhcigpKSA+IDExMCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBJbnZhbGlkIGFnZVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5zbGljZSgwLCAxMCkgPT09IHZhbHVlO1xuICAgIH0sICh6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLmJpcnRoZGF0ZScpICsgZGF0ZVBpY2tlckZvcm1hdE1lc3NhZ2UpKTtcblxuICAgICQudmFsaWRhdG9yLmFkZE1ldGhvZCgnbWluQWdlMTgnLCBmdW5jdGlvbih2YWx1ZSwgZWxlbWVudCkge1xuICAgICAgICB2YXIgYmlydGhEYXRlID0gbmV3IERhdGUodmFsdWUpO1xuICAgICAgICB2YXIgZWlnaHRlZW5ZZWFyc0FnbyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGVpZ2h0ZWVuWWVhcnNBZ28uc2V0RnVsbFllYXIoZWlnaHRlZW5ZZWFyc0Fnby5nZXRGdWxsWWVhcigpIC0gMTgpO1xuXG4gICAgICAgIHJldHVybiAoYmlydGhEYXRlIDwgZWlnaHRlZW5ZZWFyc0Fnbyk7XG4gICAgfSwgemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5taW5BZ2UxOCcpKTtcblxuICAgICQudmFsaWRhdG9yLmFkZE1ldGhvZCgndmF0TnVtYmVyJywgZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHtcbiAgICAgICAgdmFyIGNvdW50cnlDb2RlID0gJCgnLmpzLWNoZWNrb3V0LWNvdW50cnknKS52YWwoKTtcblxuICAgICAgICBpZihjb3VudHJ5Q29kZSA9PT0gJ25sJykge1xuICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gJycgfHwgKHZhbHVlLmxlbmd0aCA9PT0gMTQgJiYgdmFsdWUubWF0Y2goL15bQS1aXXsyfVswLTldezl9W0EtWl17MX1bMC05XXsyfS9nKSkpO1xuICAgICAgICB9IGVsc2UgaWYoY291bnRyeUNvZGUgPT09ICdiZScpIHtcbiAgICAgICAgICAgIHJldHVybiAodmFsdWUgPT09ICcnIHx8ICh2YWx1ZS5sZW5ndGggPT09IDEyICYmIHZhbHVlLm1hdGNoKC9eW0EtWl17Mn1bMC05XXsxMH0vZykpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfSwgemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS52YXRtZXNzYWdlJykpO1xuXG4gICAgJC52YWxpZGF0b3IuYWRkTWV0aG9kKCdjb2NOdW1iZXInLCBmdW5jdGlvbih2YWx1ZSwgZWxlbWVudCkge1xuICAgICAgICB2YXIgc2VsZWN0ZWRQYXltZW50TWV0aG9kTmFtZSA9ICQoJypbZGF0YS1wYXltZW50LW1ldGhvZF06Y2hlY2tlZCcpLmRhdGEoJ3BheW1lbnQtbWV0aG9kJyk7XG4gICAgICAgIGlmKHNlbGVjdGVkUGF5bWVudE1ldGhvZE5hbWUgPT09ICdiaWxsaW5rJykge1xuICAgICAgICAgICAgcmV0dXJuICgkKGVsZW1lbnQpLnZhbCgpLmxlbmd0aCA+IDApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0sIHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcigndmFsaWRhdGUucmVxdWlyZWQnKSk7XG5cbiAgICAkLnZhbGlkYXRvci5hZGRNZXRob2QoJ3Bob25lJywgZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hdGNoKC9eXFwoP1xcKz9bXFxkXFwoXFwtXFxzXFwpXSskLyk7XG4gICAgfSwgemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5waG9uZScpKTtcblxuICAgICQudmFsaWRhdG9yLmFkZE1ldGhvZCgnc3RlcCcsIGZ1bmN0aW9uKHZhbHVlLCBlbGVtZW50KSB7XG4gICAgICAgIHZhciBzdGVwID0gJChlbGVtZW50KS5hdHRyKCdzdGVwJyk7XG4gICAgICAgIHJldHVybiAoTWF0aC5yb3VuZCh2YWx1ZS9zdGVwKSA9PT0gKHZhbHVlL3N0ZXApKTtcbiAgICB9LCBmdW5jdGlvbihwYXJhbXMsIGVsZW1lbnQpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gJChlbGVtZW50KS52YWwoKTtcbiAgICAgICAgdmFyIHN0ZXAgPSAkKGVsZW1lbnQpLmF0dHIoJ3N0ZXAnKTtcbiAgICAgICAgdmFyIHByZXYgPSBNYXRoLmZsb29yKHZhbHVlL3N0ZXApICogc3RlcDtcbiAgICAgICAgdmFyIG5leHQgPSBNYXRoLmNlaWwodmFsdWUvc3RlcCkgKiBzdGVwO1xuICAgICAgICByZXR1cm4gemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5wcm9kdWN0U3RlcCcsIHtcbiAgICAgICAgICAgICd7c3RlcH0nOiBzdGVwLFxuICAgICAgICAgICAgJ3twcmV2fSc6IHByZXYsXG4gICAgICAgICAgICAne25leHR9JzogbmV4dFxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgICQudmFsaWRhdG9yLmZvcm1WYWxpZGF0aW9uID0gZnVuY3Rpb24oZm9ybSkge1xuICAgICAgICAkKGZvcm0pLmFkZENsYXNzKCd2YWxpZGF0aW5nJykudmFsaWRhdGUoe1xuXHRcdFx0cnVsZXM6IHtcblx0XHRcdFx0J2RhdGFbYnV5ZXJdW3Bob25lXSc6IHtcbiAgICAgICAgICAgICAgICAgICAgbWlubGVuZ3RoOiA4LFxuICAgICAgICAgICAgICAgICAgICBtYXhsZW5ndGg6IDE3LFxuXHRcdFx0XHRcdHBob25lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZVxuXHRcdFx0XHR9LFxuICAgICAgICAgICAgICAgICdkYXRhW2J1eWVyXVtlbWFpbF0nOiB7XG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgJ2RhdGFbaW52b2ljZV1bemlwY29kZV0nOiB7XG4gICAgICAgICAgICAgICAgICAgIHppcGNvZGVOTDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdkYXRhW3NoaXBwaW5nXVt6aXBjb2RlXSc6IHtcbiAgICAgICAgICAgICAgICAgICAgemlwY29kZU5MOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgXCJkYXRhW2J1eWVyXVt2YXRdXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgdmF0TnVtYmVyOiB0cnVlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnZGF0YVtwYXltZW50XVttZXRob2RdJzoge1xuICAgICAgICAgICAgICAgICAgICB2aXNpYmxlUGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdkYXRhW2J1eWVyXVtiaXJ0aGRhdGVdJzoge1xuICAgICAgICAgICAgICAgICAgICB2YWxpZERhdGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIG1pbkFnZTE4OiB0cnVlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnZGF0YVtidXllcl1bY29jXSc6IHtcbiAgICAgICAgICAgICAgICAgICAgY29jTnVtYmVyOiB0cnVlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBjb3VudDoge1xuICAgICAgICAgICAgICAgICAgICBzdGVwOiB0cnVlXG4gICAgICAgICAgICAgICAgfVxuXHRcdFx0fSxcbiAgICAgICAgICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgICAgICAgICAgb3JkZXJfYWNjZXB0OiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3dlYnNob3AuY2hlY2tvdXQub3JkZXJfYWNjZXB0JyksXG4gICAgICAgICAgICAgICAgJ2RhdGFbcGF5bWVudF1bbWV0aG9kXSc6IHppbHZlcmNtcy50cmFuc2xhdGlvbkhlbHBlcignd2Vic2hvcC5jaGVja291dC5zZWxlY3RfcGF5bWVudG1ldGhvZCcpLFxuICAgICAgICAgICAgICAgICdkYXRhW2J1eWVyXVtiaXJ0aGRhdGVdJzoge1xuICAgICAgICAgICAgICAgICAgICBkYXRlOiAoemlsdmVyY21zLnRyYW5zbGF0aW9uSGVscGVyKCd2YWxpZGF0ZS5iaXJ0aGRhdGUnKSArIGRhdGVQaWNrZXJGb3JtYXRNZXNzYWdlKVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY291bnQ6IHtcbiAgICAgICAgICAgICAgICAgICAgbWF4OiB6aWx2ZXJjbXMudHJhbnNsYXRpb25IZWxwZXIoJ3ZhbGlkYXRlLm1heE9yZGVyJylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaWdub3JlOiAnOmhpZGRlbiwgLmpzLXBpY2t1cC1sb2NhdGlvbicsXG4gICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uKGVsKSB7fSxcbiAgICAgICAgICAgIHVuaGlnaGxpZ2h0OiBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgIHZhciAkZWwgPSAkKGVsKTtcblxuICAgICAgICAgICAgICAgIGlmKCRlbC5wYXJlbnRzKCcucHJvZHVjdGJsb2NrJykubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICRlbC5wYXJlbnRzKCcucHJvZHVjdGJsb2NrJykucmVtb3ZlQXR0cignZGF0YS1lcnJvcicpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZigkZWwuaGFzQ2xhc3MoJ2NoZWNrb3V0X19wYXltZW50LW9wdGlvbicpKSB7XG4gICAgICAgICAgICAgICAgICAgICRlbC5wcmV2KCcudGV4dC5lcnJvcicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZigkZWwuaGFzQ2xhc3MoJ3JhZGlvJykgfHwgJGVsLmhhc0NsYXNzKCdjaGVja2JveCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICRlbC5uZXh0KCdsYWJlbCcpLnJlbW92ZUF0dHIoJ2RhdGEtZXJyb3InKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkZWwucGFyZW50KCkucmVtb3ZlQXR0cignZGF0YS1lcnJvcicpLnJlbW92ZUF0dHIoJ2RhdGEtc3VjY2VzcycpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKCRlbC52YWwoKSAhPSAnJyAmJiAhJGVsLmlzKCdbcmVhZG9ubHldJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRlbC5wYXJlbnQoKS5hdHRyKCdkYXRhLXN1Y2Nlc3MnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvclBsYWNlbWVudDogZnVuY3Rpb24oZXJyb3IsIGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoZWwpO1xuXG4gICAgICAgICAgICAgICAgaWYoJGVsLnBhcmVudHMoJy5wcm9kdWN0YmxvY2snKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgJGVsLnBhcmVudHMoJy5wcm9kdWN0YmxvY2snKS5yZW1vdmVBdHRyKCdkYXRhLXN1Y2Nlc3MnKS5hdHRyKCdkYXRhLWVycm9yJywgZXJyb3JbMF0udGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZigkZWwuaGFzQ2xhc3MoJ2NoZWNrb3V0X19wYXltZW50LW9wdGlvbicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciAkZGl2ID0gJCgnPGRpdi8+JykuYWRkQ2xhc3MoJ3RleHQgZXJyb3IgbWItMycpLnRleHQoZXJyb3JbMF0udGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICAkZWwucHJldignLnRleHQuZXJyb3InKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgJGVsLmJlZm9yZSgkZGl2KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoJGVsLmhhc0NsYXNzKCdyYWRpbycpIHx8ICRlbC5oYXNDbGFzcygnY2hlY2tib3gnKSkge1xuICAgICAgICAgICAgICAgICAgICAkZWwubmV4dCgnbGFiZWwnKS5yZW1vdmVBdHRyKCdkYXRhLXN1Y2Nlc3MnKS5hdHRyKCdkYXRhLWVycm9yJywgZXJyb3JbMF0udGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICRlbC5wYXJlbnQoKS5yZW1vdmVBdHRyKCdkYXRhLXN1Y2Nlc3MnKS5hdHRyKCdkYXRhLWVycm9yJywgZXJyb3JbMF0udGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgfVxuICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAkKCcuanMtdmFsaWRhdGUnKS5lYWNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAkLnZhbGlkYXRvci5mb3JtVmFsaWRhdGlvbih0aGlzKTtcbiAgICB9KTtcbn0pO1xuIiwiJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XG4gICAgJCgnLmpzLXZveXNxdWV1ZScpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkYmFkZ2UgPSAkKHRoaXMpO1xuXG4gICAgICAgICQuZ2V0SlNPTignL2JqYXgvdm95cy9xdWV1ZS8nLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICBpZihkYXRhLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgICAgICAkYmFkZ2UuY3NzKCdvcGFjaXR5JywgMSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICRiYWRnZS5yZW1vdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiIsIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICAgICQoJy5qcy13aGF0c2FwcCcpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciAkYmFkZ2UgPSAkKHRoaXMpO1xuICAgICAgICB2YXIgY29va2llID0gemlsdmVyY21zLmdldENvb2tpZSgnd2hhdHNhcHBiYWRnZScpO1xuICAgICAgICAkYmFkZ2Uud2lkdGgoJGJhZGdlLndpZHRoKCkpO1xuXG4gICAgICAgIGlmKCFjb29raWUpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgJGJhZGdlLmFkZENsYXNzKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICB6aWx2ZXJjbXMuc2V0Q29va2llKCd3aGF0c2FwcGJhZGdlJywgdHJ1ZSwgMSk7XG4gICAgICAgICAgICB9LCA2MDAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICRiYWRnZS5hZGRDbGFzcygnY2xvc2VkJyk7XG4gICAgICAgIH1cbiAgICB9KTtcbn0pO1xuIl19
